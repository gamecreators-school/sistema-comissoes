<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comiss√µes - Game Creators</title>
    <!-- 
    ‚ö†Ô∏è CONFIGURA√á√ÉO GOOGLE SHEETS OBRIGAT√ìRIA:
    1. Acesse: https://script.google.com/
    2. Crie um novo projeto
    3. Cole o c√≥digo do Google Apps Script (veja instru√ß√µes no final)
    4. Publique como Web App
    5. Substitua 'SEU_SCRIPT_ID_AQUI' pela URL do seu script
    6. O sistema funcionar√° offline como backup se n√£o configurar
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            overflow: hidden;
            margin: 0 auto;
            max-width: 100%;
            display: none;
        }

        .page-header {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #38a169, #68d391);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .user-level {
            font-size: 12px;
            opacity: 0.8;
        }

        .unit-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-top: 2px;
        }

        .sync-status {
            font-size: 9px;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .nav-tabs {
            background: #f8fafc;
            padding: 0;
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-size: 14px;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-button:hover {
            background: #e6fffa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #38a169;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(56,161,105,0.1), rgba(104,211,145,0.1));
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            font-size: 24px;
            color: #38a169;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .conversion-card {
            border-left-color: #ed8936;
        }

        .conversion-rate {
            font-size: 24px;
            font-weight: bold;
            color: #ed8936;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #68d391);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .team-overview {
            background: linear-gradient(135deg, #e6fffa, #f0fff4);
            border: 2px solid #38a169;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .team-member-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            margin: 0 auto 10px;
        }

        .member-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .member-role {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .member-stats {
            font-size: 11px;
            color: #38a169;
            font-weight: bold;
        }

        .unit-filter {
            background: #f8fafc;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .unit-selector {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .unit-selector.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .visits-section {
            background: linear-gradient(135deg, #fef5e7, #fed7c2);
            border: 2px solid #ed8936;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .success-message, .error-message, .warning-message, .info-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #38a169;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #e53e3e;
        }

        .warning-message {
            background: #fef5e7;
            color: #744210;
            border: 1px solid #ed8936;
        }

        .info-message {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #3182ce;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
            }
            
            .tab-button {
                min-width: 120px;
            }

            .user-info {
                flex-direction: column;
                gap: 5px;
            }

            .page-header {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>üéØ Game Creators</h1>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Sistema de Comiss√µes e Convers√£o</p>
            <div class="form-group">
                <label>üë§ Usu√°rio:</label>
                <input type="text" id="loginUsername" placeholder="Digite seu usu√°rio">
            </div>
            <div class="form-group">
                <label>üîí Senha:</label>
                <input type="password" id="loginPassword" placeholder="Digite sua senha">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 20px;">
                üöÄ Entrar
            </button>
            <div id="loginError" class="error-message hidden">
                Usu√°rio ou senha incorretos!
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="main-container">
        <!-- Header com Info do Usu√°rio -->
        <div class="page-header">
            <div>
                <h1 id="headerTitle">üéÆ Game Creators</h1>
                <p style="font-size: 12px; opacity: 0.8;">Sistema de Comiss√µes e Convers√£o</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h3 id="userName">Usu√°rio</h3>
                    <div class="user-level" id="userLevel">N√≠vel 1 - Iniciante</div>
                    <div class="unit-badge" id="userUnit">Shopping Conjunto Nacional</div>
                    <div class="sync-status" id="syncStatus">
                        <span id="syncIcon">üü¢</span>
                        <span id="syncText">Sincronizado</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
        </div>

        <!-- Filtro de Unidade (apenas para admins) -->
        <div id="unitFilter" class="unit-filter hidden">
            <strong>üè¢ Filtrar por Unidade:</strong>
            <div id="unitSelectors" style="margin-top: 10px;">
                <!-- Preenchido dinamicamente -->
            </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="nav-tabs" id="navTabs">
            <!-- Preenchido dinamicamente -->
        </div>

        <!-- Dashboard Principal -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid" id="dashboardGrid">
                <!-- Preenchido dinamicamente -->
            </div>
        </div>

        <!-- Visitas e Convers√£o -->
        <div id="visitas" class="tab-content">
            <div class="visits-section">
                <h3>üë• Controle de Visitas - <span id="visitsUnitName">Shopping Conjunto Nacional</span></h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="form-group">
                        <label>Data da Visita:</label>
                        <input type="date" id="visitDate" required>
                    </div>
                    <div class="form-group">
                        <label>Nome do Visitante:</label>
                        <input type="text" id="visitName" placeholder="Nome completo" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone:</label>
                        <input type="tel" id="visitPhone" placeholder="(11) 99999-9999" required>
                    </div>
                    <div class="form-group">
                        <label>Curso de Interesse:</label>
                        <select id="visitCourse" required>
                            <option value="">Selecione...</option>
                            <option value="Creators 2D">Creators 2D</option>
                            <option value="Creators 3D">Creators 3D</option>
                            <option value="Design Gr√°fico e Edi√ß√£o">Design Gr√°fico e Edi√ß√£o</option>
                            <option value="Creators Dev">Creators Dev</option>
                            <option value="Jogos Digitais T√©cnico">Jogos Digitais T√©cnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Atendido por:</label>
                        <select id="visitAttendant" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <input type="text" id="visitNotes" placeholder="Ex: Muito interessado, vai decidir em 3 dias...">
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addVisit()">‚ûï Registrar Visita</button>
                    <button class="btn btn-warning" onclick="convertVisitToMatricula()">üéØ Converter em Matr√≠cula</button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <div class="stat-card">
                    <h3>üìä Convers√£o do M√™s - <span id="conversionMonthYear">Dezembro 2024</span></h3>
                    <div id="conversionMetrics">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
                
                <div class="stat-card" style="margin-top: 20px;">
                    <h3>üìã √öltimas Visitas</h3>
                    <div id="recentVisits" style="max-height: 300px; overflow-y: auto;">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipe (apenas para gerentes) -->
        <div id="equipe" class="tab-content">
            <div class="team-overview">
                <h3>üë• Minha Equipe - <span id="teamUnitName">Shopping Conjunto Nacional</span></h3>
                <div class="team-grid" id="teamGrid">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
            
            <div style="padding: 20px;">
                <div class="stat-card">
                    <h3>üìä Performance da Equipe - <span id="teamMonthYear">Dezembro 2024</span></h3>
                    <div id="teamPerformance">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking -->
        <div id="ranking" class="tab-content">
            <table style="width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #2d3748, #1a202c); color: white;">
                        <th style="padding: 15px;">üèÜ Posi√ß√£o</th>
                        <th style="padding: 15px;">üë§ Nome</th>
                        <th style="padding: 15px;">üè¢ Unidade</th>
                        <th style="padding: 15px;">üíº Cargo</th>
                        <th style="padding: 15px;">üë• Visitas</th>
                        <th style="padding: 15px;">üìä Matr√≠culas</th>
                        <th style="padding: 15px;">üìà Convers√£o</th>
                        <th style="padding: 15px;">üí∞ Comiss√£o</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <!-- Preenchido dinamicamente -->
                </tbody>
            </table>
        </div>

        <!-- Painel Admin -->
        <div id="admin" class="tab-content">
            <div style="padding: 20px;">
                <h2>üë®‚Äçüíº Painel Administrativo</h2>
                
                <!-- Adicionar Usu√°rio -->
                <div class="stat-card" style="max-width: 500px; margin: 20px 0;">
                    <h3>‚ûï Adicionar Novo Usu√°rio</h3>
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="newUserName" placeholder="Nome completo">
                    </div>
                    <div class="form-group">
                        <label>Usu√°rio:</label>
                        <input type="text" id="newUserUsername" placeholder="nome.usuario@gamecreatorsadm.com">
                    </div>
                    <div class="form-group">
                        <label>Senha:</label>
                        <input type="password" id="newUserPassword" placeholder="senha123">
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="newUserRole">
                            <option value="vendedor">üë®‚Äçüíº Vendedor</option>
                            <option value="gerente">üëî Gerente</option>
                            <option value="assistente">üë©‚Äçüíª Assistente</option>
                            <option value="admin">üîß Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unidade:</label>
                        <select id="newUserUnit">
                            <option value="Shopping Conjunto Nacional">Shopping Conjunto Nacional</option>
                            <option value="JK Shopping">JK Shopping</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="addUser()">‚ûï Adicionar Usu√°rio</button>
                </div>

                <!-- Configura√ß√µes do Google Sheets -->
                <div class="stat-card" style="max-width: 600px; margin: 20px 0;">
                    <h3>‚òÅÔ∏è Configura√ß√£o Google Sheets</h3>
                    <div class="form-group">
                        <label>URL do Google Apps Script:</label>
                        <input type="url" id="googleScriptUrl" placeholder="https://script.google.com/macros/s/SEU_SCRIPT_ID_AQUI/exec">
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="testGoogleSheetsConnection()">üîç Testar Conex√£o</button>
                        <button class="btn btn-success" onclick="saveGoogleSheetsConfig()">üíæ Salvar Configura√ß√£o</button>
                        <button class="btn btn-warning" onclick="forceSync()">üîÑ Sincronizar Agora</button>
                    </div>
                    <div id="syncResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Lista de Usu√°rios -->
                <table style="width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #2d3748, #1a202c); color: white;">
                            <th style="padding: 15px;">üë§ Nome</th>
                            <th style="padding: 15px;">üîë Usu√°rio</th>
                            <th style="padding: 15px;">üè¢ Unidade</th>
                            <th style="padding: 15px;">üíº Tipo</th>
                            <th style="padding: 15px;">üìä Matr√≠culas</th>
                            <th style="padding: 15px;">üë• Visitas</th>
                            <th style="padding: 15px;">üîß A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="userManagementBody">
                        <!-- Preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Matr√≠culas -->
        <div id="matriculas" class="tab-content">
            <div style="padding: 20px;">
                <div class="stat-card">
                    <h3>‚ûï Adicionar Nova Matr√≠cula</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Data:</label>
                            <input type="date" id="newData" required>
                        </div>
                        <div class="form-group">
                            <label>Nome do Aluno:</label>
                            <input type="text" id="newNome" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone:</label>
                            <input type="tel" id="newTelefone" placeholder="(11) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label>Curso:</label>
                            <select id="newCurso" required>
                                <option value="">Selecione...</option>
                                <option value="Creators 2D">Creators 2D</option>
                                <option value="Creators 3D">Creators 3D</option>
                                <option value="Design Gr√°fico e Edi√ß√£o">Design Gr√°fico e Edi√ß√£o</option>
                                <option value="Creators Dev">Creators Dev</option>
                                <option value="Jogos Digitais T√©cnico">Jogos Digitais T√©cnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor Total do Curso (R$):</label>
                            <input type="number" id="newValorTotal" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Valor de Entrada (R$):</label>
                            <input type="number" id="newValorEntrada" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Venda:</label>
                            <select id="newTipo" required>
                                <option value="Convencional">Convencional (√Ä vista ou parcelado normal)</option>
                                <option value="Blackin">Blackin (6x no cart√£o)</option>
                                <option value="Black">Black (10x+ no cart√£o)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Parcelas (se aplic√°vel):</label>
                            <input type="number" id="newParcelas" min="1" max="24" placeholder="Ex: 6, 10, 12...">
                        </div>
                        <div class="form-group">
                            <label>Vendedor:</label>
                            <select id="newVendedor" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gerente:</label>
                            <select id="newGerente" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assistente:</label>
                            <select id="newAssistente" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Veio de uma visita?</label>
                            <select id="newFromVisit">
                                <option value="">N√£o, cliente direto</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addMatricula()" style="margin-top: 15px;">‚ûï Adicionar Matr√≠cula</button>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div id="relatorios" class="tab-content">
            <div style="padding: 20px;">
                <div class="stat-card">
                    <h3>üìä Relat√≥rios de Performance</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>M√™s/Ano:</label>
                            <input type="month" id="relatorioMes">
                        </div>
                        <div class="form-group">
                            <label>Unidade:</label>
                            <select id="relatorioUnidade">
                                <option value="">Todas</option>
                                <option value="Shopping Conjunto Nacional">Shopping Conjunto Nacional</option>
                                <option value="JK Shopping">JK Shopping</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Colaborador:</label>
                            <select id="relatorioColaborador">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="gerarRelatorioComissoes()">üí∞ Relat√≥rio Comiss√µes</button>
                        <button class="btn btn-success" onclick="gerarRelatorioConversao()">üìà Relat√≥rio Convers√£o</button>
                        <button class="btn btn-warning" onclick="gerarRelatorioUnidade()">üè¢ Relat√≥rio por Unidade</button>
                    </div>
                </div>

                <div id="relatorioResultado">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURE AQUI A URL DO SEU GOOGLE APPS SCRIPT
        let GOOGLE_APPS_SCRIPT_URL = localStorage.getItem('googleScriptUrl') || '';
        
        // Dados globais
        let currentUser = null;
        let selectedUnit = 'all';
        let users = {};
        let matriculas = [];
        let visitas = [];
        let userStats = {};
        let isOnline = navigator.onLine;

        // Usu√°rios padr√£o com as unidades espec√≠ficas
        const defaultUsers = {
            'admin@gamecreatorsadm.com': { 
                name: 'Administrador', 
                username: 'admin@gamecreatorsadm.com', 
                password: '15212602', 
                role: 'admin', 
                level: 10, 
                xp: 5000,
                unit: 'Todas'
            },
            'gerente.nacional@gamecreatorsadm.com': {
                name: 'Maria Silva',
                username: 'gerente.nacional@gamecreatorsadm.com',
                password: '123456',
                role: 'gerente',
                level: 5,
                xp: 2500,
                unit: 'Shopping Conjunto Nacional'
            },
            'vendedor1.nacional@gamecreatorsadm.com': {
                name: 'Jo√£o Santos',
                username: 'vendedor1.nacional@gamecreatorsadm.com',
                password: '123456',
                role: 'vendedor',
                level: 3,
                xp: 1200,
                unit: 'Shopping Conjunto Nacional'
            },
            'assistente1.nacional@gamecreatorsadm.com': {
                name: 'Ana Costa',
                username: 'assistente1.nacional@gamecreatorsadm.com',
                password: '123456',
                role: 'assistente',
                level: 2,
                xp: 800,
                unit: 'Shopping Conjunto Nacional'
            },
            'gerente.jk@gamecreatorsadm.com': {
                name: 'Carlos Lima',
                username: 'gerente.jk@gamecreatorsadm.com',
                password: '123456',
                role: 'gerente',
                level: 4,
                xp: 2000,
                unit: 'JK Shopping'
            },
            'vendedor1.jk@gamecreatorsadm.com': {
                name: 'Paula Oliveira',
                username: 'vendedor1.jk@gamecreatorsadm.com',
                password: '123456',
                role: 'vendedor',
                level: 3,
                xp: 1100,
                unit: 'JK Shopping'
            }
        };

        // Tabelas de comiss√µes
        const COMISSAO_VENDEDOR = [
            { min: 10, max: 20, valor: 35 },
            { min: 21, max: 30, valor: 50 },
            { min: 31, max: 40, valor: 60 },
            { min: 41, max: 999, valor: 70 }
        ];

        const COMISSAO_GERENTE = [
            { min: 26, max: 52, valor: 50 },
            { min: 53, max: 78, valor: 80 }
        ];

        const COMISSAO_ASSISTENTE = [
            { min: 10, max: 20, valor: 10 },
            { min: 21, max: 30, valor: 15 },
            { min: 31, max: 40, valor: 25 },
            { min: 41, max: 999, valor: 30 }
        ];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            showLoadingMessage('Carregando dados...');
            loadFromGoogleSheets().then(() => {
                hideLoadingMessage();
                updateSyncStatus('online');
            }).catch(() => {
                loadDataFromLocal();
                hideLoadingMessage();
                updateSyncStatus('offline');
                showMessage('Modo offline: dados carregados do backup local', 'warning');
            });
            
            setCurrentDate();
            setCurrentMonthForReport();
            setupNetworkMonitoring();
        });

        // Google Sheets Integration - Vers√£o SEM CORS
        function saveToGoogleSheets() {
            if (!GOOGLE_APPS_SCRIPT_URL || !isOnline) {
                saveDataToLocal();
                updateSyncStatus('offline');
                return;
            }

            showLoadingMessage('Sincronizando com Google Sheets...');
            updateSyncStatus('syncing');
            
            // Usar form submission para evitar CORS
            const data = {
                action: 'save',
                users: users,
                matriculas: matriculas,
                visitas: visitas,
                userStats: userStats,
                timestamp: new Date().toISOString()
            };

            submitToGoogleSheets(data, (success, result) => {
                if (success) {
                    saveDataToLocal();
                    updateSyncStatus('online');
                    showMessage('‚úÖ Dados sincronizados com Google Sheets!', 'success');
                } else {
                    saveDataToLocal();
                    updateSyncStatus('error');
                    showMessage('‚ö†Ô∏è Erro na sincroniza√ß√£o: ' + (result || 'Erro desconhecido'), 'warning');
                }
                hideLoadingMessage();
            });
        }

        function loadFromGoogleSheets() {
            return new Promise((resolve, reject) => {
                if (!GOOGLE_APPS_SCRIPT_URL || !isOnline) {
                    reject(new Error('Google Sheets n√£o configurado ou offline'));
                    return;
                }

                const data = { action: 'load' };
                
                submitToGoogleSheets(data, (success, result) => {
                    if (success && result) {
                        try {
                            users = result.users || {};
                            matriculas = result.matriculas || [];
                            visitas = result.visitas || [];
                            userStats = result.userStats || {};

                            // Se n√£o houver usu√°rios, criar os padr√£o
                            if (Object.keys(users).length === 0) {
                                users = {...defaultUsers};
                            }

                            // Garantir que todos os usu√°rios tenham stats
                            Object.keys(users).forEach(username => {
                                if (!userStats[username]) {
                                    userStats[username] = {
                                        achievements: [],
                                        totalSales: 0,
                                        totalEarnings: 0,
                                        totalVisits: 0,
                                        conversionRate: 0
                                    };
                                }
                            });

                            saveDataToLocal();
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    } else {
                        reject(new Error(result || 'Erro ao carregar dados'));
                    }
                });
            });
        }

        // Fun√ß√£o que usa form submission via iframe para evitar CORS
        function submitToGoogleSheets(data, callback) {
            const callbackName = 'gsCallback_' + Date.now();
            const timeoutId = setTimeout(() => {
                cleanup();
                callback(false, 'Timeout na conex√£o');
            }, 30000);

            function cleanup() {
                clearTimeout(timeoutId);
                delete window[callbackName];
                const iframe = document.getElementById('gs-iframe');
                if (iframe) {
                    iframe.remove();
                }
                const script = document.getElementById('gs-script');
                if (script) {
                    script.remove();
                }
            }

            window[callbackName] = function(result) {
                cleanup();
                if (result && result.success) {
                    callback(true, result);
                } else {
                    callback(false, result ? result.error : 'Erro desconhecido');
                }
            };

            // Criar iframe oculto para fazer a requisi√ß√£o
            const iframe = document.createElement('iframe');
            iframe.id = 'gs-iframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const form = iframe.contentDocument || iframe.contentWindow.document;
            form.open();
            form.write(`
                <html>
                <body>
                <form id="gsForm" action="${GOOGLE_APPS_SCRIPT_URL}" method="post" target="gsTarget">
                    <input type="hidden" name="data" value='${JSON.stringify(data)}'>
                    <input type="hidden" name="callback" value="${callbackName}">
                </form>
                <iframe name="gsTarget" style="display:none;"></iframe>
                <script>
                    document.getElementById('gsForm').submit();
                    setTimeout(() => {
                        try {
                            const result = parent.window.frames['gsTarget'].document.body.innerHTML;
                            if (result) {
                                const jsonResult = JSON.parse(result);
                                parent.window['${callbackName}'](jsonResult);
                            } else {
                                parent.window['${callbackName}'](false);
                            }
                        } catch (e) {
                            // Fallback: usar JSONP
                            const script = parent.document.createElement('script');
                            script.id = 'gs-script';
                            script.src = '${GOOGLE_APPS_SCRIPT_URL}?callback=${callbackName}&data=' + encodeURIComponent('${JSON.stringify(data)}');
                            script.onerror = () => parent.window['${callbackName}'](false);
                            parent.document.head.appendChild(script);
                        }
                    }, 2000);
                </script>
                </body>
                </html>
            `);
            form.close();
        }

        // Gerenciamento de dados local
        function saveDataToLocal() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('matriculas', JSON.stringify(matriculas));
            localStorage.setItem('visitas', JSON.stringify(visitas));
            localStorage.setItem('userStats', JSON.stringify(userStats));
            localStorage.setItem('lastLocalSave', new Date().toISOString());
        }

        function loadDataFromLocal() {
            const savedUsers = localStorage.getItem('users');
            const savedMatriculas = localStorage.getItem('matriculas');
            const savedVisitas = localStorage.getItem('visitas');
            const savedUserStats = localStorage.getItem('userStats');

            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                users = {...defaultUsers};
            }

            if (savedMatriculas) {
                matriculas = JSON.parse(savedMatriculas);
            } else {
                matriculas = generateSampleData();
            }

            if (savedVisitas) {
                visitas = JSON.parse(savedVisitas);
            } else {
                visitas = generateSampleVisits();
            }

            if (savedUserStats) {
                userStats = JSON.parse(savedUserStats);
            }

            // Garantir que todos os usu√°rios tenham stats
            Object.keys(users).forEach(username => {
                if (!userStats[username]) {
                    userStats[username] = {
                        achievements: [],
                        totalSales: 0,
                        totalEarnings: 0,
                        totalVisits: 0,
                        conversionRate: 0
                    };
                }
            });
        }

        function generateSampleData() {
            const sampleData = [];
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Gerar matr√≠culas de exemplo
            for (let i = 0; i < 25; i++) {
                const randomDay = Math.floor(Math.random() * 28) + 1;
                const date = new Date(currentYear, currentMonth, randomDay);
                const unit = i % 2 === 0 ? 'Shopping Conjunto Nacional' : 'JK Shopping';
                
                sampleData.push({
                    id: Date.now() + i,
                    data: date.toISOString().split('T')[0],
                    nome: `Aluno ${i + 1}`,
                    telefone: `(11) 9999-${String(i).padStart(4, '0')}`,
                    curso: ['Creators 2D', 'Creators 3D', 'Design Gr√°fico'][Math.floor(Math.random() * 3)],
                    valorTotal: 2400,
                    valorEntrada: Math.floor(Math.random() * 500) + 200,
                    tipo: ['Convencional', 'Blackin', 'Black'][Math.floor(Math.random() * 3)],
                    parcelas: Math.floor(Math.random() * 12) + 1,
                    vendedor: unit === 'Shopping Conjunto Nacional' ? 'Jo√£o Santos' : 'Paula Oliveira',
                    gerente: unit === 'Shopping Conjunto Nacional' ? 'Maria Silva' : 'Carlos Lima',
                    assistente: unit === 'Shopping Conjunto Nacional' ? 'Ana Costa' : 'Paula Oliveira',
                    unidade: unit,
                    statusPagamento: 'Pago',
                    cancelado: false,
                    fromVisit: Math.random() > 0.7 // 30% vieram de visitas
                });
            }

            return sampleData;
        }

        function generateSampleVisits() {
            const sampleVisits = [];
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Gerar visitas de exemplo
            for (let i = 0; i < 40; i++) {
                const randomDay = Math.floor(Math.random() * 28) + 1;
                const date = new Date(currentYear, currentMonth, randomDay);
                const unit = i % 2 === 0 ? 'Shopping Conjunto Nacional' : 'JK Shopping';
                const converted = Math.random() > 0.7; // 30% de convers√£o
                
                sampleVisits.push({
                    id: Date.now() + i,
                    data: date.toISOString().split('T')[0],
                    nome: `Visitante ${i + 1}`,
                    telefone: `(11) 8888-${String(i).padStart(4, '0')}`,
                    cursoInteresse: ['Creators 2D', 'Creators 3D', 'Design Gr√°fico'][Math.floor(Math.random() * 3)],
                    atendente: unit === 'Shopping Conjunto Nacional' ? 'Jo√£o Santos' : 'Paula Oliveira',
                    unidade: unit,
                    observacoes: 'Visitante interessado',
                    convertido: converted,
                    matriculaId: converted ? Date.now() + i + 1000 : null,
                    dataConversao: converted ? date.toISOString().split('T')[0] : null
                });
            }

            return sampleVisits;
        }

        // Monitor de conex√£o e sincroniza√ß√£o
        function setupNetworkMonitoring() {
            window.addEventListener('online', function() {
                isOnline = true;
                updateSyncStatus('online');
                showMessage('‚úÖ Conectado! Sincronizando dados...', 'info');
                saveToGoogleSheets();
            });

            window.addEventListener('offline', function() {
                isOnline = false;
                updateSyncStatus('offline');
                showMessage('‚ö†Ô∏è Offline. Dados ser√£o salvos localmente.', 'warning');
            });
        }

        function updateSyncStatus(status) {
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            
            if (!syncIcon || !syncText) return;
            
            switch(status) {
                case 'online':
                    syncIcon.textContent = 'üü¢';
                    syncText.textContent = 'Sincronizado';
                    break;
                case 'offline':
                    syncIcon.textContent = 'üî¥';
                    syncText.textContent = 'Offline';
                    break;
                case 'syncing':
                    syncIcon.textContent = 'üü°';
                    syncText.textContent = 'Sincronizando...';
                    break;
                case 'error':
                    syncIcon.textContent = '‚ö†Ô∏è';
                    syncText.textContent = 'Erro de sync';
                    break;
            }
        }

        // Configura√ß√£o Google Sheets
        function saveGoogleSheetsConfig() {
            const url = document.getElementById('googleScriptUrl').value;
            if (!url) {
                showMessage('Digite a URL do Google Apps Script!', 'error');
                return;
            }
            
            GOOGLE_APPS_SCRIPT_URL = url;
            localStorage.setItem('googleScriptUrl', url);
            showMessage('Configura√ß√£o salva! Teste a conex√£o.', 'success');
        }

        async function testGoogleSheetsConnection() {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                showMessage('Configure a URL primeiro!', 'error');
                return;
            }

            showLoadingMessage('Testando conex√£o...');
            
            const data = { action: 'test' };
            
            submitToGoogleSheets(data, (success, result) => {
                hideLoadingMessage();
                
                if (success) {
                    showMessage('‚úÖ Conex√£o com Google Sheets OK!', 'success');
                    document.getElementById('syncResult').innerHTML = '<div style="color: #38a169; font-weight: bold;">‚úÖ Conectado com sucesso!</div>';
                } else {
                    showMessage('‚ùå Erro na conex√£o: ' + (result || 'Erro desconhecido'), 'error');
                    document.getElementById('syncResult').innerHTML = '<div style="color: #e53e3e; font-weight: bold;">‚ùå Erro: ' + (result || 'Erro desconhecido') + '</div>';
                }
            });
        }

        async function forceSync() {
            showMessage('Iniciando sincroniza√ß√£o for√ßada...', 'info');
            await saveToGoogleSheets();
        }

        // Salvar dados (fun√ß√£o principal)
        function saveData() {
            saveToGoogleSheets();
        }

        // Sistema de Login
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                setupUserInterface();
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            selectedUnit = 'all';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Interface do usu√°rio
        function setupUserInterface() {
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userLevel').textContent = `N√≠vel ${currentUser.level} - ${getLevelTitle(currentUser.level)}`;
            document.getElementById('userUnit').textContent = currentUser.unit || 'Shopping Conjunto Nacional';

            if (currentUser.role === 'admin') {
                document.getElementById('unitFilter').classList.remove('hidden');
                setupUnitFilter();
            }

            setupNavigation();
            setupDashboard();
            updateUserSelects();
            updateVisitSelects();
        }

        function getLevelTitle(level) {
            if (level >= 10) return 'Lenda';
            if (level >= 8) return 'Mestre';
            if (level >= 6) return 'Especialista';
            if (level >= 4) return 'Experiente';
            if (level >= 2) return 'Aprendiz';
            return 'Iniciante';
        }

        function setupNavigation() {
            const navTabs = document.getElementById('navTabs');
            let tabs = '';

            tabs += '<button class="tab-button active" onclick="showTab(\'dashboard\')">üè† Dashboard</button>';
            
            if (['admin', 'gerente', 'vendedor', 'assistente'].includes(currentUser.role)) {
                tabs += '<button class="tab-button" onclick="showTab(\'visitas\')">üë• Visitas & Convers√£o</button>';
            }
            
            if (currentUser.role === 'gerente') {
                tabs += '<button class="tab-button" onclick="showTab(\'equipe\')">üë• Minha Equipe</button>';
            }
            
            tabs += '<button class="tab-button" onclick="showTab(\'ranking\')">üìä Ranking</button>';

            if (currentUser.role === 'admin') {
                tabs += '<button class="tab-button" onclick="showTab(\'admin\')">üë®‚Äçüíº Admin</button>';
            }

            if (['admin', 'gerente', 'vendedor'].includes(currentUser.role)) {
                tabs += '<button class="tab-button" onclick="showTab(\'matriculas\')">‚ûï Matr√≠culas</button>';
                tabs += '<button class="tab-button" onclick="showTab(\'relatorios\')">üìä Relat√≥rios</button>';
            }

            navTabs.innerHTML = tabs;
        }

        function setupUnitFilter() {
            const unitSelectors = document.getElementById('unitSelectors');
            const units = ['all', 'Shopping Conjunto Nacional', 'JK Shopping'];
            
            let html = '';
            units.forEach(unit => {
                const label = unit === 'all' ? 'Todas' : unit;
                const activeClass = selectedUnit === unit ? 'active' : '';
                html += `<span class="unit-selector ${activeClass}" onclick="selectUnit('${unit}')">${label}</span>`;
            });
            
            unitSelectors.innerHTML = html;
        }

        function selectUnit(unit) {
            selectedUnit = unit;
            setupUnitFilter();
            setupDashboard();
            updateRanking();
        }

        function setupDashboard() {
            const dashboardGrid = document.getElementById('dashboardGrid');
            let dashboardHTML = '';

            if (currentUser.role === 'gerente') {
                dashboardHTML += generateManagerDashboard();
            } else if (currentUser.role === 'admin') {
                dashboardHTML += generateAdminDashboard();
            } else {
                dashboardHTML += generateUserDashboard();
            }

            dashboardGrid.innerHTML = dashboardHTML;
            updateRanking();
        }

        function generateManagerDashboard() {
            const unitData = getUnitData(currentUser.unit);
            const unitVisits = getUnitVisits(currentUser.unit);
            const monthData = getCurrentMonthData(unitData);
            const monthVisits = getCurrentMonthData(unitVisits, 'data');
            
            const conversionRate = monthVisits.length > 0 ? (monthData.length / monthVisits.length * 100).toFixed(1) : 0;
            const totalUnitCommission = calculateManagerUnitCommission();

            let html = `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üè¢</span>
                        <span style="font-size: 12px; color: #666;">${currentUser.unit}</span>
                    </div>
                    <div class="stat-value">${monthData.length}</div>
                    <div class="stat-label">Matr√≠culas da Unidade</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üë•</span>
                    </div>
                    <div class="stat-value">${monthVisits.length}</div>
                    <div class="stat-label">Visitas do M√™s</div>
                </div>

                <div class="stat-card conversion-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìà</span>
                    </div>
                    <div class="conversion-rate">${conversionRate}%</div>
                    <div class="stat-label">Taxa de Convers√£o</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(conversionRate, 100)}%; background: linear-gradient(90deg, #ed8936, #ff9500);"></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üí∞</span>
                    </div>
                    <div class="stat-value">${formatCurrency(totalUnitCommission)}</div>
                    <div class="stat-label">Comiss√£o Total</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Comiss√£o por todas as vendas da unidade
                    </div>
                </div>
            `;

            return html;
        }

        function generateAdminDashboard() {
            const allData = selectedUnit === 'all' ? matriculas : getUnitData(selectedUnit);
            const allVisits = selectedUnit === 'all' ? visitas : getUnitVisits(selectedUnit);
            const monthData = getCurrentMonthData(allData);
            const monthVisits = getCurrentMonthData(allVisits, 'data');
            
            const conversionRate = monthVisits.length > 0 ? (monthData.length / monthVisits.length * 100).toFixed(1) : 0;
            const totalRevenue = calculateTotalRevenue(monthData);
            const totalCollaborators = Object.values(users).filter(u => u.role !== 'admin').length;

            let html = `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìä</span>
                        <span style="font-size: 12px; color: #666;">${selectedUnit === 'all' ? 'Todas' : selectedUnit}</span>
                    </div>
                    <div class="stat-value">${monthData.length}</div>
                    <div class="stat-label">Matr√≠culas do M√™s</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üë•</span>
                    </div>
                    <div class="stat-value">${monthVisits.length}</div>
                    <div class="stat-label">Visitas do M√™s</div>
                </div>

                <div class="stat-card conversion-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìà</span>
                    </div>
                    <div class="conversion-rate">${conversionRate}%</div>
                    <div class="stat-label">Convers√£o Geral</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üí∞</span>
                    </div>
                    <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                    <div class="stat-label">Faturamento</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üè¢</span>
                    </div>
                    <div class="stat-value">2</div>
                    <div class="stat-label">Unidades Ativas</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üë®‚Äçüíº</span>
                    </div>
                    <div class="stat-value">${totalCollaborators}</div>
                    <div class="stat-label">Colaboradores</div>
                </div>
            `;

            return html;
        }

        function generateUserDashboard() {
            const userMatriculas = getUserMatriculas();
            const userVisits = getUserVisits();
            const monthData = getCurrentMonthData(userMatriculas);
            const monthVisits = getCurrentMonthData(userVisits, 'data');
            const todayData = getTodayData(userMatriculas);
            
            const conversionRate = monthVisits.length > 0 ? (monthData.length / monthVisits.length * 100).toFixed(1) : 0;
            const monthTarget = currentUser.role === 'vendedor' ? 30 : 25;
            const monthProgress = Math.min((monthData.length / monthTarget) * 100, 100);
            const monthCommission = calculateUserMonthCommission();

            let html = `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìä</span>
                    </div>
                    <div class="stat-value">${monthData.length}</div>
                    <div class="stat-label">Minhas Matr√≠culas</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${monthProgress}%"></div>
                    </div>
                    <div class="progress-text">${monthData.length} de ${monthTarget}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üë•</span>
                    </div>
                    <div class="stat-value">${monthVisits.length}</div>
                    <div class="stat-label">Visitas Atendidas</div>
                </div>

                <div class="stat-card conversion-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìà</span>
                    </div>
                    <div class="conversion-rate">${conversionRate}%</div>
                    <div class="stat-label">Minha Convers√£o</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üéØ</span>
                    </div>
                    <div class="stat-value">${todayData.length}</div>
                    <div class="stat-label">Vendas Hoje</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üí∞</span>
                    </div>
                    <div class="stat-value">${formatCurrency(monthCommission)}</div>
                    <div class="stat-label">Comiss√£o do M√™s</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚≠ê</span>
                        <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">N√≠vel ${currentUser.level}</span>
                    </div>
                    <div class="stat-value">${currentUser.xp}</div>
                    <div class="stat-label">Pontos XP</div>
                </div>
            `;

            return html;
        }

        // Fun√ß√µes auxiliares para visitas
        function getUnitVisits(unit) {
            if (!unit || unit === 'all') return visitas;
            return visitas.filter(v => v.unidade === unit);
        }

        function getUserVisits() {
            return visitas.filter(v => {
                if (currentUser.role === 'admin') {
                    return selectedUnit === 'all' ? true : v.unidade === selectedUnit;
                }
                if (currentUser.role === 'gerente') {
                    return v.unidade === currentUser.unit;
                }
                return v.atendente === currentUser.name;
            });
        }

        // Sistema de Visitas
        function addVisit() {
            const data = document.getElementById('visitDate').value;
            const nome = document.getElementById('visitName').value;
            const telefone = document.getElementById('visitPhone').value;
            const cursoInteresse = document.getElementById('visitCourse').value;
            const atendente = document.getElementById('visitAttendant').value;
            const observacoes = document.getElementById('visitNotes').value;

            if (!data || !nome || !telefone || !cursoInteresse || !atendente) {
                showMessage('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Determinar unidade baseada no atendente
            const atendenteUser = Object.values(users).find(u => u.name === atendente);
            const unidade = atendenteUser ? atendenteUser.unit : currentUser.unit;

            const novaVisita = {
                id: Date.now(),
                data,
                nome,
                telefone,
                cursoInteresse,
                atendente,
                unidade,
                observacoes,
                convertido: false,
                matriculaId: null,
                dataConversao: null,
                criadoPor: currentUser.name,
                dataLancamento: new Date().toISOString()
            };

            visitas.push(novaVisita);
            giveXP(atendente, 10); // XP por atender visita
            
            saveData();
            updateVisitsDisplay();
            updateVisitSelects();
            showMessage('Visita registrada com sucesso!', 'success');
            clearVisitForm();
        }

        function clearVisitForm() {
            document.getElementById('visitDate').value = '';
            document.getElementById('visitName').value = '';
            document.getElementById('visitPhone').value = '';
            document.getElementById('visitCourse').value = '';
            document.getElementById('visitNotes').value = '';
            
            if (currentUser.role === 'admin') {
                document.getElementById('visitAttendant').value = '';
            }
        }

        function convertVisitToMatricula() {
            // Redirecionar para aba de matr√≠culas com dados pr√©-preenchidos
            showTab('matriculas');
            showMessage('Preencha os dados da matr√≠cula. Use o campo "Veio de uma visita?" para vincular.', 'info');
        }

        function updateVisitsDisplay() {
            updateConversionMetrics();
            updateRecentVisits();
        }

        function updateConversionMetrics() {
            const conversionMetrics = document.getElementById('conversionMetrics');
            if (!conversionMetrics) return;

            const userVisits = getUserVisits();
            const monthVisits = getCurrentMonthData(userVisits, 'data');
            const convertedVisits = monthVisits.filter(v => v.convertido);
            
            const conversionRate = monthVisits.length > 0 ? (convertedVisits.length / monthVisits.length * 100).toFixed(1) : 0;
            
            conversionMetrics.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2d3748;">${monthVisits.length}</div>
                        <div style="font-size: 12px; color: #666;">Total de Visitas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #38a169;">${convertedVisits.length}</div>
                        <div style="font-size: 12px; color: #666;">Convertidas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ed8936;">${conversionRate}%</div>
                        <div style="font-size: 12px; color: #666;">Taxa de Convers√£o</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${monthVisits.length - convertedVisits.length}</div>
                        <div style="font-size: 12px; color: #666;">Pendentes</div>
                    </div>
                </div>
            `;
        }

        function updateRecentVisits() {
            const recentVisits = document.getElementById('recentVisits');
            if (!recentVisits) return;

            const userVisits = getUserVisits();
            const sortedVisits = userVisits.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 10);
            
            let html = '';
            if (sortedVisits.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma visita registrada ainda.</p>';
            } else {
                sortedVisits.forEach(visita => {
                    html += `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; ${visita.convertido ? 'background: #f0fff4; border-color: #38a169;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong>${visita.nome}</strong>
                                <span style="color: ${visita.convertido ? '#38a169' : '#ed8936'}; font-weight: bold;">
                                    ${visita.convertido ? '‚úÖ Convertido' : '‚è≥ Pendente'}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${formatDate(visita.data)} ‚Ä¢ ${visita.cursoInteresse} ‚Ä¢ ${visita.atendente}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                üìû ${visita.telefone}
                            </div>
                            ${visita.observacoes ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${visita.observacoes}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            recentVisits.innerHTML = html;
        }

        function updateVisitSelects() {
            const visitAttendantSelect = document.getElementById('visitAttendant');
            const fromVisitSelect = document.getElementById('newFromVisit');
            
            if (visitAttendantSelect) {
                visitAttendantSelect.innerHTML = '<option value="">Selecione...</option>';
                
                Object.entries(users).forEach(([username, user]) => {
                    if (user.role !== 'admin') {
                        if (currentUser.role === 'gerente' && user.unit !== currentUser.unit) return;
                        
                        visitAttendantSelect.innerHTML += `<option value="${user.name}">${user.name} (${user.role})</option>`;
                    }
                });

                // Auto-selecionar usu√°rio atual se n√£o for admin
                if (currentUser.role !== 'admin') {
                    visitAttendantSelect.value = currentUser.name;
                    visitAttendantSelect.disabled = true;
                }
            }
            
            if (fromVisitSelect) {
                fromVisitSelect.innerHTML = '<option value="">N√£o, cliente direto</option>';
                
                // Mostrar apenas visitas n√£o convertidas
                const pendingVisits = visitas.filter(v => !v.convertido);
                pendingVisits.forEach(visita => {
                    fromVisitSelect.innerHTML += `<option value="${visita.id}">${visita.nome} - ${formatDate(visita.data)}</option>`;
                });
            }
        }

        // Continua o resto das fun√ß√µes...
        // (As demais fun√ß√µes permanecem praticamente iguais, apenas com adapta√ß√µes para incluir as visitas)

        function getUserMatriculas() {
            if (currentUser.role === 'admin') {
                return selectedUnit === 'all' ? matriculas : getUnitData(selectedUnit);
            }
            if (currentUser.role === 'gerente') {
                return getUnitData(currentUser.unit);
            }
            return matriculas.filter(m => 
                m.vendedor === currentUser.name || 
                m.gerente === currentUser.name || 
                m.assistente === currentUser.name
            );
        }

        function getUnitData(unit) {
            if (!unit || unit === 'all') return matriculas;
            return matriculas.filter(m => m.unidade === unit);
        }

        function getCurrentMonthData(data, dateField = 'data') {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return data.filter(item => {
                const date = new Date(item[dateField]);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear && 
                       !item.cancelado;
            });
        }

        function getTodayData(data) {
            const today = new Date().toISOString().split('T')[0];
            return data.filter(m => m.data === today && !m.cancelado);
        }

        function calculateUserMonthCommission() {
            if (currentUser.role === 'gerente') {
                return calculateManagerUnitCommission();
            }
            
            const monthData = getCurrentMonthData(getUserMatriculas());
            const myMatriculas = monthData.filter(m => {
                if (currentUser.role === 'vendedor') return m.vendedor === currentUser.name;
                if (currentUser.role === 'assistente') return m.assistente === currentUser.name;
                return false;
            });
            
            const count = myMatriculas.length;
            let commission = 0;
            
            if (currentUser.role === 'vendedor' && count >= 10) {
                commission = count * getCommissionByBand(count, COMISSAO_VENDEDOR);
            } else if (currentUser.role === 'assistente' && count >= 10) {
                commission = count * getCommissionByBand(count, COMISSAO_ASSISTENTE);
            }
            
            return commission;
        }

        function calculateManagerUnitCommission() {
            const unitData = getUnitData(currentUser.unit);
            const monthData = getCurrentMonthData(unitData);
            
            const totalMatriculas = monthData.length;
            let commission = 0;
            
            if (totalMatriculas >= 26) {
                commission = totalMatriculas * getCommissionByBand(totalMatriculas, COMISSAO_GERENTE);
            }
            
            const specialBonus = monthData.reduce((total, m) => {
                if (m.tipo === 'Blackin') total += 25;
                if (m.tipo === 'Black') total += 50;
                return total;
            }, 0);
            
            return commission + specialBonus;
        }

        function calculateTotalRevenue(data) {
            return data.reduce((total, m) => total + (m.valorEntrada || 0), 0);
        }

        function getCommissionByBand(matriculasCount, table) {
            for (let band of table) {
                if (matriculasCount >= band.min && matriculasCount <= band.max) {
                    return band.valor;
                }
            }
            return 0;
        }

        // Sistema de Ranking
        function updateRanking() {
            const rankingBody = document.getElementById('rankingBody');
            const rankings = calculateRankings();
            let html = '';

            rankings.forEach((user, index) => {
                const position = index + 1;
                const rankClass = position === 1 ? 'rank-1' : 
                                position === 2 ? 'rank-2' : 
                                position === 3 ? 'rank-3' : 'rank-other';

                html += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;" class="${rankClass}">${position}</div>
                        </td>
                        <td style="padding: 15px;">${user.name}</td>
                        <td style="padding: 15px;">${user.unit}</td>
                        <td style="padding: 15px;"><span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;" class="role-badge role-${user.role}">${user.role}</span></td>
                        <td style="padding: 15px; text-align: center;">${user.visitas}</td>
                        <td style="padding: 15px; text-align: center;">${user.matriculas}</td>
                        <td style="padding: 15px; text-align: center; color: #ed8936; font-weight: bold;">${user.conversao}%</td>
                        <td style="padding: 15px; text-align: right;">${formatCurrency(user.earnings)}</td>
                    </tr>
                `;
            });

            rankingBody.innerHTML = html;
        }

        function calculateRankings() {
            const rankings = [];
            
            Object.entries(users).forEach(([username, user]) => {
                if (user.role !== 'admin') {
                    const userMatriculas = matriculas.filter(m => 
                        m.vendedor === user.name || 
                        m.gerente === user.name || 
                        m.assistente === user.name
                    );
                    const userVisits = visitas.filter(v => v.atendente === user.name);
                    
                    const monthMatriculas = getCurrentMonthData(userMatriculas);
                    const monthVisits = getCurrentMonthData(userVisits, 'data');
                    const conversionRate = monthVisits.length > 0 ? (monthMatriculas.length / monthVisits.length * 100).toFixed(1) : 0;
                    
                    const earnings = user.role === 'gerente' ? calculateManagerUnitCommission() : monthMatriculas.length * 50;

                    rankings.push({
                        name: user.name,
                        unit: user.unit,
                        role: user.role,
                        visitas: monthVisits.length,
                        matriculas: monthMatriculas.length,
                        conversao: conversionRate,
                        earnings: earnings
                    });
                }
            });

            return rankings.sort((a, b) => b.earnings - a.earnings);
        }

        function updateUserSelects() {
            const vendedorSelect = document.getElementById('newVendedor');
            const gerenteSelect = document.getElementById('newGerente');
            const assistenteSelect = document.getElementById('newAssistente');
            const relatorioColaboradorSelect = document.getElementById('relatorioColaborador');

            if (vendedorSelect) {
                vendedorSelect.innerHTML = '<option value="">Selecione...</option>';
                gerenteSelect.innerHTML = '<option value="">Selecione...</option>';
                assistenteSelect.innerHTML = '<option value="">Selecione...</option>';

                Object.entries(users).forEach(([username, user]) => {
                    if (currentUser.role === 'gerente' && user.unit !== currentUser.unit) return;
                    
                    if (user.role === 'vendedor') {
                        vendedorSelect.innerHTML += `<option value="${user.name}">${user.name} (${user.unit})</option>`;
                    }
                    if (user.role === 'gerente') {
                        gerenteSelect.innerHTML += `<option value="${user.name}">${user.name} (${user.unit})</option>`;
                    }
                    if (user.role === 'assistente') {
                        assistenteSelect.innerHTML += `<option value="${user.name}">${user.name} (${user.unit})</option>`;
                    }
                });

                if (currentUser.role === 'vendedor') {
                    vendedorSelect.value = currentUser.name;
                    vendedorSelect.disabled = true;
                } else if (currentUser.role === 'gerente') {
                    gerenteSelect.value = currentUser.name;
                    gerenteSelect.disabled = true;
                }
            }

            if (relatorioColaboradorSelect) {
                relatorioColaboradorSelect.innerHTML = '<option value="">Todos</option>';
                Object.entries(users).forEach(([username, user]) => {
                    if (user.role !== 'admin') {
                        if (currentUser.role === 'gerente' && user.unit !== currentUser.unit) return;
                        
                        relatorioColaboradorSelect.innerHTML += `<option value="${user.name}">${user.name} (${user.role} - ${user.unit})</option>`;
                    }
                });
            }
        }

        // Adicionar Usu√°rio
        function addUser() {
            const name = document.getElementById('newUserName').value;
            const username = document.getElementById('newUserUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const unit = document.getElementById('newUserUnit').value;

            if (!name || !username || !password) {
                showMessage('Preencha todos os campos!', 'error');
                return;
            }

            if (users[username]) {
                showMessage('Usu√°rio j√° existe!', 'error');
                return;
            }

            users[username] = {
                name,
                username,
                password,
                role,
                unit,
                level: 1,
                xp: 0
            };

            userStats[username] = {
                achievements: [],
                totalSales: 0,
                totalEarnings: 0,
                totalVisits: 0,
                conversionRate: 0
            };

            saveData();
            updateAdminPanel();
            updateUserSelects();
            showMessage('Usu√°rio adicionado com sucesso!', 'success');

            document.getElementById('newUserName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
        }

        function updateAdminPanel() {
            const userManagementBody = document.getElementById('userManagementBody');
            let html = '';

            Object.entries(users).forEach(([username, user]) => {
                if (user.role === 'admin') return;
                
                const userMatriculas = matriculas.filter(m => 
                    m.vendedor === user.name || 
                    m.gerente === user.name || 
                    m.assistente === user.name
                );
                const userVisits = visitas.filter(v => v.atendente === user.name);
                const monthMatriculas = getCurrentMonthData(userMatriculas);
                const monthVisits = getCurrentMonthData(userVisits, 'data');

                html += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 15px;">${user.name}</td>
                        <td style="padding: 15px;">${user.username}</td>
                        <td style="padding: 15px;">${user.unit}</td>
                        <td style="padding: 15px;"><span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;" class="role-badge role-${user.role}">${user.role}</span></td>
                        <td style="padding: 15px; text-align: center;">${monthMatriculas.length}</td>
                        <td style="padding: 15px; text-align: center;">${monthVisits.length}</td>
                        <td style="padding: 15px;">
                            <button style="padding: 6px 10px; font-size: 10px; background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="deleteUser('${username}')">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `;
            });

            userManagementBody.innerHTML = html;
        }

        function deleteUser(username) {
            if (confirm(`Tem certeza que deseja excluir ${users[username].name}?`)) {
                delete users[username];
                delete userStats[username];
                saveData();
                updateAdminPanel();
                updateUserSelects();
                showMessage('Usu√°rio exclu√≠do com sucesso!', 'success');
            }
        }

        // Adicionar Matr√≠cula
        function addMatricula() {
            const data = document.getElementById('newData').value;
            const nome = document.getElementById('newNome').value;
            const telefone = document.getElementById('newTelefone').value;
            const curso = document.getElementById('newCurso').value;
            const valorTotal = parseFloat(document.getElementById('newValorTotal').value);
            const valorEntrada = parseFloat(document.getElementById('newValorEntrada').value);
            const tipo = document.getElementById('newTipo').value;
            const parcelas = parseInt(document.getElementById('newParcelas').value) || 1;
            const vendedor = document.getElementById('newVendedor').value;
            const gerente = document.getElementById('newGerente').value;
            const assistente = document.getElementById('newAssistente').value;
            const fromVisitId = document.getElementById('newFromVisit').value;

            if (!data || !nome || !curso || !valorTotal || !valorEntrada || !vendedor || !gerente || !assistente) {
                showMessage('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            const gerenteUser = Object.values(users).find(u => u.name === gerente);
            const unidade = gerenteUser ? gerenteUser.unit : 'Shopping Conjunto Nacional';

            const novaMatricula = {
                id: Date.now(),
                data,
                nome,
                telefone,
                curso,
                valorTotal,
                valorEntrada,
                tipo,
                parcelas,
                vendedor,
                gerente,
                assistente,
                unidade,
                statusPagamento: 'Pago',
                cancelado: false,
                fromVisit: fromVisitId ? parseInt(fromVisitId) : null,
                criadoPor: currentUser.name,
                dataLancamento: new Date().toISOString()
            };

            matriculas.push(novaMatricula);

            // Se veio de uma visita, marcar como convertida
            if (fromVisitId) {
                const visita = visitas.find(v => v.id === parseInt(fromVisitId));
                if (visita) {
                    visita.convertido = true;
                    visita.matriculaId = novaMatricula.id;
                    visita.dataConversao = data;
                    giveXP(visita.atendente, 30); // XP extra por convers√£o
                }
            }

            giveXP(vendedor, 50);
            giveXP(gerente, 30);
            giveXP(assistente, 20);

            saveData();
            setupDashboard();
            showMessage('Matr√≠cula adicionada com sucesso!', 'success');
            clearMatriculaForm();
        }

        function clearMatriculaForm() {
            document.getElementById('newData').value = '';
            document.getElementById('newNome').value = '';
            document.getElementById('newTelefone').value = '';
            document.getElementById('newCurso').value = '';
            document.getElementById('newValorTotal').value = '';
            document.getElementById('newValorEntrada').value = '';
            document.getElementById('newTipo').value = 'Convencional';
            document.getElementById('newParcelas').value = '';
            document.getElementById('newFromVisit').value = '';
            
            if (currentUser.role === 'admin') {
                document.getElementById('newVendedor').value = '';
                document.getElementById('newGerente').value = '';
                document.getElementById('newAssistente').value = '';
            }
        }

        function giveXP(userName, amount) {
            const user = Object.values(users).find(u => u.name === userName);
            if (user) {
                user.xp += amount;
                const newLevel = Math.floor(user.xp / 500) + 1;
                if (newLevel > user.level) {
                    user.level = newLevel;
                }
            }
        }

        // Relat√≥rios
        function gerarRelatorioComissoes() {
            const mes = document.getElementById('relatorioMes').value;
            const unidade = document.getElementById('relatorioUnidade').value;
            const colaborador = document.getElementById('relatorioColaborador').value;

            if (!mes) {
                showMessage('Selecione um m√™s para o relat√≥rio!', 'error');
                return;
            }

            const [year, month] = mes.split('-');
            let dadosDoMes = matriculas.filter(m => {
                const dataMatricula = new Date(m.data);
                const matchMes = dataMatricula.getFullYear() == year && (dataMatricula.getMonth() + 1) == parseInt(month);
                const matchUnidade = !unidade || m.unidade === unidade;
                const matchColaborador = !colaborador || m.vendedor === colaborador || m.gerente === colaborador || m.assistente === colaborador;
                return matchMes && matchUnidade && matchColaborador && !m.cancelado;
            });

            if (currentUser.role === 'gerente') {
                dadosDoMes = dadosDoMes.filter(m => m.unidade === currentUser.unit);
            }

            let html = `
                <div class="stat-card">
                    <h3>üí∞ Relat√≥rio de Comiss√µes - ${formatMonthYear(mes)}</h3>
                    ${unidade ? `<p><strong>Unidade:</strong> ${unidade}</p>` : ''}
                    ${colaborador ? `<p><strong>Colaborador:</strong> ${colaborador}</p>` : ''}
                    
                    <div style="overflow-x: auto; margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Colaborador</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Unidade</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Tipo</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Matr√≠culas</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Comiss√£o</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            const colaboradores = {};
            
            dadosDoMes.forEach(m => {
                [m.vendedor, m.gerente, m.assistente].forEach((colaboradorNome, index) => {
                    const user = Object.values(users).find(u => u.name === colaboradorNome);
                    if (!user || user.role === 'admin') return;
                    
                    if (!colaboradores[colaboradorNome]) {
                        colaboradores[colaboradorNome] = {
                            nome: colaboradorNome,
                            unidade: user.unit,
                            tipo: user.role,
                            matriculas: 0,
                            comissao: 0
                        };
                    }
                    
                    colaboradores[colaboradorNome].matriculas++;
                    
                    const count = colaboradores[colaboradorNome].matriculas;
                    if (user.role === 'vendedor' && count >= 10) {
                        colaboradores[colaboradorNome].comissao = count * getCommissionByBand(count, COMISSAO_VENDEDOR);
                    } else if (user.role === 'gerente' && count >= 26) {
                        colaboradores[colaboradorNome].comissao = count * getCommissionByBand(count, COMISSAO_GERENTE);
                    } else if (user.role === 'assistente' && count >= 10) {
                        colaboradores[colaboradorNome].comissao = count * getCommissionByBand(count, COMISSAO_ASSISTENTE);
                    }
                });
            });

            let totalGeral = 0;
            Object.values(colaboradores).forEach(colab => {
                totalGeral += colab.comissao;
                html += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">${colab.nome}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">${colab.unidade}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;"><span class="role-badge role-${colab.tipo}">${colab.tipo}</span></td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${colab.matriculas}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(colab.comissao)}</td>
                    </tr>
                `;
            });

            html += `
                        <tr style="background: #38a169; color: white; font-weight: bold;">
                            <td colspan="4" style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">TOTAL GERAL:</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(totalGeral)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
            `;

            document.getElementById('relatorioResultado').innerHTML = html;
        }

        function gerarRelatorioConversao() {
            const mes = document.getElementById('relatorioMes').value;
            const unidade = document.getElementById('relatorioUnidade').value;
            const colaborador = document.getElementById('relatorioColaborador').value;

            if (!mes) {
                showMessage('Selecione um m√™s para o relat√≥rio!', 'error');
                return;
            }

            const [year, month] = mes.split('-');
            
            let visitasDoMes = visitas.filter(v => {
                const dataVisita = new Date(v.data);
                const matchMes = dataVisita.getFullYear() == year && (dataVisita.getMonth() + 1) == parseInt(month);
                const matchUnidade = !unidade || v.unidade === unidade;
                const matchColaborador = !colaborador || v.atendente === colaborador;
                return matchMes && matchUnidade && matchColaborador;
            });

            if (currentUser.role === 'gerente') {
                visitasDoMes = visitasDoMes.filter(v => v.unidade === currentUser.unit);
            }

            // Agrupar por colaborador
            const conversaoPorColaborador = {};
            visitasDoMes.forEach(v => {
                const atendente = v.atendente;
                if (!conversaoPorColaborador[atendente]) {
                    conversaoPorColaborador[atendente] = {
                        nome: atendente,
                        unidade: v.unidade,
                        totalVisitas: 0,
                        convertidas: 0,
                        conversao: 0
                    };
                }
                
                conversaoPorColaborador[atendente].totalVisitas++;
                if (v.convertido) {
                    conversaoPorColaborador[atendente].convertidas++;
                }
            });

            // Calcular taxa de convers√£o
            Object.values(conversaoPorColaborador).forEach(dados => {
                dados.conversao = dados.totalVisitas > 0 ? 
                    ((dados.convertidas / dados.totalVisitas) * 100).toFixed(1) : 0;
            });

            let html = `
                <div class="stat-card">
                    <h3>üìà Relat√≥rio de Convers√£o - ${formatMonthYear(mes)}</h3>
                    ${unidade ? `<p><strong>Unidade:</strong> ${unidade}</p>` : ''}
                    ${colaborador ? `<p><strong>Colaborador:</strong> ${colaborador}</p>` : ''}
                    
                    <div style="overflow-x: auto; margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Colaborador</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Unidade</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Visitas</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Convertidas</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Taxa de Convers√£o</th>
                                    <th style="padding: 12px; border: 1px solid #e2e8f0;">Pendentes</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            let totalVisitas = 0;
            let totalConvertidas = 0;

            Object.values(conversaoPorColaborador).forEach(dados => {
                totalVisitas += dados.totalVisitas;
                totalConvertidas += dados.convertidas;
                
                const pendentes = dados.totalVisitas - dados.convertidas;
                const corConversao = parseFloat(dados.conversao) >= 30 ? '#38a169' : 
                                   parseFloat(dados.conversao) >= 20 ? '#ed8936' : '#e53e3e';
                
                html += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">${dados.nome}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">${dados.unidade}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${dados.totalVisitas}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center; color: #38a169; font-weight: bold;">${dados.convertidas}</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center; color: ${corConversao}; font-weight: bold;">${dados.conversao}%</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center; color: #667eea;">${pendentes}</td>
                    </tr>
                `;
            });

            const conversaoGeral = totalVisitas > 0 ? ((totalConvertidas / totalVisitas) * 100).toFixed(1) : 0;

            html += `
                        <tr style="background: #38a169; color: white; font-weight: bold;">
                            <td colspan="2" style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">TOTAIS:</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${totalVisitas}</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${totalConvertidas}</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${conversaoGeral}%</td>
                            <td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${totalVisitas - totalConvertidas}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <h4>üìä M√©tricas de Performance:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #2d3748;">${totalVisitas}</div>
                        <div style="font-size: 12px; color: #666;">Total de Visitas</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #38a169;">${totalConvertidas}</div>
                        <div style="font-size: 12px; color: #666;">Convers√µes</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${conversaoGeral}%</div>
                        <div style="font-size: 12px; color: #666;">Taxa Geral</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">${totalVisitas - totalConvertidas}</div>
                        <div style="font-size: 12px; color: #666;">Oportunidades</div>
                    </div>
                </div>
            </div>
        </div>
            `;

            document.getElementById('relatorioResultado').innerHTML = html;
        }

        function gerarRelatorioUnidade() {
            const mes = document.getElementById('relatorioMes').value;

            if (!mes) {
                showMessage('Selecione um m√™s para o relat√≥rio!', 'error');
                return;
            }

            const [year, month] = mes.split('-');
            const dadosDoMes = matriculas.filter(m => {
                const dataMatricula = new Date(m.data);
                return dataMatricula.getFullYear() == year && 
                       (dataMatricula.getMonth() + 1) == parseInt(month) && 
                       !m.cancelado;
            });

            const visitasDoMes = visitas.filter(v => {
                const dataVisita = new Date(v.data);
                return dataVisita.getFullYear() == year && 
                       (dataVisita.getMonth() + 1) == parseInt(month);
            });

            const unidades = {};
            
            // Processar matr√≠culas
            dadosDoMes.forEach(m => {
                if (!unidades[m.unidade]) {
                    unidades[m.unidade] = {
                        matriculas: 0,
                        faturamento: 0,
                        visitas: 0,
                        conversao: 0,
                        colaboradores: new Set()
                    };
                }
                
                unidades[m.unidade].matriculas++;
                unidades[m.unidade].faturamento += m.valorEntrada;
                unidades[m.unidade].colaboradores.add(m.vendedor);
                unidades[m.unidade].colaboradores.add(m.gerente);
                unidades[m.unidade].colaboradores.add(m.assistente);
            });

            // Processar visitas
            visitasDoMes.forEach(v => {
                if (!unidades[v.unidade]) {
                    unidades[v.unidade] = {
                        matriculas: 0,
                        faturamento: 0,
                        visitas: 0,
                        conversao: 0,
                        colaboradores: new Set()
                    };
                }
                
                unidades[v.unidade].visitas++;
            });

            // Calcular convers√£o
            Object.keys(unidades).forEach(unidade => {
                const dados = unidades[unidade];
                dados.conversao = dados.visitas > 0 ? 
                    ((dados.matriculas / dados.visitas) * 100).toFixed(1) : 0;
            });

            let html = `
                <div class="stat-card">
                    <h3>üè¢ Relat√≥rio por Unidade - ${formatMonthYear(mes)}</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
            `;

            Object.entries(unidades).forEach(([unidade, dados]) => {
                const corConversao = parseFloat(dados.conversao) >= 30 ? '#38a169' : 
                                   parseFloat(dados.conversao) >= 20 ? '#ed8936' : '#e53e3e';
                
                html += `
                    <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #f8fafc, #ffffff);">
                        <h4 style="color: #2d3748; margin-bottom: 15px; text-align: center;">üè¢ ${unidade}</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 10px; background: #e6fffa; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #38a169;">${dados.matriculas}</div>
                                <div style="font-size: 11px; color: #666;">Matr√≠culas</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fff5f5; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #ed8936;">${dados.visitas}</div>
                                <div style="font-size: 11px; color: #666;">Visitas</div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0; text-align: center; padding: 10px; background: #f0f9ff; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: ${corConversao};">${dados.conversao}%</div>
                            <div style="font-size: 11px; color: #666;">Taxa de Convers√£o</div>
                        </div>
                        
                        <div style="text-align: center; padding: 10px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${formatCurrency(dados.faturamento)}</div>
                            <div style="font-size: 11px; color: #666;">Faturamento</div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 10px; color: #667eea; font-size: 12px;">
                            ${dados.colaboradores.size} colaboradores ativos
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';

            document.getElementById('relatorioResultado').innerHTML = html;
        }

        // Navega√ß√£o
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                setupDashboard();
            } else if (tabName === 'visitas') {
                updateVisitsDisplay();
                updateVisitSelects();
                document.getElementById('visitsUnitName').textContent = currentUser.unit || 'Shopping Conjunto Nacional';
                document.getElementById('conversionMonthYear').textContent = formatMonthYear(new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'));
            } else if (tabName === 'equipe') {
                setupTeamView();
            } else if (tabName === 'admin') {
                updateAdminPanel();
            } else if (tabName === 'matriculas') {
                updateUserSelects();
                updateVisitSelects();
            } else if (tabName === 'relatorios') {
                updateUserSelects();
                setCurrentMonthForReport();
            } else if (tabName === 'ranking') {
                updateRanking();
            }
        }

        function setupTeamView() {
            if (currentUser.role !== 'gerente') return;

            const teamGrid = document.getElementById('teamGrid');
            const teamUnitName = document.getElementById('teamUnitName');
            const teamPerformance = document.getElementById('teamPerformance');
            
            teamUnitName.textContent = currentUser.unit;
            
            const teamMembers = getTeamMembers();
            let teamHTML = '';
            
            teamMembers.forEach(member => {
                const memberMatriculas = getCurrentMonthData(getUserMatriculasForUser(member.name));
                const memberVisits = getCurrentMonthData(getUserVisitsForUser(member.name), 'data');
                const conversao = memberVisits.length > 0 ? (memberMatriculas.length / memberVisits.length * 100).toFixed(1) : 0;
                
                teamHTML += `
                    <div class="team-member-card">
                        <div class="member-avatar">${member.name.charAt(0).toUpperCase()}</div>
                        <div class="member-name">${member.name}</div>
                        <div class="member-role">${member.role}</div>
                        <div class="member-stats">
                            ${memberMatriculas.length} vendas<br>
                            ${memberVisits.length} visitas<br>
                            <span style="color: #ed8936;">${conversao}% convers√£o</span>
                        </div>
                    </div>
                `;
            });
            
            teamGrid.innerHTML = teamHTML;

            const unitData = getUnitData(currentUser.unit);
            const unitVisits = getUnitVisits(currentUser.unit);
            const monthData = getCurrentMonthData(unitData);
            const monthVisits = getCurrentMonthData(unitVisits, 'data');
            const totalRevenue = calculateTotalRevenue(monthData);
            const unitConversion = monthVisits.length > 0 ? (monthData.length / monthVisits.length * 100).toFixed(1) : 0;
            
            teamPerformance.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2d3748;">${monthData.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Matr√≠culas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ed8936;">${monthVisits.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Visitas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #38a169;">${unitConversion}%</div>
                        <div style="font-size: 12px; color: #666;">Convers√£o da Unidade</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2d3748;">${formatCurrency(totalRevenue)}</div>
                        <div style="font-size: 12px; color: #666;">Faturamento</div>
                    </div>
                </div>
            `;
        }

        function getTeamMembers() {
            return Object.values(users).filter(user => 
                user.unit === currentUser.unit && 
                user.role !== 'admin' && 
                user.name !== currentUser.name
            );
        }

        function getUserMatriculasForUser(userName) {
            return matriculas.filter(m => 
                m.vendedor === userName || 
                m.gerente === userName || 
                m.assistente === userName
            );
        }

        function getUserVisitsForUser(userName) {
            return visitas.filter(v => v.atendente === userName);
        }

        // Utilit√°rios
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function formatMonthYear(monthYear) {
            if (!monthYear) return 'Per√≠odo n√£o definido';
            const [year, month] = monthYear.split('-');
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return `${monthNames[parseInt(month) - 1]} de ${year}`;
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }

        function showLoadingMessage(message) {
            const existingLoader = document.getElementById('loadingMessage');
            if (existingLoader) {
                existingLoader.textContent = message;
                return;
            }

            const loader = document.createElement('div');
            loader.id = 'loadingMessage';
            loader.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                font-weight: bold;
            `;
            loader.textContent = message;
            document.body.appendChild(loader);
        }

        function hideLoadingMessage() {
            const loader = document.getElementById('loadingMessage');
            if (loader) {
                loader.remove();
            }
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dataInputs = ['newData', 'visitDate'];
            dataInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = today;
                }
            });
        }

        function setCurrentMonthForReport() {
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const relatorioMesInput = document.getElementById('relatorioMes');
            if (relatorioMesInput) {
                relatorioMesInput.value = currentMonth;
            }
        }

        // Inicializar datas quando a p√°gina carrega
        document.getElementById('teamMonthYear').textContent = formatMonthYear(new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'));
    </script>

    <!-- 
    ============================================================================
    üöÄ TUTORIAL GOOGLE APPS SCRIPT - CONFIGURA√á√ÉO OBRIGAT√ìRIA
    ============================================================================
    
    1. Acesse: https://script.google.com/
    2. Clique em "Novo projeto"
    3. Cole o c√≥digo abaixo no editor:
    
    ============================================================================
    C√ìDIGO PARA O GOOGLE APPS SCRIPT:
    ============================================================================
    
    function doPost(e) {
      try {
        const data = JSON.parse(e.postData.contents);
        const action = data.action;
        
        // Configurar sua planilha aqui (substitua pelo ID da sua planilha)
        const SPREADSHEET_ID = 'SUBSTITUA_PELO_ID_DA_SUA_PLANILHA';
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        
        if (action === 'test') {
          return ContentService
            .createTextOutput(JSON.stringify({success: true, message: 'Conex√£o OK!'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        if (action === 'save') {
          // Salvar usu√°rios
          const usersSheet = getOrCreateSheet(ss, 'usuarios');
          const users = data.users || {};
          const userRows = [['Username', 'Nome', 'Role', 'Unit', 'Level', 'XP', 'Ultima_Atualizacao']];
          Object.entries(users).forEach(([username, user]) => {
            userRows.push([
              username,
              user.name,
              user.role,
              user.unit,
              user.level,
              user.xp,
              new Date()
            ]);
          });
          usersSheet.clear();
          usersSheet.getRange(1, 1, userRows.length, userRows[0].length).setValues(userRows);
          
          // Salvar matr√≠culas
          const matriculasSheet = getOrCreateSheet(ss, 'matriculas');
          const matriculas = data.matriculas || [];
          const matriculaRows = [['ID', 'Data', 'Nome', 'Telefone', 'Curso', 'Valor_Total', 'Valor_Entrada', 'Tipo', 'Parcelas', 'Vendedor', 'Gerente', 'Assistente', 'Unidade', 'Status', 'From_Visit', 'Cancelado', 'Criado_Por', 'Data_Lancamento']];
          matriculas.forEach(m => {
            matriculaRows.push([
              m.id,
              m.data,
              m.nome,
              m.telefone || '',
              m.curso,
              m.valorTotal,
              m.valorEntrada,
              m.tipo,
              m.parcelas,
              m.vendedor,
              m.gerente,
              m.assistente,
              m.unidade,
              m.statusPagamento,
              m.fromVisit || '',
              m.cancelado || false,
              m.criadoPor || '',
              m.dataLancamento || ''
            ]);
          });
          matriculasSheet.clear();
          matriculasSheet.getRange(1, 1, matriculaRows.length, matriculaRows[0].length).setValues(matriculaRows);
          
          // Salvar visitas
          const visitasSheet = getOrCreateSheet(ss, 'visitas');
          const visitas = data.visitas || [];
          const visitaRows = [['ID', 'Data', 'Nome', 'Telefone', 'Curso_Interesse', 'Atendente', 'Unidade', 'Observacoes', 'Convertido', 'Matricula_ID', 'Data_Conversao', 'Criado_Por', 'Data_Lancamento']];
          visitas.forEach(v => {
            visitaRows.push([
              v.id,
              v.data,
              v.nome,
              v.telefone,
              v.cursoInteresse,
              v.atendente,
              v.unidade,
              v.observacoes || '',
              v.convertido || false,
              v.matriculaId || '',
              v.dataConversao || '',
              v.criadoPor || '',
              v.dataLancamento || ''
            ]);
          });
          visitasSheet.clear();
          visitasSheet.getRange(1, 1, visitaRows.length, visitaRows[0].length).setValues(visitaRows);
          
          // Salvar estat√≠sticas
          const statsSheet = getOrCreateSheet(ss, 'user_stats');
          const userStats = data.userStats || {};
          const statsRows = [['Username', 'Achievements', 'Total_Sales', 'Total_Earnings', 'Total_Visits', 'Conversion_Rate', 'Ultima_Atualizacao']];
          Object.entries(userStats).forEach(([username, stats]) => {
            statsRows.push([
              username,
              JSON.stringify(stats.achievements || []),
              stats.totalSales || 0,
              stats.totalEarnings || 0,
              stats.totalVisits || 0,
              stats.conversionRate || 0,
              new Date()
            ]);
          });
          statsSheet.clear();
          statsSheet.getRange(1, 1, statsRows.length, statsRows[0].length).setValues(statsRows);
          
          return ContentService
            .createTextOutput(JSON.stringify({success: true, message: 'Dados salvos com sucesso!'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        if (action === 'load') {
          const users = {};
          const matriculas = [];
          const visitas = [];
          const userStats = {};
          
          try {
            // Carregar usu√°rios
            const usersSheet = ss.getSheetByName('usuarios');
            if (usersSheet) {
              const userValues = usersSheet.getDataRange().getValues();
              for (let i = 1; i < userValues.length; i++) {
                const row = userValues[i];
                users[row[0]] = {
                  name: row[1],
                  username: row[0],
                  password: '123456', // Por seguran√ßa, usar senha padr√£o
                  role: row[2],
                  unit: row[3],
                  level: row[4] || 1,
                  xp: row[5] || 0
                };
              }
            }
            
            // Carregar matr√≠culas
            const matriculasSheet = ss.getSheetByName('matriculas');
            if (matriculasSheet) {
              const matriculaValues = matriculasSheet.getDataRange().getValues();
              for (let i = 1; i < matriculaValues.length; i++) {
                const row = matriculaValues[i];
                matriculas.push({
                  id: row[0],
                  data: row[1],
                  nome: row[2],
                  telefone: row[3],
                  curso: row[4],
                  valorTotal: row[5],
                  valorEntrada: row[6],
                  tipo: row[7],
                  parcelas: row[8],
                  vendedor: row[9],
                  gerente: row[10],
                  assistente: row[11],
                  unidade: row[12],
                  statusPagamento: row[13],
                  fromVisit: row[14],
                  cancelado: row[15] || false,
                  criadoPor: row[16],
                  dataLancamento: row[17]
                });
              }
            }
            
            // Carregar visitas
            const visitasSheet = ss.getSheetByName('visitas');
            if (visitasSheet) {
              const visitaValues = visitasSheet.getDataRange().getValues();
              for (let i = 1; i < visitaValues.length; i++) {
                const row = visitaValues[i];
                visitas.push({
                  id: row[0],
                  data: row[1],
                  nome: row[2],
                  telefone: row[3],
                  cursoInteresse: row[4],
                  atendente: row[5],
                  unidade: row[6],
                  observacoes: row[7],
                  convertido: row[8] || false,
                  matriculaId: row[9],
                  dataConversao: row[10],
                  criadoPor: row[11],
                  dataLancamento: row[12]
                });
              }
            }
            
            // Carregar estat√≠sticas
            const statsSheet = ss.getSheetByName('user_stats');
            if (statsSheet) {
              const statsValues = statsSheet.getDataRange().getValues();
              for (let i = 1; i < statsValues.length; i++) {
                const row = statsValues[i];
                userStats[row[0]] = {
                  achievements: JSON.parse(row[1] || '[]'),
                  totalSales: row[2] || 0,
                  totalEarnings: row[3] || 0,
                  totalVisits: row[4] || 0,
                  conversionRate: row[5] || 0
                };
              }
            }
          } catch (error) {
            // Se houver erro ao carregar, retornar dados vazios
          }
          
          return ContentService
            .createTextOutput(JSON.stringify({
              success: true,
              users: users,
              matriculas: matriculas,
              visitas: visitas,
              userStats: userStats
            }))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: false, error: 'A√ß√£o n√£o reconhecida'}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    function getOrCreateSheet(ss, name) {
      let sheet = ss.getSheetByName(name);
      if (!sheet) {
        sheet = ss.insertSheet(name);
      }
      return sheet;
    }
    
    ============================================================================
    4. Salve o projeto com o nome "Game Creators API"
    5. Clique em "Implantar" > "Nova implanta√ß√£o"
    6. Escolha tipo: "Aplicativo da web"
    7. Executar como: "Eu"
    8. Quem tem acesso: "Qualquer pessoa"
    9. Clique em "Implantar"
    10. COPIE A URL GERADA e cole no campo "URL do Google Apps Script" no admin
    11. Crie uma nova planilha do Google Sheets
    12. COPIE O ID da planilha (da URL) e substitua no c√≥digo acima
    13. Teste a conex√£o no painel admin
    ============================================================================
    -->
</body>
</html>
