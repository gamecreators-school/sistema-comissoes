<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Creators Pro V2 - Sistema Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            --warning-gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            --danger-gradient: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            --info-gradient: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            --dark-gradient: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --shadow-sm: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            text-align: center;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-card h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.4);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }

        .btn-info {
            background: var(--info-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.3);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
            margin: 2px;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 0 auto;
            max-width: 100%;
            display: none;
            backdrop-filter: blur(20px);
        }

        .page-header {
            background: var(--dark-gradient);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .theme-toggle, .notification-bell {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }

        .theme-toggle:hover, .notification-bell:hover {
            background: rgba(255,255,255,0.25);
        }

        .notification-bell {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--success-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .user-details h3 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .user-level, .unit-badge, .sync-status {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .unit-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 4px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .nav-tabs {
            background: var(--bg-primary);
            padding: 0;
            display: flex;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 18px 24px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-size: 14px;
            white-space: nowrap;
            position: relative;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-button:hover {
            background: linear-gradient(135deg, #e6fffa, #f0fff4);
            color: #38a169;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow-sm);
            border-left: 5px solid #38a169;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .stat-icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-gradient);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 420px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(199, 246, 213, 0.95), rgba(240, 253, 244, 0.95));
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(254, 215, 215, 0.95), rgba(255, 245, 245, 0.95));
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(254, 245, 231, 0.95), rgba(255, 251, 235, 0.95));
            color: #744210;
            border-left: 4px solid #ed8936;
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(190, 227, 248, 0.95), rgba(235, 248, 255, 0.95));
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .hidden {
            display: none !important;
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-top: 20px;
        }

        .data-table th {
            background: var(--dark-gradient);
            color: white;
            padding: 20px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--bg-primary);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .close-modal {
            background: var(--danger-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hall da Fama */
        .hall-of-fame {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
            margin: 25px 0;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: end;
            gap: 20px;
            margin: 30px 0;
        }

        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .podium-place.first {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.3));
            order: 2;
            transform: scale(1.1);
        }

        .podium-place.second {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(169, 169, 169, 0.3));
            order: 1;
        }

        .podium-place.third {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(184, 115, 51, 0.3));
            order: 3;
        }

        /* Commission breakdown card */
        .commission-breakdown {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }

        .commission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(56, 161, 105, 0.2);
        }

        .commission-item:last-child {
            border-bottom: none;
        }

        .commission-type {
            font-weight: 600;
            color: #2d3748;
        }

        .commission-value {
            font-weight: bold;
            color: #38a169;
            font-size: 16px;
        }

        /* Estilo para sistema de permiss√µes */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .permission-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .permission-group h5 {
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .permission-item:hover {
            background-color: #f8f9fa;
        }

        .permission-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        /* Estilo para abas personalizadas */
        .custom-tab-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin: 10px 0;
            transition: var(--transition);
        }

        .custom-tab-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 20px;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-button {
                min-width: 140px;
                padding: 16px 20px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .page-header {
                padding: 20px;
                flex-direction: column;
                gap: 20px;
            }

            .stat-card {
                padding: 25px;
            }

            .notification {
                max-width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>üéÆ Game Creators</h1>
            <p class="login-subtitle">Sistema Avan√ßado de Comiss√µes e Gamifica√ß√£o V2 ULTIMATE</p>
            <div class="form-group">
                <label>üë§ Usu√°rio:</label>
                <input type="text" id="loginUsername" placeholder="Digite seu usu√°rio" autocomplete="username">
            </div>
            <div class="form-group">
                <label>üîí Senha:</label>
                <input type="password" id="loginPassword" placeholder="Digite sua senha" autocomplete="current-password">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 25px;">
                üöÄ Entrar no Sistema
            </button>
            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
                <button class="btn btn-info btn-sm" onclick="loginDemo('admin')">üëë Admin</button>
                <button class="btn btn-success btn-sm" onclick="loginDemo('gerente')">üëî Gerente</button>
                <button class="btn btn-warning btn-sm" onclick="loginDemo('vendedor')">üë®‚Äçüíº Vendedor</button>
                <button class="btn btn-primary btn-sm" onclick="loginDemo('assistente')">üë©‚Äçüíª Assistente</button>
            </div>
            <div id="loginError" class="notification error hidden" style="position: relative; margin-top: 20px;">
                Usu√°rio ou senha incorretos!
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="main-container">
        <!-- Header -->
        <div class="page-header">
            <div class="header-content">
                <h1>üéÆ Game Creators Pro V2 ULTIMATE</h1>
                <p style="font-size: 14px; opacity: 0.8; margin-top: 4px;">Sistema Completo de Gest√£o e Gamifica√ß√£o</p>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">üåô Modo Escuro</button>
                <div class="notification-bell" onclick="toggleNotificationPanel()">
                    üîî Notifica√ß√µes
                    <span class="notification-badge" id="notificationBadge">0</span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">Usu√°rio</h3>
                    <div class="user-level" id="userLevel">N√≠vel 1 - Iniciante</div>
                    <div class="unit-badge" id="userUnit">Shopping Conjunto Nacional</div>
                    <div class="sync-status" id="syncStatus">
                        <span id="syncIcon">üü¢</span>
                        <span id="syncText">Online</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="nav-tabs" id="navTabs">
            <!-- Preenchido dinamicamente -->
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid" id="dashboardGrid">
                <!-- Preenchido dinamicamente -->
            </div>
        </div>

        <!-- Gamifica√ß√£o -->
        <div id="gamificacao" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üéÆ Meu Progresso Gamer</h3>
                    <div id="userProgress">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Hall da Fama -->
                <div class="hall-of-fame">
                    <h3 style="text-align: center; margin-bottom: 20px;">üèÜ Hall da Fama</h3>
                    <div class="podium" id="hallOfFame">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <div class="stat-card" style="margin-top: 25px;">
                    <h3>üéØ Miss√µes Ativas</h3>
                    <div id="activeMissions">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Criar Miss√£o (Admin/Gerente) -->
                <div id="createMissionSection" class="stat-card hidden" style="margin-top: 25px;">
                    <h3>‚ûï Criar Nova Miss√£o</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>T√≠tulo da Miss√£o:</label>
                            <input type="text" id="missionTitle" placeholder="Ex: Vender 5 matr√≠culas esta semana">
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o:</label>
                            <textarea id="missionDescription" rows="3" placeholder="Descri√ß√£o detalhada da miss√£o..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select id="missionType">
                                <option value="vendas">üìä Meta de Vendas</option>
                                <option value="visitas">üë• Meta de Visitas</option>
                                <option value="conversao">üìà Meta de Convers√£o</option>
                                <option value="especial">‚≠ê Miss√£o Especial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Meta (n√∫mero):</label>
                            <input type="number" id="missionTarget" min="1" placeholder="Ex: 5">
                        </div>
                        <div class="form-group">
                            <label>Recompensa (XP):</label>
                            <input type="number" id="missionReward" min="10" placeholder="Ex: 100">
                        </div>
                        <div class="form-group">
                            <label>Prazo:</label>
                            <input type="date" id="missionDeadline">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="createMission()" style="margin-top: 15px;">üéØ Criar Miss√£o</button>
                </div>
            </div>
        </div>

        <!-- Visitas -->
        <div id="visitas" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üë• Central de Visitas - <span id="visitsUnitName">Shopping Conjunto Nacional</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="form-group">
                            <label>üìÖ Data da Visita:</label>
                            <input type="date" id="visitDate" required>
                        </div>
                        <div class="form-group">
                            <label>üë§ Nome do Visitante:</label>
                            <input type="text" id="visitName" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label>üì± Telefone:</label>
                            <input type="tel" id="visitPhone" placeholder="(11) 99999-9999" required>
                        </div>
                        <div class="form-group">
                            <label>üéì Curso de Interesse:</label>
                            <select id="visitCourse" required>
                                <option value="">Selecione...</option>
                                <option value="Creators 2D">Creators 2D</option>
                                <option value="Creators 3D">Creators 3D</option>
                                <option value="Design Gr√°fico e Edi√ß√£o">Design Gr√°fico e Edi√ß√£o</option>
                                <option value="Creators Dev">Creators Dev</option>
                                <option value="Jogos Digitais T√©cnico">Jogos Digitais T√©cnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üë®‚Äçüíº Atendido por:</label>
                            <select id="visitAttendant" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìù Observa√ß√µes:</label>
                            <input type="text" id="visitNotes" placeholder="Ex: Muito interessado, vai decidir em 3 dias...">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addVisit()">‚ú® Registrar Visita</button>
                </div>
                
                <!-- Filtros de Visitas -->
                <div class="stat-card" style="margin-top: 25px;">
                    <h3>üîç Filtros de Visitas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>üóìÔ∏è Per√≠odo:</label>
                            <select id="visitPeriodFilter">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month" selected>Este M√™s</option>
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üë§ Atendente:</label>
                            <select id="visitAttendantFilter">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìä Status:</label>
                            <select id="visitStatusFilter">
                                <option value="">Todos</option>
                                <option value="pending">Pendentes</option>
                                <option value="converted">Convertidos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üîç Buscar:</label>
                            <input type="text" id="visitSearchBox" placeholder="Nome ou telefone...">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="filterVisits()">üîç Buscar</button>
                </div>

                <!-- Lista de Visitas -->
                <div class="stat-card" style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìã Hist√≥rico de Visitas</h3>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="exportVisits('csv')">üìÑ CSV</button>
                            <button class="btn btn-warning btn-sm" onclick="exportVisits('excel')">üìä Excel</button>
                        </div>
                    </div>
                    <div id="visitsList">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Matr√≠culas -->
        <div id="matriculas" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>‚ûï Adicionar Nova Matr√≠cula</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Data:</label>
                            <input type="date" id="newData" required>
                        </div>
                        <div class="form-group">
                            <label>Nome do Aluno:</label>
                            <input type="text" id="newNome" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone:</label>
                            <input type="tel" id="newTelefone" placeholder="(11) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label>Curso:</label>
                            <select id="newCurso" required>
                                <option value="">Selecione...</option>
                                <option value="Creators 2D">Creators 2D</option>
                                <option value="Creators 3D">Creators 3D</option>
                                <option value="Design Gr√°fico e Edi√ß√£o">Design Gr√°fico e Edi√ß√£o</option>
                                <option value="Creators Dev">Creators Dev</option>
                                <option value="Jogos Digitais T√©cnico">Jogos Digitais T√©cnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor Total (R$):</label>
                            <input type="number" id="newValorTotal" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Valor de Entrada (R$):</label>
                            <input type="number" id="newValorEntrada" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Venda:</label>
                            <select id="newTipo" required>
                                <option value="Convencional">Convencional (√Ä vista ou parcelado normal)</option>
                                <option value="Blackin">Blackin (6x no cart√£o)</option>
                                <option value="Black">Black (10x+ no cart√£o)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Parcelas:</label>
                            <input type="number" id="newParcelas" min="1" max="24" placeholder="Ex: 6, 10, 12...">
                        </div>
                        <div class="form-group">
                            <label>Matr√≠cula com Primeira Parcela:</label>
                            <select id="newFirstPayment" required>
                                <option value="true">Sim (Matr√≠cula + 1¬™ Parcela)</option>
                                <option value="false">N√£o (Apenas Matr√≠cula)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vendedor:</label>
                            <select id="newVendedor" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gerente:</label>
                            <select id="newGerente" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assistente:</label>
                            <select id="newAssistente" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addMatricula()" style="margin-top: 15px;">‚ûï Adicionar Matr√≠cula</button>
                </div>

                <!-- Filtros de Matr√≠culas -->
                <div class="stat-card" style="margin-top: 25px;">
                    <h3>üîç Filtros de Matr√≠culas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>üìÖ Per√≠odo:</label>
                            <select id="matriculaPeriodFilter">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month" selected>Este M√™s</option>
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üë§ Vendedor:</label>
                            <select id="matriculaVendedorFilter">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üéì Curso:</label>
                            <select id="matriculaCursoFilter">
                                <option value="">Todos</option>
                                <option value="Creators 2D">Creators 2D</option>
                                <option value="Creators 3D">Creators 3D</option>
                                <option value="Design Gr√°fico e Edi√ß√£o">Design Gr√°fico e Edi√ß√£o</option>
                                <option value="Creators Dev">Creators Dev</option>
                                <option value="Jogos Digitais T√©cnico">Jogos Digitais T√©cnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üîç Buscar:</label>
                            <input type="text" id="matriculaSearchBox" placeholder="Nome do aluno...">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="filterMatriculas()">üîç Buscar</button>
                </div>

                <!-- Lista de Matr√≠culas -->
                <div class="stat-card" style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìä Matr√≠culas Recentes</h3>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="exportMatriculas('csv')">üìÑ CSV</button>
                            <button class="btn btn-warning btn-sm" onclick="exportMatriculas('excel')">üìä Excel</button>
                        </div>
                    </div>
                    <div id="matriculasList">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipe -->
        <div id="equipe" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üë• Minha Equipe - <span id="teamUnitName">Shopping Conjunto Nacional</span></h3>
                    <div id="teamGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Metas da Unidade -->
                <div class="stat-card" style="margin-top: 25px;">
                    <h3>üéØ Metas da Unidade</h3>
                    <div id="unitGoals">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Comunica√ß√£o da Equipe -->
                <div class="stat-card" style="margin-top: 25px;">
                    <h3>üí¨ Comunica√ß√£o da Equipe</h3>
                    <div class="form-group">
                        <label>üì¢ Enviar Mensagem para a Equipe:</label>
                        <textarea id="teamMessage" rows="3" placeholder="Digite sua mensagem para toda a equipe..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="sendTeamMessage()">üì§ Enviar Mensagem</button>
                        <button class="btn btn-success" onclick="scheduleTeamMeeting()">üìÖ Agendar Reuni√£o</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking -->
        <div id="ranking" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üèÜ Ranking de Performance</h3>
                    <div id="rankingTable">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div id="relatorios" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üìä Relat√≥rios de Performance</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="gerarRelatorioComissoes()">üí∞ Relat√≥rio Comiss√µes</button>
                        <button class="btn btn-success" onclick="gerarRelatorioConversao()">üìà Relat√≥rio Convers√£o</button>
                        <button class="btn btn-warning" onclick="gerarRelatorioUnidade()">üè¢ Relat√≥rio por Unidade</button>
                        <button class="btn btn-info" onclick="gerarRelatorioMetas()">üéØ Relat√≥rio Metas</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioTendencias()">üìà An√°lise de Tend√™ncias</button>
                        <button class="btn btn-success" onclick="gerarRelatorioPrevisao()">üîÆ Previs√£o de Vendas</button>
                    </div>
                </div>

                <div id="relatorioResultado">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div id="chat" class="tab-content">
            <div style="padding: 30px;">
                <div class="stat-card">
                    <h3>üí¨ Chat da Equipe</h3>
                    <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background: var(--bg-primary); margin-bottom: 15px;">
                        <p style="text-align: center; color: #666;">Carregando mensagens...</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatMessage" placeholder="Digite sua mensagem..." style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 25px;">
                        <button class="btn btn-primary" onclick="sendChatMessage()">üì§ Enviar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div id="admin" class="tab-content">
            <div style="padding: 30px;">
                <h2>üë®‚Äçüíº Painel Administrativo</h2>
                
                <!-- Configurar Metas por Unidade -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>üéØ Configurar Metas por Unidade</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Unidade:</label>
                            <select id="goalUnit">
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Meta de Matr√≠culas (m√™s):</label>
                            <input type="number" id="goalMatriculas" min="1" placeholder="Ex: 50">
                        </div>
                        <div class="form-group">
                            <label>Meta de Faturamento (R$):</label>
                            <input type="number" id="goalFaturamento" step="0.01" min="0" placeholder="Ex: 80000">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="setUnitGoals()">üéØ Definir Metas</button>
                    
                    <div id="currentGoals" style="margin-top: 20px;">
                        <h4>Metas Atuais:</h4>
                        <div id="goalsList">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Gerenciar Unidades -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>üè¢ Gerenciar Unidades</h3>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                        <div class="form-group">
                            <label>Nome da Nova Unidade:</label>
                            <input type="text" id="newUnitName" placeholder="Ex: Shopping Iguatemi">
                        </div>
                        <button class="btn btn-success" onclick="addNewUnit()">‚ûï Adicionar Unidade</button>
                    </div>
                    <div id="currentUnits" style="margin-top: 15px;">
                        <h4>Unidades Ativas:</h4>
                        <div id="unitsList">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Adicionar Usu√°rio -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>‚ûï Adicionar Novo Usu√°rio</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="newUserName" placeholder="Nome completo">
                        </div>
                        <div class="form-group">
                            <label>Usu√°rio:</label>
                            <input type="text" id="newUserUsername" placeholder="usuario@gamecreatorsadm.com">
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" id="newUserPassword" placeholder="senha123">
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select id="newUserRole" onchange="updatePermissionsByRole()">
                                <option value="vendedor">üë®‚Äçüíº Vendedor</option>
                                <option value="gerente">üëî Gerente</option>
                                <option value="assistente">üë©‚Äçüíª Assistente</option>
                                <option value="admin">üîß Admin</option>
                                <option value="custom">üéõÔ∏è Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unidade:</label>
                            <select id="newUserUnit">
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Sistema de Permiss√µes Personalizadas -->
                    <div id="customPermissions" style="margin-top: 20px; display: none;">
                        <h4 style="margin-bottom: 15px;">üîê Permiss√µes Personalizadas</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                                <div>
                                    <h5 style="color: #38a169; margin-bottom: 10px;">üìä Funcionalidades B√°sicas</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_dashboard" style="margin-right: 10px;">
                                        üìä Dashboard
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_gamificacao" style="margin-right: 10px;">
                                        üéÆ Gamifica√ß√£o
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_ranking" style="margin-right: 10px;">
                                        üèÜ Ranking
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_chat" style="margin-right: 10px;">
                                        üí¨ Chat
                                    </label>
                                </div>
                                
                                <div>
                                    <h5 style="color: #3182ce; margin-bottom: 10px;">üë• Gest√£o de Visita√ß√£o</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_visitas" style="margin-right: 10px;">
                                        üë• Ver Visitas
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_visitas_edit" style="margin-right: 10px;">
                                        ‚úèÔ∏è Editar Visitas
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_visitas_delete" style="margin-right: 10px;">
                                        üóëÔ∏è Excluir Visitas
                                    </label>
                                </div>
                                
                                <div>
                                    <h5 style="color: #ed8936; margin-bottom: 10px;">üìö Gest√£o de Matr√≠culas</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_matriculas" style="margin-right: 10px;">
                                        üìö Ver Matr√≠culas
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_matriculas_edit" style="margin-right: 10px;">
                                        ‚úèÔ∏è Editar Matr√≠culas
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_matriculas_delete" style="margin-right: 10px;">
                                        üóëÔ∏è Excluir Matr√≠culas
                                    </label>
                                </div>
                                
                                <div>
                                    <h5 style="color: #38a169; margin-bottom: 10px;">üí∞ Gest√£o de Comiss√µes</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_comissoes_edit" style="margin-right: 10px;">
                                        üí∞ Editar Comiss√µes
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_comissoes_delete" style="margin-right: 10px;">
                                        üóëÔ∏è Excluir Comiss√µes
                                    </label>
                                </div>
                                
                                <div>
                                    <h5 style="color: #e53e3e; margin-bottom: 10px;">üëî Fun√ß√µes Gerenciais</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_equipe" style="margin-right: 10px;">
                                        üë• Gest√£o de Equipe
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_relatorios" style="margin-right: 10px;">
                                        üìä Relat√≥rios
                                    </label>
                                </div>
                                
                                <div>
                                    <h5 style="color: #9333ea; margin-bottom: 10px;">üîß Administra√ß√£o</h5>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_admin" style="margin-right: 10px;">
                                        ‚öôÔ∏è Painel Admin
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_admin_users" style="margin-right: 10px;">
                                        üë• Gerenciar Usu√°rios
                                    </label>
                                    <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                        <input type="checkbox" id="perm_admin_tabs" style="margin-right: 10px;">
                                        üìã Gerenciar Abas
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: center;">
                                <button class="btn btn-info btn-sm" onclick="selectAllPermissions()">‚úÖ Selecionar Todas</button>
                                <button class="btn btn-warning btn-sm" onclick="clearAllPermissions()">‚ùå Limpar Todas</button>
                                <button class="btn btn-success btn-sm" onclick="applyRolePermissions()">üéØ Aplicar Padr√£o do Cargo</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addUser()" style="margin-top: 15px;">‚ûï Adicionar Usu√°rio</button>
                </div>

                <!-- Criador de Abas Personalizadas -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>üìã Gerenciar Abas Personalizadas</h3>
                    <p style="color: #666; margin-bottom: 20px;">Crie abas personalizadas para adicionar novas funcionalidades ao sistema.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>üìõ Nome da Aba:</label>
                            <input type="text" id="customTabName" placeholder="Ex: Relat√≥rio de Vendas" required>
                        </div>
                        <div class="form-group">
                            <label>üì± √çcone:</label>
                            <input type="text" id="customTabIcon" placeholder="Ex: üìä, üéØ, üíº" required>
                        </div>
                        <div class="form-group">
                            <label>üìù Descri√ß√£o:</label>
                            <input type="text" id="customTabDescription" placeholder="Breve descri√ß√£o da aba...">
                        </div>
                        <div class="form-group">
                            <label>üîê Permiss√£o Necess√°ria:</label>
                            <select id="customTabPermission">
                                <option value="">Todos podem ver</option>
                                ${Object.entries(PERMISSIONS).map(([key, perm]) => 
                                    `<option value="${perm}">${key}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>üìã Conte√∫do da Aba (HTML):</label>
                        <textarea id="customTabContent" rows="6" style="font-family: monospace; font-size: 12px;" placeholder="Digite o HTML que ser√° exibido na aba..."></textarea>
                        <small style="color: #666;">üí° Voc√™ pode usar HTML b√°sico: &lt;h3&gt;, &lt;p&gt;, &lt;div&gt;, &lt;button&gt;, etc.</small>
                    </div>
                    
                    <button class="btn btn-success" onclick="createCustomTab()">‚ûï Criar Aba Personalizada</button>
                    
                    <!-- Lista de Abas Personalizadas -->
                    <div id="customTabsList" style="margin-top: 25px;">
                        <h4>Abas Personalizadas Existentes:</h4>
                        <div id="existingCustomTabs">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Lista de Usu√°rios -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>üë• Gerenciar Usu√°rios</h3>
                    <div id="userManagementTable">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Google Sheets Integration -->
                <div class="stat-card" style="margin: 20px 0;">
                    <h3>üìä Integra√ß√£o com Google Sheets</h3>
                    <p style="color: #666; margin-bottom: 20px;">Configure a sincroniza√ß√£o autom√°tica com planilhas do Google para backup e integra√ß√£o de dados.</p>
                    
                    <!-- M√©todo 1: Conex√£o Autom√°tica por ID -->
                    <div style="background: linear-gradient(135deg, #e3f2fd, #f0f9ff); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">üöÄ M√©todo R√°pido - Conex√£o por ID</h4>
                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Use este m√©todo se voc√™ executou o script de setup autom√°tico</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üÜî ID da Planilha:</label>
                                <input type="text" id="googleSheetId" placeholder="1ABC123DEF456..." style="font-family: monospace; font-size: 12px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üîë API Key:</label>
                                <input type="password" id="googleApiKeyId" placeholder="GC_2024_SECURE_KEY...">
                            </div>
                            <button class="btn btn-success" onclick="connectBySpreadsheetId()">üîó Conectar por ID</button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
                            <small style="color: #1976d2;">
                                üí° <strong>Como obter o ID:</strong> Execute a fun√ß√£o <code>createGameCreatorsDatabase()</code> no Apps Script e copie o ID gerado
                            </small>
                        </div>
                    </div>

                    <!-- M√©todo 2: Conex√£o Manual -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #6c757d;">
                        <h4 style="color: #495057; margin-bottom: 15px;">‚öôÔ∏è M√©todo Manual - Configura√ß√£o Completa</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>üîó URL da Planilha Google:</label>
                                <input type="url" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." style="font-size: 12px;">
                            </div>
                            <div class="form-group">
                                <label>üîë API Key do Google:</label>
                                <input type="password" id="googleApiKey" placeholder="Sua chave API...">
                            </div>
                            <div class="form-group">
                                <label>üìã Nome da Aba:</label>
                                <input type="text" id="googleSheetTab" placeholder="Matriculas" value="Matriculas">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="testGoogleConnection()">üîç Testar Conex√£o</button>
                            <button class="btn btn-success" onclick="exportToGoogleSheets()">üì§ Exportar</button>
                            <button class="btn btn-warning" onclick="importFromGoogleSheets()">üì• Importar</button>
                            <button class="btn btn-info" onclick="syncWithGoogleSheets()">üîÑ Sincronizar</button>
                        </div>
                    </div>

                    <!-- Status da Integra√ß√£o -->
                    <div id="googleSheetsStatus" style="padding: 20px; border-radius: 12px; margin-top: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">üìä Status da Integra√ß√£o</h4>
                        <div id="googleConnectionStatus" style="margin: 10px 0; font-weight: 600;">
                            <span style="color: #666;">üî¥ N√£o Conectado</span>
                        </div>
                        <div id="googleConnectionDetails" style="font-size: 14px; color: #666; margin: 10px 0;">
                            Status: Aguardando conex√£o
                        </div>
                        <div id="googleLastSync" style="font-size: 12px; color: #666;">
                            √öltima sincroniza√ß√£o: Nunca
                        </div>
                    </div>

                    <!-- Instru√ß√µes de Setup -->
                    <div style="background: linear-gradient(135deg, #fff3e0, #fef7ed); padding: 20px; border-radius: 12px; margin-top: 20px; border-left: 4px solid #ff9800;">
                        <h4 style="color: #e65100; margin-bottom: 15px;">üìã Instru√ß√µes de Setup Autom√°tico</h4>
                        <ol style="color: #bf360c; line-height: 1.6;">
                            <li>Acesse <a href="https://script.google.com" target="_blank" style="color: #1976d2;">Google Apps Script</a></li>
                            <li>Crie um novo projeto</li>
                            <li>Cole o c√≥digo de setup autom√°tico fornecido</li>
                            <li>Mude a API_KEY na linha 8 do c√≥digo</li>
                            <li>Execute a fun√ß√£o <code>createGameCreatorsDatabase()</code></li>
                            <li>Copie o ID da planilha gerado</li>
                            <li>Fa√ßa deploy como Web App (Execute as: Me, Access: Anyone)</li>
                            <li>Use o ID aqui no sistema</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentUser = null;
        let currentUnit = null;
        let currentTheme = 'light';

        // Estrutura de dados
        let gameData = {
            users: {},
            matriculas: [],
            visitas: [],
            units: ['Shopping Conjunto Nacional', 'Shopping Eldorado', 'Shopping Morumbi'],
            missions: [],
            chatMessages: [],
            unitGoals: {},
            customTabs: [], // Abas personalizadas criadas pelo admin
            userPermissions: {} // Permiss√µes espec√≠ficas por usu√°rio
        };

        // Sistema de permiss√µes
        const PERMISSIONS = {
            DASHBOARD: 'dashboard',
            GAMIFICACAO: 'gamificacao',
            VISITAS: 'visitas',
            VISITAS_EDIT: 'visitas_edit',
            VISITAS_DELETE: 'visitas_delete',
            MATRICULAS: 'matriculas',
            MATRICULAS_EDIT: 'matriculas_edit',
            MATRICULAS_DELETE: 'matriculas_delete',
            COMISSOES_EDIT: 'comissoes_edit',
            COMISSOES_DELETE: 'comissoes_delete',
            EQUIPE: 'equipe',
            RANKING: 'ranking',
            RELATORIOS: 'relatorios',
            CHAT: 'chat',
            ADMIN: 'admin',
            ADMIN_USERS: 'admin_users',
            ADMIN_UNITS: 'admin_units',
            ADMIN_GOALS: 'admin_goals',
            ADMIN_SHEETS: 'admin_sheets',
            ADMIN_TABS: 'admin_tabs'
        };

        // Permiss√µes padr√£o por cargo
        const DEFAULT_PERMISSIONS = {
            admin: Object.values(PERMISSIONS),
            gerente: [
                PERMISSIONS.DASHBOARD, PERMISSIONS.GAMIFICACAO, PERMISSIONS.VISITAS,
                PERMISSIONS.VISITAS_EDIT, PERMISSIONS.VISITAS_DELETE, PERMISSIONS.MATRICULAS,
                PERMISSIONS.MATRICULAS_EDIT, PERMISSIONS.EQUIPE, PERMISSIONS.RANKING,
                PERMISSIONS.RELATORIOS, PERMISSIONS.CHAT
            ],
            vendedor: [
                PERMISSIONS.DASHBOARD, PERMISSIONS.GAMIFICACAO, PERMISSIONS.VISITAS,
                PERMISSIONS.VISITAS_EDIT, PERMISSIONS.MATRICULAS, PERMISSIONS.RANKING, PERMISSIONS.CHAT
            ],
            assistente: [
                PERMISSIONS.DASHBOARD, PERMISSIONS.GAMIFICACAO, PERMISSIONS.VISITAS,
                PERMISSIONS.MATRICULAS, PERMISSIONS.RANKING, PERMISSIONS.CHAT
            ]
        };

        // Configura√ß√£o do Google Sheets
        let googleSheetsConfig = {
            url: '',
            apiKey: '',
            tabName: 'Matriculas',
            connected: false,
            lastSync: null,
            // Novos campos para conex√£o por ID
            spreadsheetId: '',
            webAppUrl: '',
            spreadsheetName: '',
            connectionMethod: 'manual' // 'manual' ou 'id'
        };

        // Inicializa√ß√£o
        function initializeSystem() {
            loadGameData();
            initializeDefaultData();
            setupEventListeners();
            checkAutoLogin();
        }

        function loadGameData() {
            try {
                const saved = localStorage.getItem('gameCreatorsData');
                if (saved) {
                    gameData = { ...gameData, ...JSON.parse(saved) };
                }
                console.log('‚úÖ Dados carregados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados salvos', 'error');
            }
        }

        function saveGameData() {
            try {
                localStorage.setItem('gameCreatorsData', JSON.stringify(gameData));
                console.log('‚úÖ Dados salvos com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
                showNotification('Erro ao salvar dados', 'error');
            }
        }

        function initializeDefaultData() {
            if (!gameData.users || Object.keys(gameData.users).length === 0) {
                createDefaultUsers();
            }
            if (!gameData.chatMessages) {
                gameData.chatMessages = [];
            }
            if (!gameData.unitGoals) {
                gameData.unitGoals = {};
                // Metas padr√£o
                gameData.units.forEach(unit => {
                    gameData.unitGoals[unit] = {
                        matriculas: 50,
                        faturamento: 80000
                    };
                });
            }
        }

        function createDefaultUsers() {
            const defaultUsers = [
                {
                    username: 'admin@gamecreatorsadm.com',
                    password: 'admin123',
                    name: 'Administrador',
                    role: 'admin',
                    unit: 'Shopping Conjunto Nacional',
                    xp: 5000,
                    level: 10,
                    permissions: DEFAULT_PERMISSIONS.admin
                },
                {
                    username: 'gerente@gamecreatorsadm.com',
                    password: 'gerente123',
                    name: 'Carlos Manager',
                    role: 'gerente',
                    unit: 'Shopping Conjunto Nacional',
                    xp: 3500,
                    level: 7,
                    permissions: DEFAULT_PERMISSIONS.gerente
                },
                {
                    username: 'vendedor@gamecreatorsadm.com',
                    password: 'vendedor123',
                    name: 'Ana Silva',
                    role: 'vendedor',
                    unit: 'Shopping Conjunto Nacional',
                    xp: 2100,
                    level: 5,
                    permissions: DEFAULT_PERMISSIONS.vendedor
                },
                {
                    username: 'assistente@gamecreatorsadm.com',
                    password: 'assistente123',
                    name: 'Jo√£o Santos',
                    role: 'assistente',
                    unit: 'Shopping Conjunto Nacional',
                    xp: 1200,
                    level: 3,
                    permissions: DEFAULT_PERMISSIONS.assistente
                }
            ];

            defaultUsers.forEach(user => {
                gameData.users[user.username] = {
                    ...user,
                    id: generateId(),
                    createdAt: new Date().toISOString()
                };
            });

            saveGameData();
            console.log('‚úÖ Usu√°rios padr√£o criados');
        }

        // Fun√ß√£o para verificar permiss√µes
        function hasPermission(permission) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true; // Admin tem todas as permiss√µes
            return currentUser.permissions && currentUser.permissions.includes(permission);
        }

        // Sistema de login
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showNotification('Por favor, preencha todos os campos', 'warning');
                return;
            }

            const user = gameData.users[username];
            
            if (user && user.password === password) {
                currentUser = user;
                currentUnit = user.unit;
                
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                showNotification(`Bem-vindo, ${user.name}! üéâ`, 'success');
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                
                initializeUserInterface();
                console.log('‚úÖ Login realizado com sucesso');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('loginError').classList.add('hidden');
                }, 3000);
                console.log('‚ùå Credenciais inv√°lidas');
            }
        }

        function loginDemo(role) {
            const demoUsers = {
                'admin': 'admin@gamecreatorsadm.com',
                'gerente': 'gerente@gamecreatorsadm.com',
                'vendedor': 'vendedor@gamecreatorsadm.com',
                'assistente': 'assistente@gamecreatorsadm.com'
            };
            
            const username = demoUsers[role];
            const user = gameData.users[username];
            
            if (user) {
                document.getElementById('loginUsername').value = username;
                document.getElementById('loginPassword').value = user.password;
                login();
            }
        }

        function logout() {
            currentUser = null;
            currentUnit = null;
            
            localStorage.removeItem('currentUser');
            
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            
            showNotification('Logout realizado com sucesso! üëã', 'info');
            console.log('‚úÖ Logout realizado');
        }

        function checkAutoLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    currentUnit = currentUser.unit;
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainSystem').style.display = 'block';
                    
                    initializeUserInterface();
                    showNotification(`Bem-vindo de volta, ${currentUser.name}! üéâ`, 'success');
                } catch (error) {
                    console.error('‚ùå Erro no auto-login:', error);
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Interface do usu√°rio
        function initializeUserInterface() {
            updateUserInfo();
            createNavigation();
            updateDashboard();
            loadAllData();
        }

        function updateUserInfo() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userLevel').textContent = `N√≠vel ${currentUser.level} - ${getLevelName(currentUser.level)}`;
            document.getElementById('userUnit').textContent = currentUser.unit;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
        }

        function getLevelName(level) {
            if (level >= 10) return 'Lenda';
            if (level >= 8) return 'Especialista';
            if (level >= 6) return 'Veterano';
            if (level >= 4) return 'Experiente';
            if (level >= 2) return 'Aprendiz';
            return 'Iniciante';
        }

        function createNavigation() {
            const navTabs = document.getElementById('navTabs');
            const defaultTabs = [
                { id: 'dashboard', name: 'üìä Dashboard', permission: PERMISSIONS.DASHBOARD },
                { id: 'gamificacao', name: 'üéÆ Gamifica√ß√£o', permission: PERMISSIONS.GAMIFICACAO },
                { id: 'visitas', name: 'üë• Visitas', permission: PERMISSIONS.VISITAS },
                { id: 'matriculas', name: 'üìö Matr√≠culas', permission: PERMISSIONS.MATRICULAS },
                { id: 'equipe', name: 'üë• Equipe', permission: PERMISSIONS.EQUIPE },
                { id: 'ranking', name: 'üèÜ Ranking', permission: PERMISSIONS.RANKING },
                { id: 'relatorios', name: 'üìä Relat√≥rios', permission: PERMISSIONS.RELATORIOS },
                { id: 'chat', name: 'üí¨ Chat', permission: PERMISSIONS.CHAT },
                { id: 'admin', name: '‚öôÔ∏è Admin', permission: PERMISSIONS.ADMIN }
            ];

            // Filtrar abas baseado nas permiss√µes
            const allowedTabs = defaultTabs.filter(tab => hasPermission(tab.permission));
            
            // Adicionar abas personalizadas se o usu√°rio tem permiss√£o
            if (gameData.customTabs) {
                gameData.customTabs.forEach(customTab => {
                    if (hasPermission(customTab.permission) || !customTab.permission) {
                        allowedTabs.push({
                            id: customTab.id,
                            name: `${customTab.icon} ${customTab.name}`,
                            permission: customTab.permission,
                            isCustom: true
                        });
                    }
                });
            }

            navTabs.innerHTML = allowedTabs
                .map(tab => `
                    <button class="tab-button ${tab.id === 'dashboard' ? 'active' : ''}" 
                            onclick="switchTab('${tab.id}')">
                        ${tab.name}
                    </button>
                `).join('');
        }

        function switchTab(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Ativar tab selecionada
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Verificar se √© aba personalizada
            const customTab = gameData.customTabs?.find(tab => tab.id === tabId);
            if (customTab) {
                showCustomTab(customTab);
                return;
            }
            
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Carregar conte√∫do espec√≠fico da tab
            switch(tabId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'gamificacao':
                    updateGamification();
                    break;
                case 'visitas':
                    updateVisitasTab();
                    break;
                case 'matriculas':
                    updateMatriculasTab();
                    break;
                case 'equipe':
                    updateEquipeTab();
                    break;
                case 'ranking':
                    updateRankingTab();
                    break;
                case 'relatorios':
                    updateRelatoriosTab();
                    break;
                case 'chat':
                    updateChatTab();
                    break;
                case 'admin':
                    updateAdminTab();
                    break;
            }
        }

        function showCustomTab(customTab) {
            // Ocultar todas as abas padr√£o
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Remover aba personalizada anterior se existir
            const existingCustomTab = document.getElementById('customTabContent');
            if (existingCustomTab) {
                existingCustomTab.remove();
            }
            
            // Criar conte√∫do da aba personalizada
            const customTabContent = document.createElement('div');
            customTabContent.id = 'customTabContent';
            customTabContent.className = 'tab-content active';
            customTabContent.style.padding = '30px';
            
            customTabContent.innerHTML = `
                <div class="stat-card">
                    <h2>${customTab.icon} ${customTab.name}</h2>
                    <p style="color: #666; margin-bottom: 20px;">${customTab.description}</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #3182ce;">
                        <h4 style="margin-bottom: 15px;">üìã Conte√∫do da Aba</h4>
                        <div id="customTabMainContent">
                            ${customTab.content || '<p>Esta aba ainda n√£o tem conte√∫do definido.</p>'}
                        </div>
                        
                        ${hasPermission(PERMISSIONS.ADMIN) ? `
                            <hr style="margin: 20px 0;">
                            <div style="text-align: center;">
                                <button class="btn btn-warning btn-sm" onclick="editCustomTab('${customTab.id}')">‚úèÔ∏è Editar Aba</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCustomTab('${customTab.id}')">üóëÔ∏è Excluir Aba</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.querySelector('.main-container').appendChild(customTabContent);
        }

        // Dashboard
        function updateDashboard() {
            const grid = document.getElementById('dashboardGrid');
            const userStats = calculateUserStats();

            const cards = [
                {
                    title: 'Matr√≠culas do M√™s',
                    value: userStats.matriculas,
                    icon: 'üìö',
                    color: '#38a169',
                    progress: (userStats.matriculas / 15) * 100
                },
                {
                    title: 'Visitas Registradas',
                    value: userStats.visitas,
                    icon: 'üë•',
                    color: '#3182ce',
                    progress: (userStats.visitas / 50) * 100
                },
                {
                    title: 'Taxa de Convers√£o',
                    value: `${(userStats.conversao * 100).toFixed(1)}%`,
                    icon: 'üìà',
                    color: '#ed8936',
                    progress: userStats.conversao * 100
                },
                {
                    title: 'Comiss√£o do M√™s',
                    value: `R$ ${userStats.comissao.toFixed(2)}`,
                    icon: 'üí∞',
                    color: '#38a169',
                    progress: (userStats.comissao / 5000) * 100
                },
                {
                    title: 'Experi√™ncia (XP)',
                    value: currentUser.xp || 0,
                    icon: '‚≠ê',
                    color: '#667eea',
                    progress: ((currentUser.xp || 0) % 1000) / 10
                },
                {
                    title: 'N√≠vel Atual',
                    value: currentUser.level || 1,
                    icon: 'üéÆ',
                    color: '#ed8936',
                    progress: 100
                }
            ];

            grid.innerHTML = cards.map(card => `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">${card.icon}</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${card.color};">${card.title}</div>
                    </div>
                    <div class="stat-value" style="color: ${card.color};">${card.value}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(card.progress, 100)}%; background: linear-gradient(135deg, ${card.color}, ${card.color}90);"></div>
                    </div>
                    <div class="progress-text">${Math.min(card.progress, 100).toFixed(0)}% da meta</div>
                </div>
            `).join('');
        }

        function calculateUserStats() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const matriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       (m.vendedor === currentUser.name || m.gerente === currentUser.name || m.assistente === currentUser.name);
            });

            const visitas = gameData.visitas.filter(v => {
                const date = new Date(v.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       v.atendente === currentUser.name;
            });

            const comissao = matriculas.reduce((sum, m) => {
                let userCommission = 0;
                if (m.vendedor === currentUser.name) userCommission += m.comissaoVendedor || 0;
                if (m.gerente === currentUser.name) userCommission += m.comissaoGerente || 0;
                if (m.assistente === currentUser.name) userCommission += m.comissaoAssistente || 0;
                return sum + userCommission;
            }, 0);

            const conversao = visitas.length > 0 ? matriculas.length / visitas.length : 0;

            return {
                matriculas: matriculas.length,
                visitas: visitas.length,
                conversao: conversao,
                comissao: comissao
            };
        }

        // SISTEMA DE COMISS√ïES OFICIAL - ATUALIZADO CONFORME DOCUMENTO

        /**
         * Calcula comiss√µes seguindo as regras oficiais do documento
         * @param {Object} matricula - Dados da matr√≠cula
         * @param {string} userRole - Papel do usu√°rio (vendedor, gerente, assistente)
         * @param {number} userMatriculasCount - N√∫mero de matr√≠culas do usu√°rio no m√™s
         * @param {boolean} isFirstPayment - Se inclui primeira parcela
         * @returns {number} Valor da comiss√£o
         */
        function calculateOfficialCommissions(matricula, userRole, userMatriculasCount, isFirstPayment = true) {
            const { tipo } = matricula;
            
            let commission = 0;
            let bonus = 0;

            if (userRole === 'vendedor') {
                // VENDEDOR: A partir da 10¬™ matr√≠cula
                if (userMatriculasCount >= 10) {
                    if (userMatriculasCount >= 41) {
                        commission = 70;
                    } else if (userMatriculasCount >= 31) {
                        commission = 60;
                    } else if (userMatriculasCount >= 21) {
                        commission = 50;
                    } else {
                        commission = 35; // De 10 a 20
                    }
                    
                    // Se for s√≥ matr√≠cula (sem primeira parcela), pagar 50%
                    if (!isFirstPayment) {
                        commission *= 0.5;
                    }
                }
                
                // B√¥nus Blackin/Black (dividido entre vendedor e gerente)
                if (tipo === 'Blackin') {
                    bonus = 25; // R$ 50 dividido por 2
                } else if (tipo === 'Black') {
                    bonus = 50; // R$ 100 dividido por 2
                }

            } else if (userRole === 'gerente') {
                // GERENTE: A partir da 26¬™ matr√≠cula
                if (userMatriculasCount >= 26) {
                    if (userMatriculasCount >= 53) {
                        commission = 80; // De 53 a 78
                    } else {
                        commission = 50; // De 26 a 52
                    }
                    
                    // Se for s√≥ matr√≠cula (sem primeira parcela), pagar 50%
                    if (!isFirstPayment) {
                        commission *= 0.5;
                    }
                }
                
                // B√¥nus Blackin/Black (50% do b√¥nus)
                if (tipo === 'Blackin') {
                    bonus = 25; // 50% de R$ 50
                } else if (tipo === 'Black') {
                    bonus = 50; // 50% de R$ 100
                }

            } else if (userRole === 'assistente') {
                // ASSISTENTE: A partir da 10¬™ matr√≠cula
                if (userMatriculasCount >= 10) {
                    if (userMatriculasCount >= 41) {
                        commission = 30;
                    } else if (userMatriculasCount >= 31) {
                        commission = 25;
                    } else if (userMatriculasCount >= 21) {
                        commission = 15;
                    } else {
                        commission = 10; // De 10 a 20
                    }
                    
                    // Se for s√≥ matr√≠cula (sem primeira parcela), pagar 50%
                    if (!isFirstPayment) {
                        commission *= 0.5;
                    }
                }
            }

            return commission + bonus;
        }

        /**
         * Calcula b√¥nus di√°rio oficial
         * @param {string} userRole - Papel do usu√°rio
         * @param {number} dailyMatriculas - N√∫mero de matr√≠culas no dia
         * @returns {number} Valor do b√¥nus di√°rio
         */
        function calculateOfficialDailyBonus(userRole, dailyMatriculas) {
            if (userRole === 'vendedor') {
                if (dailyMatriculas >= 3) return 100;
                if (dailyMatriculas >= 2) return 50;
            } else if (userRole === 'assistente') {
                if (dailyMatriculas >= 3) return 40;
                if (dailyMatriculas >= 2) return 20;
            }
            return 0;
        }

        /**
         * Calcula comiss√£o por faturamento (apenas gerente)
         * @param {number} monthlyRevenue - Faturamento mensal
         * @returns {number} Comiss√£o por faturamento
         */
        function calculateRevenueCommission(monthlyRevenue) {
            if (monthlyRevenue >= 80000) {
                return monthlyRevenue * 0.03; // 3%
            } else if (monthlyRevenue >= 49054.20) {
                return monthlyRevenue * 0.02; // 2%
            } else if (monthlyRevenue >= 31445) {
                return monthlyRevenue * 0.01; // 1%
            }
            return 0;
        }

        /**
         * Verifica se a unidade ganhou b√¥nus por atingir ambas as metas
         * @param {string} unit - Nome da unidade
         * @returns {boolean} Se ganhou o b√¥nus de R$ 1.000
         */
        function checkUnitBonus(unit) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const unitGoal = gameData.unitGoals[unit] || { matriculas: 50, faturamento: 80000 };
            
            const unitMatriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       m.unidade === unit;
            });
            
            const currentMatriculas = unitMatriculas.length;
            const currentFaturamento = unitMatriculas.reduce((sum, m) => sum + (m.valorTotal || 0), 0);
            
            return currentMatriculas >= unitGoal.matriculas && currentFaturamento >= unitGoal.faturamento;
        }

        function calculateMonthlyRevenue(unit) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return gameData.matriculas
                .filter(m => {
                    const date = new Date(m.data);
                    return date.getMonth() === currentMonth && 
                           date.getFullYear() === currentYear &&
                           m.unidade === unit;
                })
                .reduce((sum, m) => sum + (m.valorTotal || 0), 0);
        }

        // Gamifica√ß√£o
        function updateGamification() {
            updateUserProgress();
            updateHallOfFame();
            updateActiveMissions();
            
            if (currentUser.role === 'admin' || currentUser.role === 'gerente') {
                document.getElementById('createMissionSection').classList.remove('hidden');
            }
        }

        function updateUserProgress() {
            const progressDiv = document.getElementById('userProgress');
            const xp = currentUser.xp || 0;
            const level = currentUser.level || 1;
            const nextLevelXP = level * 1000;
            const currentLevelXP = (level - 1) * 1000;
            const progressXP = xp - currentLevelXP;
            const neededXP = nextLevelXP - currentLevelXP;

            progressDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üéÆ</div>
                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">N√≠vel ${level}</div>
                        <div style="font-size: 14px; opacity: 0.9;">${getLevelName(level)}</div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; margin-top: 15px; font-size: 12px; font-weight: 600;">${xp} XP Total</div>
                    </div>
                    <div style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">üìà Progresso para o Pr√≥ximo N√≠vel</h4>
                        <div class="progress-bar" style="height: 15px; margin-bottom: 10px;">
                            <div class="progress-fill" style="width: ${(progressXP / neededXP) * 100}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>${progressXP} XP</span>
                            <span>${neededXP - progressXP} XP restantes</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateHallOfFame() {
            const hallDiv = document.getElementById('hallOfFame');
            
            // Obter top 3 usu√°rios por XP
            const sortedUsers = Object.values(gameData.users)
                .sort((a, b) => (b.xp || 0) - (a.xp || 0))
                .slice(0, 3);

            if (sortedUsers.length === 0) {
                hallDiv.innerHTML = '<p style="text-align: center; color: white;">Nenhum usu√°rio encontrado</p>';
                return;
            }

            hallDiv.innerHTML = sortedUsers.map((user, index) => {
                const position = index + 1;
                const positionClass = position === 1 ? 'first' : position === 2 ? 'second' : 'third';
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â';
                
                return `
                    <div class="podium-place ${positionClass}">
                        <div style="font-size: 40px; margin-bottom: 10px;">${medal}</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${user.name}</div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">${user.role}</div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">${user.xp || 0} XP</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">N√≠vel ${user.level || 1}</div>
                    </div>
                `;
            }).join('');
        }

        function updateActiveMissions() {
            const missionsDiv = document.getElementById('activeMissions');
            
            if (!gameData.missions || gameData.missions.length === 0) {
                gameData.missions = [
                    {
                        id: generateId(),
                        title: 'Meta Mensal de Vendas',
                        description: 'Alcance sua meta de vendas do m√™s',
                        type: 'vendas',
                        target: 15,
                        current: calculateUserStats().matriculas,
                        reward: 500,
                        deadline: getEndOfMonth(),
                        status: 'active'
                    },
                    {
                        id: generateId(),
                        title: 'Conquistador de Leads',
                        description: 'Registre 30 visitas este m√™s',
                        type: 'visitas',
                        target: 30,
                        current: calculateUserStats().visitas,
                        reward: 300,
                        deadline: getEndOfMonth(),
                        status: 'active'
                    }
                ];
                saveGameData();
            }

            missionsDiv.innerHTML = gameData.missions.map(mission => {
                const progress = (mission.current / mission.target) * 100;
                const isCompleted = mission.current >= mission.target;

                return `
                    <div style="border: 2px solid ${isCompleted ? '#38a169' : '#e2e8f0'}; border-radius: 12px; padding: 20px; margin-bottom: 15px; background: ${isCompleted ? 'linear-gradient(135deg, #e6fffa, #f0fff4)' : '#f8f9fa'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: bold; color: var(--text-primary); font-size: 16px;">${mission.title}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="background: #38a169; color: white; padding: 6px 16px; border-radius: 25px; font-size: 12px; font-weight: 600;">${mission.reward} XP</div>
                                ${(currentUser.role === 'admin' || currentUser.role === 'gerente') ? `
                                    <button class="btn btn-warning btn-sm" onclick="editMission('${mission.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteMission('${mission.id}')">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                        <p style="color: #666; margin-bottom: 15px;">${mission.description}</p>
                        <div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                                <span>${mission.current} de ${mission.target}</span>
                                <span>Prazo: ${new Date(mission.deadline).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${isCompleted ? 
                            '<div style="text-align: center; margin-top: 15px; color: #38a169; font-weight: bold;">‚úÖ Miss√£o Completa!</div>' : 
                            '<div style="text-align: center; margin-top: 15px; color: #666; font-size: 12px;">Continue trabalhando para completar esta miss√£o</div>'
                        }
                    </div>
                `;
            }).join('');
        }

        function createMission() {
            const missionData = {
                id: generateId(),
                title: document.getElementById('missionTitle').value,
                description: document.getElementById('missionDescription').value,
                type: document.getElementById('missionType').value,
                target: parseInt(document.getElementById('missionTarget').value),
                reward: parseInt(document.getElementById('missionReward').value),
                deadline: document.getElementById('missionDeadline').value,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString(),
                status: 'active',
                current: 0
            };
            
            if (!missionData.title || !missionData.description || !missionData.target || !missionData.reward || !missionData.deadline) {
                showNotification('Preencha todos os campos da miss√£o', 'warning');
                return;
            }
            
            if (!gameData.missions) gameData.missions = [];
            gameData.missions.push(missionData);
            saveGameData();
            
            showNotification('Miss√£o criada com sucesso!', 'success');
            
            // Limpar formul√°rio
            document.getElementById('missionTitle').value = '';
            document.getElementById('missionDescription').value = '';
            document.getElementById('missionTarget').value = '';
            document.getElementById('missionReward').value = '';
            document.getElementById('missionDeadline').value = '';
            
            updateActiveMissions();
        }

        function editMission(missionId) {
            const mission = gameData.missions.find(m => m.id === missionId);
            if (!mission) return;
            
            const newTitle = prompt('T√≠tulo da miss√£o:', mission.title);
            const newDescription = prompt('Descri√ß√£o:', mission.description);
            const newTarget = prompt('Meta (n√∫mero):', mission.target);
            const newReward = prompt('Recompensa (XP):', mission.reward);
            
            if (newTitle !== null) mission.title = newTitle;
            if (newDescription !== null) mission.description = newDescription;
            if (newTarget !== null) mission.target = parseInt(newTarget);
            if (newReward !== null) mission.reward = parseInt(newReward);
            
            saveGameData();
            showNotification('Miss√£o atualizada!', 'success');
            updateActiveMissions();
        }

        function deleteMission(missionId) {
            if (confirm('Tem certeza que deseja excluir esta miss√£o?')) {
                gameData.missions = gameData.missions.filter(m => m.id !== missionId);
                saveGameData();
                showNotification('Miss√£o exclu√≠da', 'info');
                updateActiveMissions();
            }
        }

        // Sistema de visitas
        function updateVisitasTab() {
            document.getElementById('visitsUnitName').textContent = currentUnit;
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            populateVisitSelects();
            loadVisitsList();
        }

        function populateVisitSelects() {
            const attendantSelect = document.getElementById('visitAttendant');
            const attendantFilter = document.getElementById('visitAttendantFilter');
            
            const unitUsers = Object.values(gameData.users).filter(user => 
                user.unit === currentUnit && ['vendedor', 'gerente', 'assistente'].includes(user.role)
            );

            const options = unitUsers.map(user => 
                `<option value="${user.name}">${user.name} (${user.role})</option>`
            ).join('');

            attendantSelect.innerHTML = '<option value="">Selecione...</option>' + options;
            attendantFilter.innerHTML = '<option value="">Todos</option>' + options;
        }

        function addVisit() {
            const visitData = {
                id: generateId(),
                data: document.getElementById('visitDate').value,
                nome: document.getElementById('visitName').value,
                telefone: document.getElementById('visitPhone').value,
                curso: document.getElementById('visitCourse').value,
                atendente: document.getElementById('visitAttendant').value,
                observacoes: document.getElementById('visitNotes').value,
                unidade: currentUnit,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };

            if (!visitData.data || !visitData.nome || !visitData.telefone || !visitData.curso || !visitData.atendente) {
                showNotification('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            gameData.visitas.push(visitData);
            saveGameData();

            showNotification('Visita registrada com sucesso!', 'success');

            // Limpar formul√°rio
            document.getElementById('visitName').value = '';
            document.getElementById('visitPhone').value = '';
            document.getElementById('visitCourse').value = '';
            document.getElementById('visitAttendant').value = '';
            document.getElementById('visitNotes').value = '';

            loadVisitsList();
            updateDashboard();
        }

        function filterVisits() {
            loadVisitsList();
        }

        function loadVisitsList() {
            const visitsDiv = document.getElementById('visitsList');
            let filteredVisits = [...gameData.visitas].reverse();

            const periodFilter = document.getElementById('visitPeriodFilter')?.value || 'month';
            const attendantFilter = document.getElementById('visitAttendantFilter')?.value || '';
            const statusFilter = document.getElementById('visitStatusFilter')?.value || '';
            const searchBox = document.getElementById('visitSearchBox')?.value || '';

            // Aplicar filtros
            const now = new Date();
            filteredVisits = filteredVisits.filter(visit => {
                const visitDate = new Date(visit.data);
                let dateMatch = true;
                
                switch(periodFilter) {
                    case 'today':
                        dateMatch = visitDate.toDateString() === now.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        dateMatch = visitDate >= weekAgo;
                        break;
                    case 'month':
                        dateMatch = visitDate.getMonth() === now.getMonth() && visitDate.getFullYear() === now.getFullYear();
                        break;
                    default:
                        dateMatch = true;
                }

                const attendantMatch = !attendantFilter || visit.atendente === attendantFilter;
                const statusMatch = !statusFilter || visit.status === statusFilter;
                const searchMatch = !searchBox || 
                    visit.nome.toLowerCase().includes(searchBox.toLowerCase()) ||
                    visit.telefone.includes(searchBox);

                return dateMatch && attendantMatch && statusMatch && searchMatch;
            });

            if (filteredVisits.length === 0) {
                visitsDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma visita encontrada</p>';
                return;
            }

            visitsDiv.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üìÖ Data</th>
                            <th>üë§ Nome</th>
                            <th>üì± Telefone</th>
                            <th>üéì Curso</th>
                            <th>üë®‚Äçüíº Atendente</th>
                            <th>üìä Status</th>
                            <th>üîß A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredVisits.map(visit => `
                            <tr>
                                <td>${new Date(visit.data).toLocaleDateString()}</td>
                                <td>${visit.nome}</td>
                                <td>${visit.telefone}</td>
                                <td>${visit.curso}</td>
                                <td>${visit.atendente}</td>
                                <td>
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; ${visit.status === 'converted' ? 'background: rgba(56, 161, 105, 0.1); color: #38a169;' : 'background: rgba(237, 137, 54, 0.1); color: #ed8936;'}">
                                        ${visit.status === 'converted' ? '‚úÖ Convertido' : '‚è≥ Pendente'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        ${visit.status === 'pending' ? 
                                            `<button class="btn btn-success btn-sm" onclick="convertVisit('${visit.id}')">üéØ Converter</button>` :
                                            ''
                                        }
                                        <button class="btn btn-danger btn-sm" onclick="deleteVisit('${visit.id}')">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function convertVisit(visitId) {
            const visit = gameData.visitas.find(v => v.id === visitId);
            if (!visit) return;
            
            // Pr√©-preencher dados da matr√≠cula com dados da visita
            switchTab('matriculas');
            setTimeout(() => {
                document.getElementById('newNome').value = visit.nome;
                document.getElementById('newTelefone').value = visit.telefone;
                document.getElementById('newCurso').value = visit.curso;
                
                showNotification('Dados da visita preenchidos! Complete as informa√ß√µes da matr√≠cula.', 'info');
            }, 100);
            
            // Marcar visita como convertida
            visit.status = 'converted';
            visit.convertedAt = new Date().toISOString();
            saveGameData();
        }

        function deleteVisit(visitId) {
            if (confirm('Tem certeza que deseja excluir esta visita?')) {
                gameData.visitas = gameData.visitas.filter(v => v.id !== visitId);
                saveGameData();
                showNotification('Visita exclu√≠da', 'info');
                loadVisitsList();
                updateDashboard();
            }
        }

        function exportVisits(format) {
            const data = gameData.visitas;
            if (data.length === 0) {
                showNotification('Nenhuma visita para exportar', 'warning');
                return;
            }
            
            if (format === 'csv') {
                const csvContent = convertToCSV(data, [
                    'data', 'nome', 'telefone', 'curso', 'atendente', 'status', 'unidade', 'observacoes'
                ]);
                downloadFile(csvContent, 'visitas.csv', 'text/csv');
            } else if (format === 'excel') {
                showNotification('Exporta√ß√£o para Excel em desenvolvimento', 'info');
            }
        }

        // Sistema de matr√≠culas
        function updateMatriculasTab() {
            document.getElementById('newData').value = new Date().toISOString().split('T')[0];
            populateMatriculaSelects();
            loadMatriculasList();
        }

        function populateMatriculaSelects() {
            const vendedorSelect = document.getElementById('newVendedor');
            const gerenteSelect = document.getElementById('newGerente');
            const assistenteSelect = document.getElementById('newAssistente');
            const filterVendedor = document.getElementById('matriculaVendedorFilter');

            const unitUsers = Object.values(gameData.users).filter(user => user.unit === currentUnit);
            
            const vendedores = unitUsers.filter(user => user.role === 'vendedor');
            const gerentes = unitUsers.filter(user => user.role === 'gerente');
            const assistentes = unitUsers.filter(user => user.role === 'assistente');

            vendedorSelect.innerHTML = '<option value="">Selecione...</option>' + 
                vendedores.map(user => `<option value="${user.name}">${user.name}</option>`).join('');
            
            gerenteSelect.innerHTML = '<option value="">Selecione...</option>' + 
                gerentes.map(user => `<option value="${user.name}">${user.name}</option>`).join('');
            
            assistenteSelect.innerHTML = '<option value="">Selecione...</option>' + 
                assistentes.map(user => `<option value="${user.name}">${user.name}</option>`).join('');

            if (filterVendedor) {
                filterVendedor.innerHTML = '<option value="">Todos</option>' + 
                    vendedores.map(user => `<option value="${user.name}">${user.name}</option>`).join('');
            }
        }

        function addMatricula() {
            const matriculaData = {
                id: generateId(),
                data: document.getElementById('newData').value,
                nome: document.getElementById('newNome').value,
                telefone: document.getElementById('newTelefone').value,
                curso: document.getElementById('newCurso').value,
                valorTotal: parseFloat(document.getElementById('newValorTotal').value),
                valorEntrada: parseFloat(document.getElementById('newValorEntrada').value),
                tipo: document.getElementById('newTipo').value,
                parcelas: parseInt(document.getElementById('newParcelas').value) || 1,
                hasFirstPayment: document.getElementById('newFirstPayment').value === 'true',
                vendedor: document.getElementById('newVendedor').value,
                gerente: document.getElementById('newGerente').value,
                assistente: document.getElementById('newAssistente').value,
                unidade: currentUnit,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };

            // Valida√ß√µes
            if (!matriculaData.data || !matriculaData.nome || !matriculaData.curso || 
                !matriculaData.valorTotal || !matriculaData.valorEntrada ||
                !matriculaData.vendedor || !matriculaData.gerente || !matriculaData.assistente) {
                showNotification('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            if (matriculaData.valorEntrada > matriculaData.valorTotal) {
                showNotification('Valor de entrada n√£o pode ser maior que o valor total', 'error');
                return;
            }

            // Calcular comiss√µes com sistema oficial
            const comissoes = calculateOfficialMatriculaCommissions(matriculaData);
            matriculaData.comissaoVendedor = comissoes.vendedor;
            matriculaData.comissaoGerente = comissoes.gerente;
            matriculaData.comissaoAssistente = comissoes.assistente;

            // Calcular b√¥nus di√°rio
            const bonusDiario = calculateDailyBonusesForDate(matriculaData.data, matriculaData);
            matriculaData.bonusDiarioVendedor = bonusDiario.vendedor;
            matriculaData.bonusDiarioAssistente = bonusDiario.assistente;

            gameData.matriculas.push(matriculaData);
            
            // Atribuir XP aos envolvidos
            awardXP(matriculaData.vendedor, 50);
            awardXP(matriculaData.gerente, 30);
            awardXP(matriculaData.assistente, 20);
            
            saveGameData();

            showNotification('Matr√≠cula adicionada com sucesso!', 'success');
            
            // Exibir comiss√µes calculadas
            showCommissionBreakdown(comissoes, bonusDiario);

            clearMatriculaForm();
            loadMatriculasList();
            updateDashboard();
        }

        function calculateOfficialMatriculaCommissions(matricula) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const matriculaDate = new Date(matricula.data);
            
            // Contar matr√≠culas do m√™s para cada fun√ß√£o
            const vendedorMatriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       m.vendedor === matricula.vendedor;
            }).length + 1; // +1 para incluir a atual
            
            const gerenteMatriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       m.gerente === matricula.gerente;
            }).length + 1;
            
            const assistenteMatriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       m.assistente === matricula.assistente;
            }).length + 1;

            const vendedorCommission = calculateOfficialCommissions(matricula, 'vendedor', vendedorMatriculas, matricula.hasFirstPayment);
            const gerenteCommission = calculateOfficialCommissions(matricula, 'gerente', gerenteMatriculas, matricula.hasFirstPayment);
            const assistenteCommission = calculateOfficialCommissions(matricula, 'assistente', assistenteMatriculas, matricula.hasFirstPayment);

            // Adicionar comiss√£o por faturamento para gerente
            let gerenteRevenueCommission = 0;
            if (matricula.gerente) {
                const monthlyRevenue = calculateMonthlyRevenue(matricula.unidade);
                gerenteRevenueCommission = calculateRevenueCommission(monthlyRevenue + matricula.valorTotal);
            }

            return {
                vendedor: vendedorCommission,
                gerente: gerenteCommission + gerenteRevenueCommission,
                assistente: assistenteCommission
            };
        }

        function calculateDailyBonusesForDate(dataMatricula, newMatricula) {
            const targetDate = new Date(dataMatricula).toDateString();
            
            // Contar matr√≠culas do dia (incluindo a nova)
            const dailyMatriculas = gameData.matriculas.filter(m => 
                new Date(m.data).toDateString() === targetDate
            );
            
            // Adicionar a nova matr√≠cula √† contagem
            dailyMatriculas.push(newMatricula);

            // Agrupar por vendedor e assistente
            const vendedorCount = {};
            const assistenteCount = {};
            
            dailyMatriculas.forEach(m => {
                vendedorCount[m.vendedor] = (vendedorCount[m.vendedor] || 0) + 1;
                assistenteCount[m.assistente] = (assistenteCount[m.assistente] || 0) + 1;
            });

            return {
                vendedor: calculateOfficialDailyBonus('vendedor', vendedorCount[newMatricula.vendedor] || 0),
                assistente: calculateOfficialDailyBonus('assistente', assistenteCount[newMatricula.assistente] || 0)
            };
        }

        function showCommissionBreakdown(comissoes, bonusDiario) {
            const totalVendedor = comissoes.vendedor + bonusDiario.vendedor;
            const totalGerente = comissoes.gerente;
            const totalAssistente = comissoes.assistente + bonusDiario.assistente;

            const breakdownHtml = `
                <div class="commission-breakdown">
                    <h4 style="margin-bottom: 15px; color: #38a169;">üí∞ Detalhamento das Comiss√µes</h4>
                    
                    <div class="commission-item">
                        <span class="commission-type">üë®‚Äçüíº Vendedor</span>
                        <div>
                            <span class="commission-value">R$ ${totalVendedor.toFixed(2)}</span>
                            ${bonusDiario.vendedor > 0 ? `<br><small style="color: #ed8936;">+ R$ ${bonusDiario.vendedor.toFixed(2)} (b√¥nus di√°rio)</small>` : ''}
                        </div>
                    </div>
                    
                    <div class="commission-item">
                        <span class="commission-type">üëî Gerente</span>
                        <span class="commission-value">R$ ${totalGerente.toFixed(2)}</span>
                    </div>
                    
                    <div class="commission-item">
                        <span class="commission-type">üë©‚Äçüíª Assistente</span>
                        <div>
                            <span class="commission-value">R$ ${totalAssistente.toFixed(2)}</span>
                            ${bonusDiario.assistente > 0 ? `<br><small style="color: #ed8936;">+ R$ ${bonusDiario.assistente.toFixed(2)} (b√¥nus di√°rio)</small>` : ''}
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #38a169; margin-top: 15px; padding-top: 15px;">
                        <div class="commission-item">
                            <span class="commission-type" style="font-size: 18px;">üíµ TOTAL GERAL</span>
                            <span class="commission-value" style="font-size: 20px;">R$ ${(totalVendedor + totalGerente + totalAssistente).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar modal com breakdown
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üìä Comiss√µes Calculadas</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    ${breakdownHtml}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="this.closest('.modal').remove()">‚úÖ Entendi</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function awardXP(userName, xpAmount) {
            const userEntry = Object.entries(gameData.users).find(([key, user]) => user.name === userName);
            if (userEntry) {
                const [username, user] = userEntry;
                user.xp = (user.xp || 0) + xpAmount;
                
                // Calcular novo n√≠vel
                const newLevel = Math.floor(user.xp / 1000) + 1;
                if (newLevel > user.level) {
                    user.level = newLevel;
                    showNotification(`${userName} subiu para o n√≠vel ${newLevel}! üéâ`, 'success');
                }
            }
        }

        function clearMatriculaForm() {
            document.getElementById('newNome').value = '';
            document.getElementById('newTelefone').value = '';
            document.getElementById('newCurso').value = '';
            document.getElementById('newValorTotal').value = '';
            document.getElementById('newValorEntrada').value = '';
            document.getElementById('newTipo').value = '';
            document.getElementById('newParcelas').value = '';
            document.getElementById('newFirstPayment').value = 'true';
            document.getElementById('newVendedor').value = '';
            document.getElementById('newGerente').value = '';
            document.getElementById('newAssistente').value = '';
        }

        function filterMatriculas() {
            loadMatriculasList();
        }

        function loadMatriculasList() {
            const listDiv = document.getElementById('matriculasList');
            let filteredMatriculas = [...gameData.matriculas].reverse();

            const periodFilter = document.getElementById('matriculaPeriodFilter')?.value || 'month';
            const vendedorFilter = document.getElementById('matriculaVendedorFilter')?.value || '';
            const cursoFilter = document.getElementById('matriculaCursoFilter')?.value || '';
            const searchBox = document.getElementById('matriculaSearchBox')?.value || '';

            // Aplicar filtros
            const now = new Date();
            filteredMatriculas = filteredMatriculas.filter(matricula => {
                const matriculaDate = new Date(matricula.data);
                let dateMatch = true;
                
                switch(periodFilter) {
                    case 'today':
                        dateMatch = matriculaDate.toDateString() === now.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        dateMatch = matriculaDate >= weekAgo;
                        break;
                    case 'month':
                        dateMatch = matriculaDate.getMonth() === now.getMonth() && matriculaDate.getFullYear() === now.getFullYear();
                        break;
                    default:
                        dateMatch = true;
                }

                const vendedorMatch = !vendedorFilter || matricula.vendedor === vendedorFilter;
                const cursoMatch = !cursoFilter || matricula.curso === cursoFilter;
                const searchMatch = !searchBox || 
                    matricula.nome.toLowerCase().includes(searchBox.toLowerCase());

                return dateMatch && vendedorMatch && cursoMatch && searchMatch;
            });

            if (filteredMatriculas.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma matr√≠cula encontrada</p>';
                return;
            }

            listDiv.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üìÖ Data</th>
                            <th>üë§ Aluno</th>
                            <th>üì± Telefone</th>
                            <th>üéì Curso</th>
                            <th>üí∞ Valor</th>
                            <th>üë®‚Äçüíº Vendedor</th>
                            <th>üìä Tipo</th>
                            <th>üí≥ 1¬™ Parcela</th>
                            <th>üîß A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredMatriculas.map(matricula => `
                            <tr>
                                <td>${new Date(matricula.data).toLocaleDateString()}</td>
                                <td>${matricula.nome}</td>
                                <td>${matricula.telefone}</td>
                                <td>${matricula.curso}</td>
                                <td>R$ ${matricula.valorTotal?.toFixed(2) || '0.00'}</td>
                                <td>${matricula.vendedor}</td>
                                <td>
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; ${matricula.tipo === 'Black' ? 'background: rgba(229, 62, 62, 0.1); color: #e53e3e;' : 
                                        matricula.tipo === 'Blackin' ? 'background: rgba(237, 137, 54, 0.1); color: #ed8936;' : 'background: rgba(56, 161, 105, 0.1); color: #38a169;'}">
                                        ${matricula.tipo}
                                    </span>
                                </td>
                                <td>
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; ${matricula.hasFirstPayment ? 'background: rgba(56, 161, 105, 0.1); color: #38a169;' : 'background: rgba(237, 137, 54, 0.1); color: #ed8936;'}">
                                        ${matricula.hasFirstPayment ? '‚úÖ Sim' : '‚ö†Ô∏è N√£o'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-info btn-sm" onclick="viewMatricula('${matricula.id}')">üëÅÔ∏è Ver</button>
                                        ${hasPermission(PERMISSIONS.MATRICULAS_EDIT) ? 
                                            `<button class="btn btn-warning btn-sm" onclick="editMatricula('${matricula.id}')">‚úèÔ∏è Editar</button>` : ''
                                        }
                                        ${hasPermission(PERMISSIONS.COMISSOES_EDIT) ? 
                                            `<button class="btn btn-primary btn-sm" onclick="editComissoes('${matricula.id}')">üí∞ Comiss√µes</button>` : ''
                                        }
                                        ${hasPermission(PERMISSIONS.MATRICULAS_DELETE) ? 
                                            `<button class="btn btn-danger btn-sm" onclick="deleteMatricula('${matricula.id}')">üóëÔ∏è</button>` : ''
                                        }
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function viewMatricula(matriculaId) {
            const matricula = gameData.matriculas.find(m => m.id === matriculaId);
            if (!matricula) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üëÅÔ∏è Detalhes da Matr√≠cula</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div style="line-height: 1.6;">
                        <p><strong>üìÖ Data:</strong> ${new Date(matricula.data).toLocaleDateString()}</p>
                        <p><strong>üë§ Aluno:</strong> ${matricula.nome}</p>
                        <p><strong>üì± Telefone:</strong> ${matricula.telefone}</p>
                        <p><strong>üéì Curso:</strong> ${matricula.curso}</p>
                        <p><strong>üí∞ Valor Total:</strong> R$ ${matricula.valorTotal?.toFixed(2)}</p>
                        <p><strong>üí≥ Entrada:</strong> R$ ${matricula.valorEntrada?.toFixed(2)}</p>
                        <p><strong>üìä Tipo:</strong> ${matricula.tipo}</p>
                        <p><strong>üìù Parcelas:</strong> ${matricula.parcelas || 1}x</p>
                        <p><strong>üí≥ Com 1¬™ Parcela:</strong> ${matricula.hasFirstPayment ? 'Sim' : 'N√£o'}</p>
                        <p><strong>üë®‚Äçüíº Vendedor:</strong> ${matricula.vendedor}</p>
                        <p><strong>üëî Gerente:</strong> ${matricula.gerente}</p>
                        <p><strong>üë©‚Äçüíª Assistente:</strong> ${matricula.assistente}</p>
                        <p><strong>üè¢ Unidade:</strong> ${matricula.unidade}</p>
                        <hr style="margin: 15px 0;">
                        <h4 style="color: #38a169; margin-bottom: 10px;">üí∞ Comiss√µes Calculadas</h4>
                        <p><strong>üí∞ Comiss√£o Vendedor:</strong> R$ ${(matricula.comissaoVendedor || 0).toFixed(2)}</p>
                        <p><strong>üí∞ Comiss√£o Gerente:</strong> R$ ${(matricula.comissaoGerente || 0).toFixed(2)}</p>
                        <p><strong>üí∞ Comiss√£o Assistente:</strong> R$ ${(matricula.comissaoAssistente || 0).toFixed(2)}</p>
                        ${(matricula.bonusDiarioVendedor || 0) > 0 ? `<p><strong>üéÅ B√¥nus Di√°rio Vendedor:</strong> R$ ${matricula.bonusDiarioVendedor.toFixed(2)}</p>` : ''}
                        ${(matricula.bonusDiarioAssistente || 0) > 0 ? `<p><strong>üéÅ B√¥nus Di√°rio Assistente:</strong> R$ ${matricula.bonusDiarioAssistente.toFixed(2)}</p>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function editMatricula(matriculaId) {
            showNotification('Funcionalidade de edi√ß√£o em desenvolvimento', 'info');
        }

        function deleteMatricula(matriculaId) {
            if (confirm('Tem certeza que deseja excluir esta matr√≠cula?')) {
                gameData.matriculas = gameData.matriculas.filter(m => m.id !== matriculaId);
                saveGameData();
                showNotification('Matr√≠cula exclu√≠da', 'info');
                loadMatriculasList();
                updateDashboard();
            }
        }

        // SISTEMA DE EDI√á√ÉO DE COMISS√ïES (APENAS ADMIN)
        function editComissoes(matriculaId) {
            if (!hasPermission(PERMISSIONS.COMISSOES_EDIT)) {
                showNotification('Voc√™ n√£o tem permiss√£o para editar comiss√µes', 'error');
                return;
            }
            
            const matricula = gameData.matriculas.find(m => m.id === matriculaId);
            if (!matricula) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>üí∞ Editar Comiss√µes - ${matricula.nome}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>üìÖ Data:</strong> ${new Date(matricula.data).toLocaleDateString()}</p>
                        <p><strong>üí∞ Valor Total:</strong> R$ ${matricula.valorTotal?.toFixed(2)}</p>
                        <p><strong>üìä Tipo:</strong> ${matricula.tipo}</p>
                    </div>

                    <div class="commission-breakdown">
                        <h4 style="margin-bottom: 15px; color: #38a169;">üí∞ Editar Valores das Comiss√µes</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label>üë®‚Äçüíº Comiss√£o Vendedor (R$):</label>
                                <input type="number" id="editComissaoVendedor" step="0.01" value="${matricula.comissaoVendedor || 0}">
                            </div>
                            <div class="form-group">
                                <label>üëî Comiss√£o Gerente (R$):</label>
                                <input type="number" id="editComissaoGerente" step="0.01" value="${matricula.comissaoGerente || 0}">
                            </div>
                            <div class="form-group">
                                <label>üë©‚Äçüíª Comiss√£o Assistente (R$):</label>
                                <input type="number" id="editComissaoAssistente" step="0.01" value="${matricula.comissaoAssistente || 0}">
                            </div>
                            <div class="form-group">
                                <label>üéÅ B√¥nus Di√°rio Vendedor (R$):</label>
                                <input type="number" id="editBonusVendedor" step="0.01" value="${matricula.bonusDiarioVendedor || 0}">
                            </div>
                            <div class="form-group">
                                <label>üéÅ B√¥nus Di√°rio Assistente (R$):</label>
                                <input type="number" id="editBonusAssistente" step="0.01" value="${matricula.bonusDiarioAssistente || 0}">
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="recalcularComissoes" checked>
                                <span>üîÑ Recalcular automaticamente baseado nas regras oficiais</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                        <button class="btn btn-success" onclick="saveComissoes('${matricula.id}')">üíæ Salvar Altera√ß√µes</button>
                        <button class="btn btn-warning" onclick="recalcularComissoesMatricula('${matricula.id}')">üîÑ Recalcular</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">‚ùå Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveComissoes(matriculaId) {
            const matricula = gameData.matriculas.find(m => m.id === matriculaId);
            if (!matricula) return;
            
            const shouldRecalculate = document.getElementById('recalcularComissoes').checked;
            
            if (shouldRecalculate) {
                // Recalcular automaticamente
                recalcularComissoesMatricula(matriculaId);
            } else {
                // Usar valores manuais
                matricula.comissaoVendedor = parseFloat(document.getElementById('editComissaoVendedor').value) || 0;
                matricula.comissaoGerente = parseFloat(document.getElementById('editComissaoGerente').value) || 0;
                matricula.comissaoAssistente = parseFloat(document.getElementById('editComissaoAssistente').value) || 0;
                matricula.bonusDiarioVendedor = parseFloat(document.getElementById('editBonusVendedor').value) || 0;
                matricula.bonusDiarioAssistente = parseFloat(document.getElementById('editBonusAssistente').value) || 0;
                
                matricula.comissoesEditedManually = true;
                matricula.lastCommissionEdit = {
                    date: new Date().toISOString(),
                    editedBy: currentUser.name
                };
                
                saveGameData();
                showNotification('Comiss√µes salvas com sucesso!', 'success');
            }
            
            document.querySelector('.modal').remove();
            loadMatriculasList();
            updateDashboard();
        }

        function recalcularComissoesMatricula(matriculaId) {
            const matricula = gameData.matriculas.find(m => m.id === matriculaId);
            if (!matricula) return;
            
            // Recalcular comiss√µes usando as regras oficiais
            const novasComissoes = calculateOfficialMatriculaCommissions(matricula);
            const novosBonusDiarios = calculateDailyBonusesForDate(matricula.data, matricula);
            
            matricula.comissaoVendedor = novasComissoes.vendedor;
            matricula.comissaoGerente = novasComissoes.gerente;
            matricula.comissaoAssistente = novasComissoes.assistente;
            matricula.bonusDiarioVendedor = novosBonusDiarios.vendedor;
            matricula.bonusDiarioAssistente = novosBonusDiarios.assistente;
            
            matricula.comissoesEditedManually = false;
            matricula.lastCommissionRecalc = {
                date: new Date().toISOString(),
                recalcedBy: currentUser.name
            };
            
            saveGameData();
            showNotification('Comiss√µes recalculadas automaticamente!', 'success');
            
            // Atualizar campos do modal se estiver aberto
            if (document.getElementById('editComissaoVendedor')) {
                document.getElementById('editComissaoVendedor').value = novasComissoes.vendedor;
                document.getElementById('editComissaoGerente').value = novasComissoes.gerente;
                document.getElementById('editComissaoAssistente').value = novasComissoes.assistente;
                document.getElementById('editBonusVendedor').value = novosBonusDiarios.vendedor;
                document.getElementById('editBonusAssistente').value = novosBonusDiarios.assistente;
            }
        }

        // SISTEMA DE ABAS PERSONALIZADAS (ADMIN)
        function editCustomTab(tabId) {
            const customTab = gameData.customTabs.find(tab => tab.id === tabId);
            if (!customTab) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Aba Personalizada</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>üìõ Nome da Aba:</label>
                            <input type="text" id="editTabName" value="${customTab.name}" required>
                        </div>
                        <div class="form-group">
                            <label>üì± √çcone:</label>
                            <input type="text" id="editTabIcon" value="${customTab.icon}" placeholder="Ex: üìä, üéØ, üíº" required>
                        </div>
                        <div class="form-group">
                            <label>üìù Descri√ß√£o:</label>
                            <textarea id="editTabDescription" rows="2" placeholder="Breve descri√ß√£o da aba...">${customTab.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>üîê Permiss√£o Necess√°ria:</label>
                            <select id="editTabPermission">
                                <option value="">Todos podem ver</option>
                                ${Object.entries(PERMISSIONS).map(([key, perm]) => 
                                    `<option value="${perm}" ${customTab.permission === perm ? 'selected' : ''}>${key}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>üìã Conte√∫do da Aba (HTML):</label>
                        <textarea id="editTabContent" rows="8" style="font-family: monospace; font-size: 12px;" placeholder="Digite o HTML que ser√° exibido na aba...">${customTab.content || ''}</textarea>
                        <small style="color: #666;">üí° Voc√™ pode usar HTML b√°sico: &lt;h3&gt;, &lt;p&gt;, &lt;div&gt;, &lt;button&gt;, etc.</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                        <button class="btn btn-success" onclick="saveCustomTab('${tabId}')">üíæ Salvar Aba</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">‚ùå Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deleteCustomTab(tabId) {
            if (!hasPermission(PERMISSIONS.ADMIN_TABS)) {
                showNotification('Voc√™ n√£o tem permiss√£o para excluir abas', 'error');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir esta aba personalizada?')) {
                gameData.customTabs = gameData.customTabs.filter(tab => tab.id !== tabId);
                saveGameData();
                showNotification('Aba personalizada exclu√≠da', 'info');
                
                // Voltar ao dashboard
                switchTab('dashboard');
                createNavigation(); // Recriar navega√ß√£o
            }
        }

        function saveCustomTab(tabId) {
            const tabIndex = gameData.customTabs.findIndex(tab => tab.id === tabId);
            if (tabIndex === -1) return;
            
            const tabData = {
                ...gameData.customTabs[tabIndex],
                name: document.getElementById('editTabName').value,
                icon: document.getElementById('editTabIcon').value,
                description: document.getElementById('editTabDescription').value,
                permission: document.getElementById('editTabPermission').value || null,
                content: document.getElementById('editTabContent').value,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser.name
            };
            
            if (!tabData.name || !tabData.icon) {
                showNotification('Nome e √≠cone s√£o obrigat√≥rios', 'warning');
                return;
            }
            
            gameData.customTabs[tabIndex] = tabData;
            saveGameData();
            
            showNotification('Aba atualizada com sucesso!', 'success');
            document.querySelector('.modal').remove();
            
            // Recriar navega√ß√£o e mostrar aba atualizada
            createNavigation();
            switchTab(tabId);
        }

        function exportMatriculas(format) {
            const data = gameData.matriculas;
            if (data.length === 0) {
                showNotification('Nenhuma matr√≠cula para exportar', 'warning');
                return;
            }
            
            if (format === 'csv') {
                const csvContent = convertToCSV(data, [
                    'data', 'nome', 'telefone', 'curso', 'valorTotal', 'valorEntrada', 'tipo', 'vendedor', 'gerente', 'assistente', 'unidade'
                ]);
                downloadFile(csvContent, 'matriculas.csv', 'text/csv');
            } else if (format === 'excel') {
                showNotification('Exporta√ß√£o para Excel em desenvolvimento', 'info');
            }
        }

        // Sistema de equipe
        function updateEquipeTab() {
            if (currentUser.role !== 'gerente' && currentUser.role !== 'admin') return;
            
            document.getElementById('teamUnitName').textContent = currentUnit;
            loadTeamGrid();
            updateUnitGoals();
        }

        function loadTeamGrid() {
            const teamGrid = document.getElementById('teamGrid');
            const teamMembers = Object.values(gameData.users).filter(user => 
                user.unit === currentUnit && user.username !== currentUser.username
            );
            
            if (teamMembers.length === 0) {
                teamGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum membro da equipe encontrado</p>';
                return;
            }

            teamGrid.innerHTML = teamMembers.map(member => {
                const stats = calculateUserStatsForUser(member);
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow-sm); text-align: center; transition: var(--transition);">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: white; margin: 0 auto 15px;">${member.name.charAt(0).toUpperCase()}</div>
                        <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 8px; font-size: 16px;">${member.name}</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(102, 126, 234, 0.1); color: #667eea;">${member.role}</span>
                        </div>
                        <div style="font-size: 12px; color: #38a169; font-weight: 600;">
                            üìä ${stats.matriculas} matr√≠culas<br>
                            üë• ${stats.visitas} visitas<br>
                            ‚≠ê ${member.xp || 0} XP<br>
                            üìà ${(stats.conversao * 100).toFixed(1)}% convers√£o<br>
                            üí∞ R$ ${stats.comissao.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateUnitGoals() {
            const goalsDiv = document.getElementById('unitGoals');
            const unitGoal = gameData.unitGoals[currentUnit] || { matriculas: 50, faturamento: 80000 };
            
            // Calcular progresso atual
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const unitMatriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       m.unidade === currentUnit;
            });
            
            const currentMatriculas = unitMatriculas.length;
            const currentFaturamento = unitMatriculas.reduce((sum, m) => sum + (m.valorTotal || 0), 0);
            
            const matriculasProgress = (currentMatriculas / unitGoal.matriculas) * 100;
            const faturamentoProgress = (currentFaturamento / unitGoal.faturamento) * 100;
            
            // Verificar se atingiu ambas as metas para b√¥nus
            const bothGoalsAchieved = currentMatriculas >= unitGoal.matriculas && currentFaturamento >= unitGoal.faturamento;
            
            goalsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #e6fffa, #f0fff4); border-left: 4px solid #38a169;">
                        <h4 style="margin-bottom: 15px;">üìä Meta de Matr√≠culas</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #38a169; margin-bottom: 10px;">${currentMatriculas} / ${unitGoal.matriculas}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(matriculasProgress, 100)}%;"></div>
                        </div>
                        <div class="progress-text">${matriculasProgress.toFixed(1)}% da meta</div>
                    </div>
                    
                    <div style="padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #ebf8ff, #f7fafc); border-left: 4px solid #3182ce;">
                        <h4 style="margin-bottom: 15px;">üí∞ Meta de Faturamento</h4>
                        <div style="font-size: 20px; font-weight: bold; color: #3182ce; margin-bottom: 10px;">R$ ${currentFaturamento.toLocaleString()} / R$ ${unitGoal.faturamento.toLocaleString()}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(faturamentoProgress, 100)}%; background: var(--info-gradient);"></div>
                        </div>
                        <div class="progress-text">${faturamentoProgress.toFixed(1)}% da meta</div>
                    </div>
                </div>
                
                ${bothGoalsAchieved ? `
                    <div style="margin-top: 20px; padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #fff5f5, #fed7d7); border-left: 4px solid #e53e3e; text-align: center;">
                        <h4 style="color: #e53e3e; margin-bottom: 10px;">üéâ PARAB√âNS! B√îNUS DESBLOQUEADO!</h4>
                        <p style="font-size: 18px; font-weight: bold; color: #e53e3e;">Unidade ganhou b√¥nus de R$ 1.000,00 por atingir ambas as metas!</p>
                    </div>
                ` : ''}
            `;
        }

        function calculateUserStatsForUser(user) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const matriculas = gameData.matriculas.filter(m => {
                const date = new Date(m.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       (m.vendedor === user.name || m.gerente === user.name || m.assistente === user.name);
            });

            const visitas = gameData.visitas.filter(v => {
                const date = new Date(v.data);
                return date.getMonth() === currentMonth && 
                       date.getFullYear() === currentYear &&
                       v.atendente === user.name;
            });

            const comissao = matriculas.reduce((sum, m) => {
                let userCommission = 0;
                if (m.vendedor === user.name) userCommission += (m.comissaoVendedor || 0) + (m.bonusDiarioVendedor || 0);
                if (m.gerente === user.name) userCommission += m.comissaoGerente || 0;
                if (m.assistente === user.name) userCommission += (m.comissaoAssistente || 0) + (m.bonusDiarioAssistente || 0);
                return sum + userCommission;
            }, 0);

            const conversao = visitas.length > 0 ? matriculas.length / visitas.length : 0;

            return {
                matriculas: matriculas.length,
                visitas: visitas.length,
                conversao: conversao,
                comissao: comissao
            };
        }

        function sendTeamMessage() {
            const message = document.getElementById('teamMessage').value.trim();
            
            if (!message) {
                showNotification('Digite uma mensagem', 'warning');
                return;
            }
            
            // Adicionar √† lista de mensagens do sistema
            if (!gameData.teamMessages) gameData.teamMessages = [];
            gameData.teamMessages.push({
                id: generateId(),
                from: currentUser.name,
                message: message,
                timestamp: new Date().toISOString(),
                unit: currentUnit
            });
            
            saveGameData();
            showNotification(`Mensagem enviada para a equipe: "${message}"`, 'success');
            document.getElementById('teamMessage').value = '';
        }

        function scheduleTeamMeeting() {
            const meetingDate = prompt('Data da reuni√£o (dd/mm/aaaa):');
            const meetingTime = prompt('Hor√°rio da reuni√£o (HH:MM):');
            
            if (meetingDate && meetingTime) {
                showNotification(`Reuni√£o agendada para ${meetingDate} √†s ${meetingTime}`, 'success');
                
                // Adicionar evento ao sistema
                if (!gameData.events) gameData.events = [];
                gameData.events.push({
                    id: generateId(),
                    title: 'Reuni√£o de Equipe',
                    date: meetingDate,
                    time: meetingTime,
                    type: 'reuniao',
                    description: `Reuni√£o agendada por ${currentUser.name}`,
                    createdBy: currentUser.name,
                    unit: currentUnit
                });
                
                saveGameData();
            }
        }

        // Sistema de ranking
        function updateRankingTab() {
            const rankingDiv = document.getElementById('rankingTable');
            
            let users = Object.values(gameData.users);
            
            // Calcular estat√≠sticas para cada usu√°rio
            users = users.map(user => {
                const userStats = calculateUserStatsForUser(user);
                return {
                    ...user,
                    stats: userStats
                };
            });

            // Ordenar por matr√≠culas
            users.sort((a, b) => b.stats.matriculas - a.stats.matriculas);

            rankingDiv.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üèÜ Posi√ß√£o</th>
                            <th>üë§ Nome</th>
                            <th>üè¢ Unidade</th>
                            <th>üíº Cargo</th>
                            <th>üë• Visitas</th>
                            <th>üìä Matr√≠culas</th>
                            <th>üìà Convers√£o</th>
                            <th>üí∞ Comiss√£o</th>
                            <th>‚≠ê XP</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user, index) => {
                            const position = index + 1;
                            const medalStyle = position === 1 ? 'background: linear-gradient(135deg, #ffd700, #ffed4e); color: #2d3748;' : 
                                             position === 2 ? 'background: linear-gradient(135deg, #c0c0c0, #e2e8f0); color: #2d3748;' : 
                                             position === 3 ? 'background: linear-gradient(135deg, #cd7f32, #dd6b20); color: white;' : 
                                             'background: linear-gradient(135deg, #4a5568, #2d3748); color: white;';

                            return `
                                <tr>
                                    <td>
                                        <div style="${medalStyle} border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto;">${position}</div>
                                    </td>
                                    <td>${user.name}</td>
                                    <td>${user.unit}</td>
                                    <td>
                                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(102, 126, 234, 0.1); color: #667eea;">${user.role}</span>
                                    </td>
                                    <td>${user.stats.visitas}</td>
                                    <td>${user.stats.matriculas}</td>
                                    <td>${(user.stats.conversao * 100).toFixed(1)}%</td>
                                    <td>R$ ${user.stats.comissao.toFixed(2)}</td>
                                    <td>
                                        <span style="background: var(--primary-gradient); color: white; padding: 6px 16px; border-radius: 25px; font-size: 12px; font-weight: 600;">${user.xp || 0} XP</span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Sistema de relat√≥rios
        function updateRelatoriosTab() {
            // Tab j√° tem os bot√µes, s√≥ precisa das fun√ß√µes
        }

        function gerarRelatorioComissoes() {
            showLoadingOverlay('Gerando relat√≥rio de comiss√µes...');
            
            setTimeout(() => {
                const users = Object.values(gameData.users);
                let totalCommissions = 0;
                
                const userCommissions = users.map(user => {
                    const stats = calculateUserStatsForUser(user);
                    totalCommissions += stats.comissao;
                    
                    return {
                        nome: user.name,
                        role: user.role,
                        unidade: user.unit,
                        comissao: stats.comissao,
                        matriculas: stats.matriculas
                    };
                }).sort((a, b) => b.comissao - a.comissao);
                
                const relatorio = `
                    <div class="stat-card">
                        <h3>üí∞ Relat√≥rio de Comiss√µes - ${new Date().toLocaleDateString()}</h3>
                        <p><strong>Total de Comiss√µes:</strong> R$ ${totalCommissions.toFixed(2)}</p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Cargo</th>
                                    <th>Unidade</th>
                                    <th>Matr√≠culas</th>
                                    <th>Comiss√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userCommissions.map(user => `
                                    <tr>
                                        <td>${user.nome}</td>
                                        <td>${user.role}</td>
                                        <td>${user.unidade}</td>
                                        <td>${user.matriculas}</td>
                                        <td>R$ ${user.comissao.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('Relat√≥rio de comiss√µes gerado!', 'success');
            }, 1500);
        }

        function gerarRelatorioConversao() {
            showLoadingOverlay('Gerando relat√≥rio de convers√£o...');
            
            setTimeout(() => {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthVisitas = gameData.visitas.filter(v => {
                    const date = new Date(v.data);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });
                
                const monthMatriculas = gameData.matriculas.filter(m => {
                    const date = new Date(m.data);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });
                
                const conversionRate = monthVisitas.length > 0 ? (monthMatriculas.length / monthVisitas.length) * 100 : 0;
                
                const relatorio = `
                    <div class="stat-card">
                        <h3>üìà Relat√≥rio de Convers√£o - ${new Date().toLocaleDateString()}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                            <div style="text-align: center; padding: 20px; background: var(--bg-primary); border-radius: 12px;">
                                <div style="font-size: 24px; font-weight: bold; color: #3182ce;">${monthVisitas.length}</div>
                                <div>Total de Visitas</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--bg-primary); border-radius: 12px;">
                                <div style="font-size: 24px; font-weight: bold; color: #38a169;">${monthMatriculas.length}</div>
                                <div>Total de Matr√≠culas</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--bg-primary); border-radius: 12px;">
                                <div style="font-size: 24px; font-weight: bold; color: #ed8936;">${conversionRate.toFixed(1)}%</div>
                                <div>Taxa de Convers√£o</div>
                            </div>
                        </div>
                        <p>Taxa de convers√£o ${conversionRate >= 25 ? 'excelente' : conversionRate >= 15 ? 'boa' : 'precisa melhorar'} para este per√≠odo.</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('Relat√≥rio de convers√£o gerado!', 'success');
            }, 1500);
        }

        function gerarRelatorioUnidade() {
            showLoadingOverlay('Gerando relat√≥rio por unidade...');
            
            setTimeout(() => {
                const unitStats = {};
                
                gameData.units.forEach(unit => {
                    const unitUsers = Object.values(gameData.users).filter(user => user.unit === unit);
                    const unitMatriculas = gameData.matriculas.filter(m => 
                        unitUsers.some(user => user.name === m.vendedor || user.name === m.gerente || user.name === m.assistente)
                    );
                    const unitVisitas = gameData.visitas.filter(v => 
                        unitUsers.some(user => user.name === v.atendente)
                    );
                    
                    const unitGoal = gameData.unitGoals[unit] || { matriculas: 50, faturamento: 80000 };
                    const currentFaturamento = unitMatriculas.reduce((sum, m) => sum + (m.valorTotal || 0), 0);
                    
                    unitStats[unit] = {
                        usuarios: unitUsers.length,
                        matriculas: unitMatriculas.length,
                        visitas: unitVisitas.length,
                        conversao: unitVisitas.length > 0 ? (unitMatriculas.length / unitVisitas.length) * 100 : 0,
                        receita: currentFaturamento,
                        metaMatriculas: unitGoal.matriculas,
                        metaFaturamento: unitGoal.faturamento,
                        progressoMatriculas: (unitMatriculas.length / unitGoal.matriculas) * 100,
                        progressoFaturamento: (currentFaturamento / unitGoal.faturamento) * 100
                    };
                });
                
                const relatorio = `
                    <div class="stat-card">
                        <h3>üè¢ Relat√≥rio por Unidade - ${new Date().toLocaleDateString()}</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Unidade</th>
                                    <th>Usu√°rios</th>
                                    <th>Visitas</th>
                                    <th>Matr√≠culas</th>
                                    <th>Meta Mat.</th>
                                    <th>Progresso Mat.</th>
                                    <th>Receita</th>
                                    <th>Meta Fat.</th>
                                    <th>Progresso Fat.</th>
                                    <th>Convers√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(unitStats).map(([unit, stats]) => `
                                    <tr>
                                        <td>${unit}</td>
                                        <td>${stats.usuarios}</td>
                                        <td>${stats.visitas}</td>
                                        <td>${stats.matriculas}</td>
                                        <td>${stats.metaMatriculas}</td>
                                        <td>
                                            <span style="color: ${stats.progressoMatriculas >= 100 ? '#38a169' : stats.progressoMatriculas >= 75 ? '#ed8936' : '#e53e3e'}; font-weight: bold;">
                                                ${stats.progressoMatriculas.toFixed(1)}%
                                            </span>
                                        </td>
                                        <td>R$ ${stats.receita.toLocaleString()}</td>
                                        <td>R$ ${stats.metaFaturamento.toLocaleString()}</td>
                                        <td>
                                            <span style="color: ${stats.progressoFaturamento >= 100 ? '#38a169' : stats.progressoFaturamento >= 75 ? '#ed8936' : '#e53e3e'}; font-weight: bold;">
                                                ${stats.progressoFaturamento.toFixed(1)}%
                                            </span>
                                        </td>
                                        <td>${stats.conversao.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('Relat√≥rio por unidade gerado!', 'success');
            }, 1500);
        }

        function gerarRelatorioMetas() {
            showLoadingOverlay('Gerando relat√≥rio de metas...');
            
            setTimeout(() => {
                const relatorio = `
                    <div class="stat-card">
                        <h3>üéØ Relat√≥rio de Metas vs Realizado - ${new Date().toLocaleDateString()}</h3>
                        <p>Relat√≥rio de metas em desenvolvimento. Em breve!</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('Relat√≥rio de metas gerado!', 'success');
            }, 1500);
        }

        function gerarRelatorioTendencias() {
            showLoadingOverlay('Gerando an√°lise de tend√™ncias...');
            
            setTimeout(() => {
                const relatorio = `
                    <div class="stat-card">
                        <h3>üìà An√°lise de Tend√™ncias - ${new Date().toLocaleDateString()}</h3>
                        <p>An√°lise de tend√™ncias em desenvolvimento. Em breve!</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('An√°lise de tend√™ncias gerada!', 'success');
            }, 1500);
        }

        function gerarRelatorioPrevisao() {
            showLoadingOverlay('Gerando previs√£o de vendas...');
            
            setTimeout(() => {
                const relatorio = `
                    <div class="stat-card">
                        <h3>üîÆ Previs√£o de Vendas - ${new Date().toLocaleDateString()}</h3>
                        <p>Previs√£o de vendas em desenvolvimento. Em breve!</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('relatorioResultado').innerHTML = relatorio;
                hideLoadingOverlay();
                showNotification('Previs√£o de vendas gerada!', 'success');
            }, 1500);
        }

        // Sistema de chat
        function updateChatTab() {
            loadChatMessages();
        }

        function loadChatMessages() {
            const messagesDiv = document.getElementById('chatMessages');
            
            if (!gameData.chatMessages || gameData.chatMessages.length === 0) {
                messagesDiv.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma mensagem ainda. Seja o primeiro a conversar!</p>';
                return;
            }
            
            messagesDiv.innerHTML = gameData.chatMessages.map(message => `
                <div style="margin-bottom: 15px; padding: 10px; background: ${message.user === currentUser.name ? '#e6fffa' : '#f8f9fa'}; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #38a169;">${message.user}</strong>
                        <small style="color: #666;">${new Date(message.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <div>${message.message}</div>
                </div>
            `).join('');
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendChatMessage() {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const chatMessage = {
                id: generateId(),
                user: currentUser.name,
                message: message,
                timestamp: new Date().toISOString(),
                unit: currentUnit
            };
            
            gameData.chatMessages.push(chatMessage);
            
            // Manter apenas as √∫ltimas 50 mensagens
            if (gameData.chatMessages.length > 50) {
                gameData.chatMessages = gameData.chatMessages.slice(-50);
            }
            
            saveGameData();
            messageInput.value = '';
            loadChatMessages();
            showNotification('Mensagem enviada!', 'success');
        }

        // Sistema administrativo
        function updateAdminTab() {
            loadUnitsList();
            loadUserManagementTable();
            populateNewUserUnit();
            populateGoalUnits();
            loadCurrentGoals();
            loadExistingCustomTabs();
        }
        
        // FUN√á√ïES DO SISTEMA DE PERMISS√ïES
        function updatePermissionsByRole() {
            const role = document.getElementById('newUserRole').value;
            const customPermissions = document.getElementById('customPermissions');
            
            if (role === 'custom') {
                customPermissions.style.display = 'block';
                clearAllPermissions();
            } else {
                customPermissions.style.display = 'none';
            }
        }
        
        function selectAllPermissions() {
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`perm_${permission}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        function clearAllPermissions() {
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`perm_${permission}`);
                if (checkbox) checkbox.checked = false;
            });
        }
        
        function applyRolePermissions() {
            const role = document.getElementById('newUserRole').value;
            if (role === 'custom') return;
            
            clearAllPermissions();
            const rolePermissions = DEFAULT_PERMISSIONS[role] || [];
            
            rolePermissions.forEach(permission => {
                const checkbox = document.getElementById(`perm_${permission}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        function getSelectedPermissions() {
            const selectedPermissions = [];
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`perm_${permission}`);
                if (checkbox && checkbox.checked) {
                    selectedPermissions.push(permission);
                }
            });
            return selectedPermissions;
        }

        // FUN√á√ïES DO CRIADOR DE ABAS PERSONALIZADAS
        function createCustomTab() {
            if (!hasPermission(PERMISSIONS.ADMIN_TABS)) {
                showNotification('Voc√™ n√£o tem permiss√£o para criar abas', 'error');
                return;
            }
            
            const tabData = {
                id: `custom_${generateId()}`,
                name: document.getElementById('customTabName').value.trim(),
                icon: document.getElementById('customTabIcon').value.trim(),
                description: document.getElementById('customTabDescription').value.trim(),
                permission: document.getElementById('customTabPermission').value || null,
                content: document.getElementById('customTabContent').value.trim(),
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            if (!tabData.name || !tabData.icon) {
                showNotification('Nome e √≠cone s√£o obrigat√≥rios', 'warning');
                return;
            }
            
            if (!gameData.customTabs) gameData.customTabs = [];
            
            // Verificar se j√° existe aba com mesmo nome
            if (gameData.customTabs.some(tab => tab.name === tabData.name)) {
                showNotification('J√° existe uma aba com esse nome', 'error');
                return;
            }
            
            gameData.customTabs.push(tabData);
            saveGameData();
            
            showNotification('Aba personalizada criada com sucesso!', 'success');
            
            // Limpar formul√°rio
            document.getElementById('customTabName').value = '';
            document.getElementById('customTabIcon').value = '';
            document.getElementById('customTabDescription').value = '';
            document.getElementById('customTabPermission').value = '';
            document.getElementById('customTabContent').value = '';
            
            // Recarregar listas
            loadExistingCustomTabs();
            createNavigation();
        }
        
        function loadExistingCustomTabs() {
            const container = document.getElementById('existingCustomTabs');
            if (!container) return;
            
            if (!gameData.customTabs || gameData.customTabs.length === 0) {
                container.innerHTML = '<p style="color: #666;">Nenhuma aba personalizada criada ainda.</p>';
                return;
            }
            
            container.innerHTML = gameData.customTabs.map(tab => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 10px 0; background: white;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${tab.icon} ${tab.name}
                            ${tab.permission ? `<span style="background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 10px;">${tab.permission}</span>` : ''}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${tab.description || 'Sem descri√ß√£o'}
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Criada em ${new Date(tab.createdAt).toLocaleDateString()} por ${tab.createdBy}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary btn-sm" onclick="switchTab('${tab.id}')">üëÅÔ∏è Ver</button>
                        <button class="btn btn-warning btn-sm" onclick="editCustomTab('${tab.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomTab('${tab.id}')">üóëÔ∏è Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        function populateGoalUnits() {
            const goalUnitSelect = document.getElementById('goalUnit');
            if (goalUnitSelect) {
                goalUnitSelect.innerHTML = gameData.units.map(unit => 
                    `<option value="${unit}">${unit}</option>`
                ).join('');
            }
        }

        function setUnitGoals() {
            const unit = document.getElementById('goalUnit').value;
            const matriculas = parseInt(document.getElementById('goalMatriculas').value);
            const faturamento = parseFloat(document.getElementById('goalFaturamento').value);
            
            if (!unit || !matriculas || !faturamento) {
                showNotification('Preencha todos os campos das metas', 'warning');
                return;
            }
            
            if (!gameData.unitGoals) gameData.unitGoals = {};
            gameData.unitGoals[unit] = {
                matriculas: matriculas,
                faturamento: faturamento
            };
            
            saveGameData();
            showNotification(`Metas definidas para ${unit}!`, 'success');
            
            // Limpar formul√°rio
            document.getElementById('goalMatriculas').value = '';
            document.getElementById('goalFaturamento').value = '';
            
            loadCurrentGoals();
        }

        function loadCurrentGoals() {
            const goalsListDiv = document.getElementById('goalsList');
            
            if (!gameData.unitGoals || Object.keys(gameData.unitGoals).length === 0) {
                goalsListDiv.innerHTML = '<p style="color: #666;">Nenhuma meta definida</p>';
                return;
            }
            
            goalsListDiv.innerHTML = Object.entries(gameData.unitGoals).map(([unit, goals]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 10px 0; background: white;">
                    <div>
                        <strong>${unit}</strong><br>
                        <small>üìä ${goals.matriculas} matr√≠culas | üí∞ R$ ${goals.faturamento.toLocaleString()}</small>
                    </div>
                    <button class="btn btn-warning btn-sm" onclick="editUnitGoal('${unit}')">‚úèÔ∏è Editar</button>
                </div>
            `).join('');
        }

        function editUnitGoal(unit) {
            const currentGoal = gameData.unitGoals[unit];
            const newMatriculas = prompt('Nova meta de matr√≠culas:', currentGoal.matriculas);
            const newFaturamento = prompt('Nova meta de faturamento:', currentGoal.faturamento);
            
            if (newMatriculas !== null && newFaturamento !== null) {
                gameData.unitGoals[unit] = {
                    matriculas: parseInt(newMatriculas),
                    faturamento: parseFloat(newFaturamento)
                };
                saveGameData();
                showNotification(`Metas de ${unit} atualizadas!`, 'success');
                loadCurrentGoals();
            }
        }

        function loadUnitsList() {
            const unitsDiv = document.getElementById('unitsList');
            
            unitsDiv.innerHTML = gameData.units.map(unit => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 5px 0;">
                    <span style="font-weight: 600;">${unit}</span>
                    <button class="btn btn-danger btn-sm" onclick="removeUnit('${unit}')">üóëÔ∏è Remover</button>
                </div>
            `).join('');
        }

        function addNewUnit() {
            const unitName = document.getElementById('newUnitName').value.trim();
            
            if (!unitName) {
                showNotification('Digite o nome da unidade', 'warning');
                return;
            }
            
            if (gameData.units.includes(unitName)) {
                showNotification('Esta unidade j√° existe', 'error');
                return;
            }
            
            gameData.units.push(unitName);
            
            // Definir metas padr√£o para nova unidade
            if (!gameData.unitGoals) gameData.unitGoals = {};
            gameData.unitGoals[unitName] = {
                matriculas: 50,
                faturamento: 80000
            };
            
            saveGameData();
            
            showNotification(`Unidade "${unitName}" adicionada com sucesso!`, 'success');
            document.getElementById('newUnitName').value = '';
            loadUnitsList();
            populateNewUserUnit();
            populateGoalUnits();
            loadCurrentGoals();
        }

        function removeUnit(unitName) {
            if (confirm(`Tem certeza que deseja remover a unidade "${unitName}"?`)) {
                gameData.units = gameData.units.filter(unit => unit !== unitName);
                
                // Remover metas da unidade
                if (gameData.unitGoals && gameData.unitGoals[unitName]) {
                    delete gameData.unitGoals[unitName];
                }
                
                saveGameData();
                showNotification(`Unidade "${unitName}" removida`, 'info');
                loadUnitsList();
                populateNewUserUnit();
                populateGoalUnits();
                loadCurrentGoals();
            }
        }

        function populateNewUserUnit() {
            const newUserUnitSelect = document.getElementById('newUserUnit');
            if (newUserUnitSelect) {
                newUserUnitSelect.innerHTML = gameData.units.map(unit => 
                    `<option value="${unit}">${unit}</option>`
                ).join('');
            }
        }

        function addUser() {
            const role = document.getElementById('newUserRole').value;
            let permissions;
            
            if (role === 'custom') {
                permissions = getSelectedPermissions();
                if (permissions.length === 0) {
                    showNotification('Selecione pelo menos uma permiss√£o para usu√°rio personalizado', 'warning');
                    return;
                }
            } else {
                permissions = DEFAULT_PERMISSIONS[role] || [];
            }
            
            const userData = {
                name: document.getElementById('newUserName').value.trim(),
                username: document.getElementById('newUserUsername').value.trim(),
                password: document.getElementById('newUserPassword').value.trim(),
                role: role === 'custom' ? 'personalizado' : role,
                unit: document.getElementById('newUserUnit').value,
                permissions: permissions,
                xp: 0,
                level: 1,
                id: generateId(),
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            if (!userData.name || !userData.username || !userData.password || !userData.unit) {
                showNotification('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }
            
            if (gameData.users[userData.username]) {
                showNotification('Este usu√°rio j√° existe', 'error');
                return;
            }
            
            gameData.users[userData.username] = userData;
            saveGameData();
            
            showNotification(`Usu√°rio ${userData.name} criado com sucesso!`, 'success');
            
            // Limpar formul√°rio
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserRole').value = 'vendedor';
            document.getElementById('customPermissions').style.display = 'none';
            clearAllPermissions();
            
            loadUserManagementTable();
        }

        function loadUserManagementTable() {
            const tableDiv = document.getElementById('userManagementTable');
            const users = Object.values(gameData.users);
            
            tableDiv.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>üë§ Nome</th>
                            <th>üîë Usu√°rio</th>
                            <th>üè¢ Unidade</th>
                            <th>üíº Tipo</th>
                            <th>üîê Permiss√µes</th>
                            <th>‚≠ê XP</th>
                            <th>üîß A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const permissionCount = user.permissions ? user.permissions.length : 0;
                            const isCustomPermissions = user.role === 'personalizado';
                            
                            return `
                                <tr>
                                    <td>${user.name}</td>
                                    <td style="font-size: 12px;">${user.username}</td>
                                    <td>${user.unit}</td>
                                    <td>
                                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                            ${user.role}
                                            ${isCustomPermissions ? ' üéõÔ∏è' : ''}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <span style="background: ${permissionCount > 10 ? '#38a169' : permissionCount > 5 ? '#ed8936' : '#e53e3e'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                ${permissionCount} perm.
                                            </span>
                                            <button class="btn btn-info" style="padding: 4px 8px; font-size: 11px;" onclick="viewUserPermissions('${user.username}')">üëÅÔ∏è Ver</button>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="background: var(--primary-gradient); color: white; padding: 6px 16px; border-radius: 25px; font-size: 12px; font-weight: 600;">${user.xp || 0} XP</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            ${user.username !== currentUser.username ? `
                                                <button class="btn btn-warning btn-sm" onclick="editUserPermissions('${user.username}')">üîê Permiss√µes</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">üóëÔ∏è Remover</button>
                                            ` : '<span style="color: #666; font-size: 12px;">Pr√≥prio usu√°rio</span>'}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function viewUserPermissions(username) {
            const user = gameData.users[username];
            if (!user) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>üîê Permiss√µes - ${user.name}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>üë§ Usu√°rio:</strong> ${user.username}</p>
                        <p><strong>üè¢ Unidade:</strong> ${user.unit}</p>
                        <p><strong>üíº Cargo:</strong> ${user.role}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #38a169;">
                        <h4 style="margin-bottom: 15px;">‚úÖ Permiss√µes Ativas (${user.permissions ? user.permissions.length : 0})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            ${user.permissions && user.permissions.length > 0 ? 
                                user.permissions.map(perm => {
                                    const permName = Object.keys(PERMISSIONS).find(key => PERMISSIONS[key] === perm) || perm;
                                    return `
                                        <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #38a169; font-size: 14px;">
                                            ‚úÖ ${permName.replace(/_/g, ' ')}
                                        </div>
                                    `;
                                }).join('') : 
                                '<p style="color: #666;">Nenhuma permiss√£o definida</p>'
                            }
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-warning" onclick="this.closest('.modal').remove(); editUserPermissions('${username}')">‚úèÔ∏è Editar Permiss√µes</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">‚ùå Fechar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function editUserPermissions(username) {
            const user = gameData.users[username];
            if (!user) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Permiss√µes - ${user.name}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <div>
                                <h5 style="color: #38a169; margin-bottom: 10px;">üìä Funcionalidades B√°sicas</h5>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_dashboard" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.DASHBOARD) ? 'checked' : ''}>
                                    üìä Dashboard
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_gamificacao" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.GAMIFICACAO) ? 'checked' : ''}>
                                    üéÆ Gamifica√ß√£o
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_ranking" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.RANKING) ? 'checked' : ''}>
                                    üèÜ Ranking
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_chat" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.CHAT) ? 'checked' : ''}>
                                    üí¨ Chat
                                </label>
                            </div>
                            
                            <div>
                                <h5 style="color: #3182ce; margin-bottom: 10px;">üë• Gest√£o de Visita√ß√£o</h5>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_visitas" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.VISITAS) ? 'checked' : ''}>
                                    üë• Ver Visitas
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_visitas_edit" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.VISITAS_EDIT) ? 'checked' : ''}>
                                    ‚úèÔ∏è Editar Visitas
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_visitas_delete" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.VISITAS_DELETE) ? 'checked' : ''}>
                                    üóëÔ∏è Excluir Visitas
                                </label>
                            </div>
                            
                            <div>
                                <h5 style="color: #ed8936; margin-bottom: 10px;">üìö Gest√£o de Matr√≠culas</h5>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_matriculas" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.MATRICULAS) ? 'checked' : ''}>
                                    üìö Ver Matr√≠culas
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_matriculas_edit" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.MATRICULAS_EDIT) ? 'checked' : ''}>
                                    ‚úèÔ∏è Editar Matr√≠culas
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_matriculas_delete" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.MATRICULAS_DELETE) ? 'checked' : ''}>
                                    üóëÔ∏è Excluir Matr√≠culas
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_comissoes_edit" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.COMISSOES_EDIT) ? 'checked' : ''}>
                                    üí∞ Editar Comiss√µes
                                </label>
                            </div>
                            
                            <div>
                                <h5 style="color: #e53e3e; margin-bottom: 10px;">üëî Fun√ß√µes Gerenciais</h5>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_equipe" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.EQUIPE) ? 'checked' : ''}>
                                    üë• Gest√£o de Equipe
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_relatorios" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.RELATORIOS) ? 'checked' : ''}>
                                    üìä Relat√≥rios
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_admin" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.ADMIN) ? 'checked' : ''}>
                                    ‚öôÔ∏è Painel Admin
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <input type="checkbox" id="edit_perm_admin_tabs" style="margin-right: 10px;" ${user.permissions?.includes(PERMISSIONS.ADMIN_TABS) ? 'checked' : ''}>
                                    üìã Gerenciar Abas
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-info btn-sm" onclick="selectAllEditPermissions()">‚úÖ Selecionar Todas</button>
                            <button class="btn btn-warning btn-sm" onclick="clearAllEditPermissions()">‚ùå Limpar Todas</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-success" onclick="saveUserPermissions('${username}')">üíæ Salvar Permiss√µes</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">‚ùå Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function selectAllEditPermissions() {
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`edit_perm_${permission}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        function clearAllEditPermissions() {
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`edit_perm_${permission}`);
                if (checkbox) checkbox.checked = false;
            });
        }
        
        function saveUserPermissions(username) {
            const user = gameData.users[username];
            if (!user) return;
            
            const selectedPermissions = [];
            Object.values(PERMISSIONS).forEach(permission => {
                const checkbox = document.getElementById(`edit_perm_${permission}`);
                if (checkbox && checkbox.checked) {
                    selectedPermissions.push(permission);
                }
            });
            
            user.permissions = selectedPermissions;
            user.role = 'personalizado'; // Marcar como personalizado se foi editado
            user.lastPermissionUpdate = {
                date: new Date().toISOString(),
                updatedBy: currentUser.name
            };
            
            saveGameData();
            showNotification(`Permiss√µes de ${user.name} atualizadas com sucesso!`, 'success');
            
            document.querySelector('.modal').remove();
            loadUserManagementTable();
            
            // Se for o pr√≥prio usu√°rio, atualizar a navega√ß√£o
            if (username === currentUser.username) {
                currentUser.permissions = selectedPermissions;
                createNavigation();
            }
        }

        function deleteUser(username) {
            const user = gameData.users[username];
            if (!user) return;
            
            if (username === currentUser.username) {
                showNotification('Voc√™ n√£o pode remover sua pr√≥pria conta', 'error');
                return;
            }
            
            if (confirm(`Tem certeza que deseja remover o usu√°rio "${user.name}"?`)) {
                delete gameData.users[username];
                saveGameData();
                
                showNotification(`Usu√°rio ${user.name} removido`, 'info');
                loadUserManagementTable();
            }
        }

        // Google Sheets Integration
        function connectBySpreadsheetId() {
            const spreadsheetId = document.getElementById('googleSheetId').value.trim();
            const apiKey = document.getElementById('googleApiKeyId').value.trim();
            
            if (!spreadsheetId || !apiKey) {
                showNotification('Preencha o ID da planilha e a API Key', 'warning');
                return;
            }

            showLoadingOverlay('Conectando com Google Sheets...');
            document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #ed8936;">üü° Conectando...</span>';
            document.getElementById('googleConnectionDetails').innerHTML = 'Verificando planilha e configura√ß√µes...';

            // Construir URL da Web App (ser√° fornecida ap√≥s deploy)
            const webAppUrl = prompt('Cole a URL da Web App aqui (obtenha ap√≥s fazer deploy no Apps Script):');
            
            if (!webAppUrl) {
                hideLoadingOverlay();
                showNotification('URL da Web App √© necess√°ria', 'warning');
                return;
            }

            // Fazer requisi√ß√£o para conectar por ID
            const requestData = {
                action: 'connect_by_id',
                spreadsheetId: spreadsheetId,
                apiKey: apiKey
            };

            fetch(webAppUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingOverlay();
                
                if (data.success) {
                    googleSheetsConfig.connected = true;
                    googleSheetsConfig.spreadsheetId = spreadsheetId;
                    googleSheetsConfig.apiKey = apiKey;
                    googleSheetsConfig.webAppUrl = webAppUrl;
                    googleSheetsConfig.spreadsheetUrl = data.spreadsheetUrl;
                    googleSheetsConfig.spreadsheetName = data.spreadsheetName;
                    googleSheetsConfig.connectionMethod = 'id';
                    
                    document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #38a169;">‚úÖ Conectado com sucesso!</span>';
                    document.getElementById('googleConnectionDetails').innerHTML = `
                        <strong>üìä Planilha:</strong> ${data.spreadsheetName}<br>
                        <strong>üÜî ID:</strong> ${spreadsheetId}<br>
                        <strong>üìã Abas:</strong> ${data.sheets.join(', ')}<br>
                        <strong>‚öôÔ∏è Configurada:</strong> ${data.isConfigured ? '‚úÖ Sim' : '‚ö†Ô∏è Parcial'}
                    `;
                    
                    if (!data.isConfigured && data.missingSheets.length > 0) {
                        showNotification(`Planilha conectada, mas faltam abas: ${data.missingSheets.join(', ')}`, 'warning');
                    } else {
                        showNotification('Conex√£o estabelecida com sucesso! Planilha totalmente configurada.', 'success');
                    }
                    
                    saveGoogleSheetsConfig();
                } else {
                    document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #e53e3e;">‚ùå Erro na conex√£o</span>';
                    document.getElementById('googleConnectionDetails').innerHTML = `Erro: ${data.error}`;
                    showNotification(`Erro: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideLoadingOverlay();
                document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #e53e3e;">‚ùå Erro de rede</span>';
                document.getElementById('googleConnectionDetails').innerHTML = `Erro de conex√£o: ${error.message}`;
                showNotification('Erro de rede. Verifique a URL da Web App.', 'error');
                console.error('Erro na conex√£o:', error);
            });
        }

        function testGoogleConnection() {
            const apiKey = document.getElementById('googleApiKey').value;
            const url = document.getElementById('googleSheetUrl').value;
            
            if (!apiKey || !url) {
                showNotification('Preencha a URL da planilha e a API Key primeiro', 'warning');
                return;
            }

            showLoadingOverlay('Testando conex√£o com Google Sheets...');
            document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #ed8936;">üü° Testando conex√£o...</span>';

            // Simular teste de conex√£o (substituir por chamada real √† Web App)
            setTimeout(() => {
                const success = Math.random() > 0.3; // 70% chance de sucesso para demo
                
                hideLoadingOverlay();
                
                if (success) {
                    googleSheetsConfig.connected = true;
                    googleSheetsConfig.url = url;
                    googleSheetsConfig.apiKey = apiKey;
                    googleSheetsConfig.tabName = document.getElementById('googleSheetTab').value;
                    googleSheetsConfig.connectionMethod = 'manual';
                    
                    document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #38a169;">üü¢ Conectado com sucesso!</span>';
                    document.getElementById('googleConnectionDetails').innerHTML = 'Conex√£o manual estabelecida via URL';
                    showNotification('Conex√£o com Google Sheets estabelecida!', 'success');
                    
                    saveGoogleSheetsConfig();
                } else {
                    document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #e53e3e;">üî¥ Erro na conex√£o</span>';
                    document.getElementById('googleConnectionDetails').innerHTML = 'Verifique a API Key e permiss√µes';
                    showNotification('Erro ao conectar. Verifique a API Key e permiss√µes', 'error');
                }
            }, 2000);
        }

        function exportToGoogleSheets() {
            if (!googleSheetsConfig.connected) {
                showNotification('Configure e teste a conex√£o primeiro', 'warning');
                return;
            }

            showLoadingOverlay('Exportando dados para Google Sheets...');
            
            const exportData = {
                action: 'export',
                apiKey: googleSheetsConfig.apiKey,
                matriculas: gameData.matriculas,
                visitas: gameData.visitas,
                users: gameData.users
            };

            // Se conectado por ID, usar Web App URL
            if (googleSheetsConfig.webAppUrl) {
                fetch(googleSheetsConfig.webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    
                    if (data.success) {
                        googleSheetsConfig.lastSync = new Date().toISOString();
                        document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                        showNotification(`${data.recordsExported} registros exportados com sucesso!`, 'success');
                        saveGoogleSheetsConfig();
                    } else {
                        showNotification(`Erro na exporta√ß√£o: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    hideLoadingOverlay();
                    showNotification('Erro de rede na exporta√ß√£o', 'error');
                    console.error('Erro na exporta√ß√£o:', error);
                });
            } else {
                // Simula√ß√£o para conex√£o manual
                setTimeout(() => {
                    const exportCount = gameData.matriculas.length + gameData.visitas.length;
                    
                    googleSheetsConfig.lastSync = new Date().toISOString();
                    document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                    
                    hideLoadingOverlay();
                    showNotification(`${exportCount} registros exportados com sucesso!`, 'success');
                    saveGoogleSheetsConfig();
                }, 3000);
            }
        }

        function importFromGoogleSheets() {
            if (!googleSheetsConfig.connected) {
                showNotification('Configure e teste a conex√£o primeiro', 'warning');
                return;
            }

            showLoadingOverlay('Importando dados do Google Sheets...');
            
            const requestData = {
                action: 'import',
                apiKey: googleSheetsConfig.apiKey
            };

            // Se conectado por ID, usar Web App URL
            if (googleSheetsConfig.webAppUrl) {
                fetch(googleSheetsConfig.webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    
                    if (data.success) {
                        // Mesclar dados importados
                        if (data.data.matriculas) {
                            gameData.matriculas = [...gameData.matriculas, ...data.data.matriculas];
                        }
                        if (data.data.visitas) {
                            gameData.visitas = [...gameData.visitas, ...data.data.visitas];
                        }
                        
                        saveGameData();
                        
                        googleSheetsConfig.lastSync = new Date().toISOString();
                        document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                        
                        showNotification(`${data.recordsImported} registros importados com sucesso!`, 'success');
                        updateDashboard();
                        saveGoogleSheetsConfig();
                    } else {
                        showNotification(`Erro na importa√ß√£o: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    hideLoadingOverlay();
                    showNotification('Erro de rede na importa√ß√£o', 'error');
                    console.error('Erro na importa√ß√£o:', error);
                });
            } else {
                // Simula√ß√£o para conex√£o manual
                setTimeout(() => {
                    const importCount = Math.floor(Math.random() * 10) + 5;
                    
                    googleSheetsConfig.lastSync = new Date().toISOString();
                    document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                    
                    hideLoadingOverlay();
                    showNotification(`${importCount} registros importados com sucesso!`, 'success');
                    updateDashboard();
                    saveGoogleSheetsConfig();
                }, 3000);
            }
        }

        function syncWithGoogleSheets() {
            if (!googleSheetsConfig.connected) {
                showNotification('Configure e teste a conex√£o primeiro', 'warning');
                return;
            }

            showLoadingOverlay('Sincronizando dados...');
            
            const syncData = {
                action: 'sync',
                apiKey: googleSheetsConfig.apiKey,
                matriculas: gameData.matriculas,
                visitas: gameData.visitas,
                users: gameData.users
            };

            // Se conectado por ID, usar Web App URL
            if (googleSheetsConfig.webAppUrl) {
                fetch(googleSheetsConfig.webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(syncData)
                })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    
                    if (data.success) {
                        googleSheetsConfig.lastSync = new Date().toISOString();
                        document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                        showNotification('Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                        saveGoogleSheetsConfig();
                    } else {
                        showNotification(`Erro na sincroniza√ß√£o: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    hideLoadingOverlay();
                    showNotification('Erro de rede na sincroniza√ß√£o', 'error');
                    console.error('Erro na sincroniza√ß√£o:', error);
                });
            } else {
                // Simula√ß√£o para conex√£o manual
                setTimeout(() => {
                    googleSheetsConfig.lastSync = new Date().toISOString();
                    document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date().toLocaleString()}`;
                    
                    hideLoadingOverlay();
                    showNotification('Sincroniza√ß√£o conclu√≠da!', 'success');
                    saveGoogleSheetsConfig();
                }, 4000);
            }
        }

        function saveGoogleSheetsConfig() {
            localStorage.setItem('googleSheetsConfig', JSON.stringify(googleSheetsConfig));
        }

        function loadGoogleSheetsConfig() {
            const saved = localStorage.getItem('googleSheetsConfig');
            if (saved) {
                googleSheetsConfig = { ...googleSheetsConfig, ...JSON.parse(saved) };
                
                // Preencher campos da conex√£o manual
                if (document.getElementById('googleSheetUrl')) {
                    document.getElementById('googleSheetUrl').value = googleSheetsConfig.url || '';
                }
                if (document.getElementById('googleApiKey')) {
                    document.getElementById('googleApiKey').value = googleSheetsConfig.apiKey || '';
                }
                if (document.getElementById('googleSheetTab')) {
                    document.getElementById('googleSheetTab').value = googleSheetsConfig.tabName || 'Matriculas';
                }
                
                // Preencher campos da conex√£o por ID
                if (document.getElementById('googleSheetId')) {
                    document.getElementById('googleSheetId').value = googleSheetsConfig.spreadsheetId || '';
                }
                if (document.getElementById('googleApiKeyId')) {
                    document.getElementById('googleApiKeyId').value = googleSheetsConfig.apiKey || '';
                }
                
                // Atualizar status da conex√£o
                if (googleSheetsConfig.connected) {
                    document.getElementById('googleConnectionStatus').innerHTML = '<span style="color: #38a169;">üü¢ Conectado</span>';
                    
                    let details = 'Conex√£o ativa';
                    if (googleSheetsConfig.spreadsheetName) {
                        details = `üìä ${googleSheetsConfig.spreadsheetName}`;
                        if (googleSheetsConfig.connectionMethod === 'id') {
                            details += `<br>üÜî Conectado por ID`;
                        }
                    }
                    
                    if (document.getElementById('googleConnectionDetails')) {
                        document.getElementById('googleConnectionDetails').innerHTML = details;
                    }
                }
                
                // Atualizar √∫ltima sincroniza√ß√£o
                if (googleSheetsConfig.lastSync && document.getElementById('googleLastSync')) {
                    document.getElementById('googleLastSync').textContent = `√öltima sincroniza√ß√£o: ${new Date(googleSheetsConfig.lastSync).toLocaleString()}`;
                }
            }
        }

        // Fun√ß√µes auxiliares
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getEndOfMonth() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showLoadingOverlay(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function convertToCSV(data, columns) {
            const header = columns.join(',');
            const rows = data.map(item => 
                columns.map(col => {
                    const value = item[col] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',')
            );
            return [header, ...rows].join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Arquivo ${filename} baixado com sucesso!`, 'success');
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            const themeButton = document.querySelector('.theme-toggle');
            themeButton.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
        }

        function toggleNotificationPanel() {
            showNotification('Painel de notifica√ß√µes em desenvolvimento', 'info');
        }

        function loadAllData() {
            // Carregar configura√ß√µes salvas
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.body.setAttribute('data-theme', currentTheme);
                
                const themeButton = document.querySelector('.theme-toggle');
                if (themeButton) {
                    themeButton.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
                }
            }
            
            loadGoogleSheetsConfig();
        }

        function setupEventListeners() {
            // Enter para login
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Enter para chat
            document.getElementById('chatMessage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // Escape para fechar modais
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }

        // Inicializa√ß√£o ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            
            // Configurar permiss√µes nos campos se est√£o presentes
            if (document.getElementById('newUserRole')) {
                // Adicionar os eventos de permiss√µes
                Object.values(PERMISSIONS).forEach(permission => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `perm_${permission}`;
                    checkbox.style.display = 'none'; // Ser√° mostrado quando necess√°rio
                });
            }
        });
    </script>
</body>
</html>
